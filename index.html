<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<base target="_top">
<title>EL-ECOMMERCE DCANP GROUP</title>
<script>
/**
 * Shim para emular google.script.run en Vercel
 * Convierte: google.script.run.withSuccessHandler(fn).withFailureHandler(err).miFuncion(a,b)
 * en: fetch("/api/gas", {fn:"miFuncion", args:[a,b]})
 */
(function initGoogleScriptRunShim(){
  // Si estamos dentro de Apps Script, google.script.run ya existe: no tocamos nada.
  if (window.google && window.google.script && window.google.script.run) return;

  window.google = window.google || {};
  window.google.script = window.google.script || {};

  function makeRunner() {
    let onSuccess = null;
    let onFailure = null;

    const runner = {
      // IMPORTANTE: devolver el PROXY para que el encadenado no se rompa
      withSuccessHandler(cb){ onSuccess = cb; return proxy; },
      withFailureHandler(cb){ onFailure = cb; return proxy; },
    };

    const proxy = new Proxy(runner, {
      get(target, prop) {
        if (prop in target) return target[prop];

        return async (...args) => {
          try {
            const r = await fetch("/api/gas", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ fn: String(prop), args })
            });

            const data = await r.json();

            if (!data.ok) {
              const err = new Error(data.error || "Error en backend");
              if (onFailure) onFailure(err);
              else console.error(err);
              return;
            }

            if (onSuccess) onSuccess(data.result);
            return data.result;

          } catch (err) {
            if (onFailure) onFailure(err);
            else console.error(err);
          }
        };
      }
    });

    return proxy;
  }

  window.google.script.run = makeRunner();
})();</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<style>
  :root{
    --brand:#7c5cff; --bg:#0b0b10; --card:#141420; --text:#e9ebff; --muted:#9aa0b5;
    --ok:#21c08b; --err:#ff5c7c;
  }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:Inter,system-ui,Segoe UI,Arial; background:var(--bg); color:var(--text); }

  /* === Ancho completo (quitamos m√°rgenes laterales oscuros) === */
  .wrap{ max-width:100%; margin:0 auto; padding:20px 24px; }

  .header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
  .brand{ font-size:22px; font-weight:800; letter-spacing:.5px; display:flex; gap:12px; align-items:center; }
  /* Logo un toque m√°s grande y redondeado */
  .brand img{ width:40px; height:40px; border-radius:10px; object-fit:cover; }

  .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
 
  /* === PANELES (CARDS) MEJORADOS === */
  .card {
    background: var(--card);
    border: 1px solid #2a2a40;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--brand), #9d8aff);
    opacity: 0.7;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
    border-color: #3a3a55;
  }
 
  nav .btn{ border:0; background:#1d1d2a; color:#fff; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; }
  nav .btn.primary{ background:var(--brand) }
 
  /* === MEJORAS EN INPUTS === */
  input,select,textarea{
    width:100%;
    padding:10px 14px;
    border-radius:10px;
    border:1px solid #353552;
    background:#0e0e16;
    color:#fff;
    outline:none;
    transition: all 0.2s ease;
  }
 
  input:focus, select:focus, textarea:focus {
    border-color: var(--brand);
    box-shadow: 0 0 0 2px rgba(124, 92, 255, 0.2);
  }
 
  label{ font-size:12px; color:var(--muted); margin-top:8px; display:block; }
 
  /* === MEJORAS EN TABLAS === */
  table{
    width:100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size:14px;
  }
 
  th,td{
    padding:12px;
    border-bottom:1px solid #2a2a3a;
    text-align:left;
  }
 
  th {
    background: rgba(30, 30, 45, 0.6);
    font-weight: 700;
    color: #c8d0ff;
  }

  tr:hover td {
    background: rgba(40, 40, 60, 0.3);
  }
 
  .right{ text-align:right } .hidden{ display:none }
 
  /* === KPI MEJORADOS === */
  .kpi {
    background: linear-gradient(145deg, #151528, #1a1a2e);
    border: 1px solid #2a2a40;
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  .kpi::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--brand), #9d8aff);
    opacity: 0.7;
  }

  .kpi:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    border-color: #3a3a55;
  }
 
  .kpi-title{font-size:12px;color:#aab; margin-bottom: 6px;}
  .kpi-value{font-weight:800;font-size:22px; color: var(--text);}
 
  .grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  @media (max-width:1000px){ .grid-5{grid-template-columns:repeat(2,1fr);} }
  .thumb{ width:64px; height:64px; object-fit:cover; border-radius:8px; border:1px solid #2c2f4a; }
 
  /* === CHIPS Y BADGES MEJORADOS === */
  .chip {
    background: linear-gradient(135deg, #252538, #2d2d45);
    color: #d0e1ff;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    border: 1px solid #353552;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
 
  .badge{
    padding:4px 10px;
    border-radius:8px;
    font-size:11px;
    background: linear-gradient(135deg, #252538, #2d2d45);
    color: #d0e1ff;
    font-weight: 600;
    border: 1px solid #353552;
  }
 
  .ok{color:var(--ok)} .err{color:var(--err)}
 
  /* === MEJORAS EN MODALES === */
  .modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.6);
    display:none;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
 
  .modal .box{
    background:#0f1120;
    border:1px solid #2a2a40;
    border-radius:16px;
    padding:20px;
    width:min(900px,95vw);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
  }
 
  /* === BOTONES MEJORADOS === */
  .btn {
    border: 0;
    background: linear-gradient(135deg, var(--brand), #6a4dff);
    color: #fff;
    border-radius: 10px;
    padding: 10px 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(124, 92, 255, 0.3);
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }

  .btn:hover::before {
    left: 100%;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 92, 255, 0.4);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn.primary {
    background: linear-gradient(135deg, var(--brand), #6a4dff);
    box-shadow: 0 2px 8px rgba(124, 92, 255, 0.4);
  }

  .btn.small{
    padding:6px 12px;
    border-radius:8px;
    font-size:12px;
  }

  .btn.refreshBtn {
    background: #252538;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  .btn.refreshBtn:hover {
    background: #2d2d45;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
  }

  /* Tabla pedidos: m√°s legible y ancha */
  #tblOrders { min-width: 1400px; }
  #tblOrders th, #tblOrders td { white-space: nowrap; font-size: 13px; }
  #tblOrders select { min-width: 120px; padding: 4px 6px; border-radius: 6px; background:#1d1d2a; color:#fff; }

  /* Charts estables */
  #chartBars, #chartPie, #chartGuideGen, #chartGuidePend { max-height: 260px; }

  /* Refresco */
  .refreshBox small{ color:var(--muted); }

  /* ===================================================== */
  /* === NUEVO: Cards de PRODUCTOS + Toolbar + Modal ==== */
  /* ===================================================== */
  .prod-toolbar{ display:flex; gap:10px; align-items:center; margin:8px 0 14px; flex-wrap:wrap; }
  .prod-toolbar .search{ min-width:260px; flex:1; }
  .prod-toolbar .tog{ background:#1d1d2a; color:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; border:1px solid #2b2d45; }

  .prod-grid{
    display:grid; grid-template-columns:repeat(6,1fr); gap:12px;
  }
  @media (max-width:1500px){ .prod-grid{ grid-template-columns:repeat(5,1fr); } }
  @media (max-width:1200px){ .prod-grid{ grid-template-columns:repeat(4,1fr); } }
  @media (max-width:900px){  .prod-grid{ grid-template-columns:repeat(3,1fr); } }
  @media (max-width:680px){  .prod-grid{ grid-template-columns:repeat(2,1fr); } }
  @media (max-width:460px){  .prod-grid{ grid-template-columns:repeat(1,1fr); } }

  /* === TARJETAS DE PRODUCTOS MEJORADAS === */
  .prod-card{
    background: #151528;
    border: 1px solid #2a2a40;
    border-radius: 16px;
    overflow: hidden;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    transition: all 0.25s ease;
    position: relative;
  }

  .prod-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand), #9d8aff);
    opacity: 0.8;
  }

  .prod-card:hover{
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,.3);
    border-color: #3a3a55;
  }

  .prod-img{
    width:100%;
    aspect-ratio: 1.2 / 1;
    object-fit:cover;
    background:#0e0e16;
    transition: transform 0.3s ease;
  }
 
  .prod-card:hover .prod-img {
    transform: scale(1.03);
  }
 
  .prod-body{
    padding:14px;
    display:flex;
    gap:8px;
    flex-direction:column;
    flex-grow: 1;
  }
  .prod-title{ font-weight:700; font-size:14px; line-height:1.3; color: var(--text); }
  .prod-meta{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin-top: auto; }
 
  /* === CORREGIDO: Footer mejorado === */
  .prod-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 14px;
    border-top: 1px solid #252538;
    background: rgba(20, 20, 32, 0.8);
    gap: 8px;
    min-height: 60px;
  }
 
  .muted{ color:var(--muted); font-size:12px; }

  /* Modal de detalle de producto */
  #productModal .box{ width:min(720px,95vw); }
  .pm-head{ display:flex; gap:14px; }
  .pm-img{ width:220px; height:220px; border-radius:12px; object-fit:cover; border:1px solid #2a2a3a; background:#0e0e16; }
  .pm-info{ flex:1; min-width:220px; }
  .pm-row{ display:flex; gap:10px; flex-wrap:wrap; }
  .pm-k{ font-size:12px; color:#aab; }
  .pm-v{ font-weight:800; }

  /* === NUEVO: ocultar col "Estado 2 (cierre)" en Cierres solo con CSS === */
  #tblClosures th:last-child,
  #tblClosures td:last-child {
    display: none;
  }

  /* ========== NUEVO: estilos livianos para PERFIL (no rompe nada) ========== */
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  @media (max-width:900px){ .grid-2 { grid-template-columns: 1fr; } }
  .box-title{ font-weight:800; margin-bottom:6px; }
  .note{ font-size:12px; color:var(--muted); }

  /* === NUEVO: avatar circular para Perfil === */
  .photo{ width:88px; height:88px; border-radius:50%; object-fit:cover; border:2px solid #222235; background:#0e0e16; }

  /* === MEJORAS DE VELOCIDAD VISUAL === */
  /* Transiciones m√°s r√°pidas para mejor respuesta */
  .card, .prod-card, .btn, .kpi {
    transition-duration: 0.2s;
  }

  /* Optimizaci√≥n para dispositivos t√°ctiles */
  @media (hover: none) {
    .card:hover, .prod-card:hover, .btn:hover, .kpi:hover {
      transform: none;
    }
  }

  /* Mejora en la legibilidad de textos */
  .prod-title, .kpi-value, .btn {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
  }
 
  /* === NUEVO: Estilos para el bot√≥n de rendici√≥n === */
  .rendicion-btn {
    margin-top: 12px;
    padding: 10px 16px;
    border-radius: 10px;
    border: none;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    width: 100%;
    text-align: center;
  }
 
  .rendicion-btn.pendiente {
    background: linear-gradient(135deg, #ff5c7c, #ff3b6d);
  }
 
  .rendicion-btn.rendido {
    background: linear-gradient(135deg, #21c08b, #1aad7c);
  }

  /* === NUEVO: Estilos para botones de edici√≥n/eliminaci√≥n === */
  .action-buttons {
    display: flex;
    gap: 6px;
    align-items: center;
    justify-content: flex-end;
    flex: 1;
  }
 
  .btn.danger {
    background: linear-gradient(135deg, #ff5c7c, #ff3b6d);
  }
 
  .btn.warning {
    background: linear-gradient(135deg, #ffa726, #ff9800);
  }

  /* === NUEVO: Estilos para bot√≥n de debug === */
  .btn.debug {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    margin-top: 8px;
  }

  /* =============================================== */
  /* üñ®Ô∏è ESTILOS PARA IMPRESI√ìN MASIVA (NUEVO) */
  /* =============================================== */

  /* Barra sticky */
  #bulkActionsHeader {
    position: sticky;
    top: 10px;
    z-index: 999;
    background: rgba(20, 20, 32, 0.95);
    backdrop-filter: blur(10px);
    border: 2px solid var(--brand);
    border-radius: 12px;
    padding: 12px 16px;
    margin: 12px 0 20px 0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    transition: all 0.3s ease;
  }

  #bulkActionsHeader.hidden {
    display: none !important;
  }

  /* Checkboxes */
  .bulk-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--brand);
    transform: scale(1.1);
    transition: all 0.2s ease;
  }

  .bulk-checkbox:hover {
    transform: scale(1.2);
  }

  .bulk-checkbox:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: scale(1);
  }

  /* Bot√≥n deshabilitado */
  #bulkPrintBtn:disabled,
  #bulkTxtBtn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background: linear-gradient(135deg, #666, #444) !important;
  }

  /* Resaltar filas seleccionadas */
  tr.selected-row td {
    background: rgba(124, 92, 255, 0.1) !important;
    border-left: 3px solid var(--brand) !important;
  }

  /* Checkbox "Seleccionar todos" */
  #selectAllOrders, #selectAllGuides {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--brand);
  }

  /* === NUEVO: Estilos para botones y contador === */
  .btn.small {
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .btn.small:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  }

  /* Bot√≥n de gu√≠a limpia */
  .btn.small[onclick*="abrirGuiaLimpia"] {
    background: linear-gradient(135deg, #007bff, #0056b3) !important;
  }

  /* Bot√≥n de copiar */
  .btn.small[onclick*="copiarGuiaLimpia"] {
    background: linear-gradient(135deg, #28a745, #1e7e34) !important;
  }

  /* Contador de selecci√≥n */
  .selection-counter {
    display: flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, var(--brand), #6a4dff);
    color: white;
    padding: 8px 14px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 14px;
    box-shadow: 0 2px 8px rgba(124, 92, 255, 0.4);
    border: 2px solid rgba(255,255,255,0.2);
    min-width: 160px;
  }

  .selection-counter .number {
    font-size: 20px;
    font-weight: 900;
    min-width: 30px;
    text-align: center;
  }

  .selection-counter .limit {
    font-size: 11px;
    opacity: 0.8;
    font-weight: 600;
  }

  /* Bot√≥n TXT */
  #bulkTxtBtn {
    background: linear-gradient(135deg, #17a2b8, #138496) !important;
  }

  #bulkTxtBtn:hover {
    background: linear-gradient(135deg, #138496, #117a8b) !important;
  }

  #bulkTxtBtn:disabled {
    background: linear-gradient(135deg, #666, #444) !important;
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Grupo de botones en tabla */
  td .row {
    display: flex;
    gap: 4px;
    align-items: center;
    justify-content: center;
  }

  @media (max-width: 768px) {
    td .row {
      flex-direction: column;
      gap: 2px;
    }
    .btn.small {
      padding: 4px 8px;
      font-size: 10px;
    }
   
    #bulkActionsHeader {
      flex-direction: column;
      gap: 10px;
      padding: 10px;
    }
   
    .selection-counter {
      min-width: auto;
      width: 100%;
      justify-content: center;
    }
  }

  /* === ESTILOS PARA INDICAR ACTUALIZACI√ìN EN PROGRESO === */
  select.updating {
    opacity: 0.7;
    background: linear-gradient(135deg, #1d1d2a, #252538);
    border: 1px solid var(--brand);
    position: relative;
    cursor: wait;
  }

  select.updating::after {
    content: ' ‚åõ';
    display: inline-block;
    animation: pulse 1.2s infinite;
    margin-left: 5px;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Estado exitoso moment√°neo */
  select.success-flash {
    animation: successFlash 0.8s ease;
  }

  @keyframes successFlash {
    0% { border-color: var(--brand); }
    50% { border-color: var(--ok); box-shadow: 0 0 8px rgba(33, 192, 139, 0.4); }
    100% { border-color: var(--brand); }
  }

  /* Estado de error */
  select.error-flash {
    animation: errorFlash 0.8s ease;
  }

  @keyframes errorFlash {
    0% { border-color: var(--brand); }
    50% { border-color: var(--err); box-shadow: 0 0 8px rgba(255, 92, 124, 0.4); }
    100% { border-color: var(--brand); }
  }

  /* Indicador de carga para selects */
  .select-loading {
    position: relative;
  }

  .select-loading::before {
    content: '';
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    border: 2px solid rgba(124, 92, 255, 0.3);
    border-top-color: var(--brand);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: translateY(-50%) rotate(360deg); }
  }

  /* ===================================================== */
  /* === NUEVOS ESTILOS PARA LAS ACTUALIZACIONES === */
  /* ===================================================== */
 
  .advanced-filters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin: 10px 0;
    padding: 12px;
    background: #1a1a2e;
    border-radius: 10px;
    border: 1px solid #2a2a40;
  }

  .advanced-filters select,
  .advanced-filters input {
    min-width: 150px;
    padding: 8px 12px;
  }

  .ranking-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }

  .ranking-table th {
    background: rgba(30, 30, 45, 0.8);
    padding: 12px;
    text-align: left;
    border-bottom: 2px solid var(--brand);
  }

  .ranking-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #2a2a3a;
  }

  .ranking-table tr:hover {
    background: rgba(40, 40, 60, 0.3);
  }

  .position-badge {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 14px;
  }

  .position-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
  .position-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: #000; }
  .position-3 { background: linear-gradient(135deg, #CD7F32, #A0522D); color: #000; }
  .position-other { background: #2a2a40; color: #fff; }

  .metric-card {
    background: #151528;
    border: 1px solid #2a2a40;
    border-radius: 12px;
    padding: 16px;
    margin: 8px 0;
  }

  .metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 6px 0;
  }

  .metric-label {
    font-size: 14px;
    color: #aab;
  }

  .metric-value {
    font-weight: 700;
    font-size: 16px;
  }

  .comparison-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 8px;
  }

  .better { background: rgba(33, 192, 139, 0.2); color: #21c08b; }
  .worse { background: rgba(255, 92, 124, 0.2); color: #ff5c7c; }
  .neutral { background: rgba(170, 170, 187, 0.2); color: #aab; }

  /* =============================================== */
  /* === NUEVOS ESTILOS PARA LAS FUNCIONALIDADES === */
  /* =============================================== */
 
  /* Tabs de productos */
  .product-tabs {
    display: flex;
    gap: 8px;
    margin: 10px 0 15px 0;
    padding: 4px;
    background: #1a1a2e;
    border-radius: 10px;
    border: 1px solid #2a2a40;
  }
 
  .tab-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    background: transparent;
    color: #aab;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    transition: all 0.2s ease;
  }
 
  .tab-btn:hover {
    background: rgba(124, 92, 255, 0.1);
    color: #fff;
  }
 
  .tab-btn.active {
    background: linear-gradient(135deg, var(--brand), #6a4dff);
    color: #fff;
    box-shadow: 0 2px 8px rgba(124, 92, 255, 0.3);
  }
 
  /* Bot√≥n de favorito en productos */
  .btn-icon {
    background: none;
    border: none;
    color: #FFD700;
    font-size: 20px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    min-width: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
 
  .btn-icon:hover {
    background: rgba(255, 215, 0, 0.1);
    transform: scale(1.1);
  }
 
  /* === CORREGIDO: Estilos espec√≠ficos para botones en cards de productos === */
  .prod-card .btn.small {
    background: linear-gradient(135deg, var(--brand), #6a4dff);
    color: white !important;
    border: none;
    padding: 6px 10px;
    font-size: 11px;
    font-weight: 600;
    min-height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
  }
 
  .prod-card .btn.small:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(124, 92, 255, 0.4);
  }
 
  .prod-card .btn.warning {
    background: linear-gradient(135deg, #ffa726, #ff9800);
  }
 
  .prod-card .action-buttons {
    display: flex;
    gap: 6px;
    align-items: center;
    justify-content: flex-end;
    flex: 1;
  }
 
  .prod-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 14px;
    border-top: 1px solid #252538;
    background: rgba(20, 20, 32, 0.8);
    gap: 8px;
    min-height: 60px;
  }
 
  .prod-footer .price-info {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
  }

  /* === ESTILOS PARA MODAL DE PROCESO MASIVO === */
  .progress-bar {
    width: 100%;
    height: 20px;
    background: #1a1a2e;
    border-radius: 10px;
    overflow: hidden;
    margin: 15px 0;
    border: 1px solid #2a2a40;
  }
 
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--brand), #6a4dff);
    width: 0%;
    transition: width 0.3s ease;
    position: relative;
  }
 
  .progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.4),
      transparent
    );
    animation: shimmer 2s infinite;
  }
 
  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
 
  .process-log {
    background: #0e0e16;
    border: 1px solid #2a2a40;
    border-radius: 8px;
    padding: 10px;
    font-family: monospace;
    font-size: 12px;
    color: #aab;
  }
 
  .process-log div {
    padding: 4px 0;
    border-bottom: 1px solid #252538;
  }
 
  .process-log .success {
    color: var(--ok);
  }
 
  .process-log .error {
    color: var(--err);
  }
 
  .process-log .info {
    color: #aab;
  }

  /* =============================================== */
  /* === NUEVOS ESTILOS PARA LA COLUMNA PROVEEDORES === */
  /* =============================================== */
 
  .provider-chip {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: help;
    border: 1px solid rgba(255,255,255,0.1);
    display: inline-block;
  }

  .provider-chip.multiple {
    background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
  }

  .provider-chip:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
 
  /* Estilo para proveedor √∫nico */
  .provider-chip.single {
    background: linear-gradient(135deg, #00b09b, #96c93d);
  }
 
  /* Estilo para sin proveedor */
  .provider-chip.empty {
    background: linear-gradient(135deg, #666, #888);
    opacity: 0.7;
  }
 
  /* Tooltip para proveedores */
  .provider-chip[title]:hover::after {
    content: attr(title);
    position: absolute;
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 11px;
    z-index: 1000;
    max-width: 300px;
    white-space: normal;
    word-wrap: break-word;
    margin-top: 5px;
    pointer-events: none;
  }
 
  /* === NUEVO: Estilos para mejor visualizaci√≥n de proveedores === */
  .provider-display {
    display: flex;
    align-items: center;
    gap: 4px;
  }
 
  .provider-display .btn-icon.small {
    padding: 2px 4px;
    font-size: 10px;
    min-width: 20px;
    height: 20px;
  }
 
  /* === NUEVO: Estilos para Estado de Retiro === */
  .retiro-select {
    min-width: 150px;
    padding: 6px 10px;
    border-radius: 8px;
    background: #1d1d2a;
    color: white;
    border: 1px solid #353552;
  }
 
  .retiro-pendiente {
    background: linear-gradient(135deg, #ffa72620, #ff980020);
    color: #ffa726;
    border: 1px solid #ffa72640;
  }
 
  .retiro-realizado {
    background: linear-gradient(135deg, #21c08b20, #1aad7c20);
    color: #21c08b;
    border: 1px solid #21c08b40;
  }
 
  .retiro-cancelado {
    background: linear-gradient(135deg, #ff5c7c20, #ff3b6d20);
    color: #ff5c7c;
    border: 1px solid #ff5c7c40;
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- HEADER -->
  <div class="header">
    <div class="brand">
      <!-- Logo m√°s grande -->
      <img src="https://cdn.shopify.com/s/files/1/0885/3012/5095/files/Captura_de_pantalla_2026-01-12_023843.jpg?v=1768196352" alt="DCANP GROUP Logo" />
      EL-ECOMMERCE DCANP GROUP
      <span class="chip">Sheets DB</span>
    </div>
    <div class="row" style="gap:12px;">
      <!-- Sello de √∫ltima actualizaci√≥n + bot√≥n refrescar -->
      <div class="row refreshBox" id="refreshBox" style="gap:8px;">
        <small>√öltima actualizaci√≥n: <span id="lastUpdateText">‚Äî</span></small>
        <button class="btn small refreshBtn" title="Actualizar" onclick="softRefresh()">‚Üª</button>
      </div>
      <div id="userBox" class="row"></div>
    </div>
  </div>

  <!-- NAV -->
  <nav class="row" style="margin-bottom:12px;">
    <button id="navLogin" class="btn primary" onclick="openLogin()">Login</button>
    <button id="navDash"  class="btn hidden" onclick="show('dashboard')">Dashboard</button>
    <button id="navNews"  class="btn hidden" onclick="show('news')">Novedades</button>
   <button id="navChat" class="btn hidden" onclick="show('chat'); loadChat()">Chat</button>

    <!-- === NUEVO: pesta√±a Pedidos con gu√≠as (solo ADMIN / DESPACHANTE) === -->
    <button id="navWithGuides" class="btn hidden" onclick="show('withGuides')">Pedidos con gu√≠as</button>

    <!-- === NUEVO: Pesta√±a Ranking Delivery === -->
    <button id="navRanking" class="btn hidden" onclick="show('rankingDelivery'); loadDeliveryRankingEnhanced()">
      üèÜ Ranking Delivery
    </button>

    <button id="navProd"  class="btn hidden" onclick="show('products')">Productos</button>
    <button id="navOrder" class="btn hidden" onclick="show('order')">Cargar pedido</button>
    <button id="navOrders"class="btn hidden" onclick="show('orders')">Pedidos</button>

    <!-- üõí NUEVO: Pedidos de Shopify + WhatsApp -->
    <button id="navShopifyInbox" class="btn hidden" onclick="show('shopifyInbox'); loadShopifyInbox()">Pedidos de Shopify + WhatsApp</button>
   
    <!-- === NUEVO: Bot√≥n Asignar Pedidos === -->
    <button id="navAssign" class="btn hidden" onclick="show('assignOrders'); loadAssignableOrders()">Asignar Pedidos</button>
   
    <button id="navRates" class="btn hidden" onclick="show('rates')">Costos delivery</button>
    <button id="navWallet"class="btn hidden" onclick="show('wallet')">Wallet</button>
   
    <!-- === MODIFICADO: Ahora PROVEEDOR tambi√©n ve Pago de comisiones === -->
    <button id="navComms" class="btn hidden" onclick="show('commissions')">Pago de comisiones</button>
   
    <button id="navCounter" class="btn hidden" onclick="show('counter')">Actualizar contador</button>
   
    <!-- === MODIFICADO: Ahora PROVEEDOR tambi√©n ve Cierres === -->
    <button id="navClosures" class="btn hidden" onclick="show('closures')">Cierres</button>

    <!-- === NUEVO: Rendiciones pagadas (ADMIN y PROVEEDOR) === -->
    <button id="navRendPaid" class="btn hidden" onclick="show('rendicionesPagadas'); loadRendicionesPagadas()">Rendiciones pagadas</button>

    <!-- ========= NUEVO: bot√≥n PERFIL (todos los roles) ========= -->
    <button id="navProfile" class="btn hidden" onclick="show('profile'); onOpenProfile()">Perfil</button>
   
    <!-- ========= NUEVO: PESTA√ëA USUARIOS (solo ADMIN) ========= -->
    <button id="navUsers" class="btn hidden" onclick="show('users'); loadUsers()">üë• Usuarios</button>

    <span class="chip" id="roleChip"></span>
  </nav>

  <!-- BARRA STICKY PARA IMPRESI√ìN MASIVA -->
  <div id="bulkActionsHeader" class="hidden">
    <!-- Contador funcional -->
    <div class="selection-counter">
      <span class="number">0</span><span class="limit">/30</span> seleccionados
    </div>
   
    <!-- Botones -->
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <button id="bulkPrintBtn" class="btn" onclick="generateBulkPDF()">üñ®Ô∏è PDF (<span id="pdfCount">0</span>)</button>
      <button id="bulkTxtBtn" class="btn" onclick="generateBulkTXT()">üìÑ TXT (<span id="txtCount">0</span>)</button>
      <!-- === NUEVO: Botones para actualizar proveedores === -->
      <button id="bulkUpdateProvidersBtn" class="btn" onclick="updateSelectedProviders()" style="background: linear-gradient(135deg, #9c27b0, #673ab7);">
        üîÑ Proveedores (<span id="selectedCount">0</span>)
      </button>
      <button id="updateAllProvidersBtn" class="btn" onclick="updateAllProviders()" style="background: linear-gradient(135deg, #2196f3, #3f51b5);">
        üîÑ Todos los pedidos
      </button>
      <button class="btn small" onclick="clearBulkSelection()" style="background:#2a2a40;">‚ùå Limpiar</button>
    </div>
  </div>

  <!-- üîê Login/Register -->
  <section id="view-auth" class="card">
    <div class="row" style="gap:16px;">
      <div style="flex:1; min-width:320px;">
        <h3>Ingresar</h3>
        <label>Email</label><input id="li_email">
        <label>Contrase√±a</label><input id="li_pass" type="password">
        <div class="row" style="gap:14px; margin-top:6px;">
          <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="li_remember"> Mantener sesi√≥n (30 d√≠as)</label>
          <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="li_saveemail"> Recordar email</label>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" onclick="onLogin()">Entrar</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <button class="btn small" style="background:#1d1d2a" onclick="openResetRequest()">¬øNo recuerdo mi contrase√±a?</button>
        </div>
      </div>
      <div style="flex:1; min-width:320px;">
        <h3>Crear cuenta</h3>
        <label>Nombre</label><input id="re_name">
        <label>Email</label><input id="re_email">
        <label>Contrase√±a</label><input id="re_pass" type="password">
        <label>Rol</label>
        <select id="re_role">
          <option value="VENDEDOR">VENDEDOR</option>
          <option value="DELIVERY">DELIVERY</option>
          <option value="DESPACHANTE">DESPACHANTE</option>
          <option value="PROVEEDOR">PROVEEDOR</option>
          <option value="ADMIN">ADMIN</option>
        </select>
        <small>‚ö° El primer usuario creado ser√° ADMIN autom√°ticamente.</small>
        <div class="row" style="margin-top:10px;"><button class="btn" onclick="onRegister()">Registrarme</button></div>
      </div>
    </div>
  </section>

  <!-- üìä Dashboard -->
  <section id="view-dashboard" class="hidden">
    <div class="card">
      <h3>Dashboard</h3>
      <div class="row" id="dashFilters" style="gap:8px;margin-bottom:10px%;">
        <label>Desde</label><input id="dash_from" type="date">
        <label>Hasta</label><input id="dash_to" type="date">
        <button class="btn" onclick="refreshDashboard()">Aplicar</button>
        <!-- === NUEVO: Bot√≥n de debug para PROVEEDOR === -->
        <button id="debugProviderBtn" class="btn debug hidden" onclick="debugProviderData()">DEBUG PROVEEDOR</button>
      </div>
     
      <!-- === NUEVO: KPIs espec√≠ficos para PROVEEDOR === -->
      <div id="providerKPIs" class="hidden">
        <div class="grid-5">
          <div class="kpi"><div class="kpi-title">Pedidos con mis productos</div><div id="kpi_provider_orders" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-title">Total vendido (Gs)</div><div id="kpi_provider_sold" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-title">Entregados</div><div id="kpi_provider_delivered" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-title">Cancelados</div><div id="kpi_provider_canceled" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-title">Utilidad Total (Gs)</div><div id="kpi_provider_profit" class="kpi-value">0</div></div>
        </div>
        <div class="grid-5" style="margin-top:12px;">
          <div class="kpi"><div class="kpi-title">Comisiones pendientes (Gs)</div><div id="kpi_provider_pending" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-title">Comisiones pagadas (Gs)</div><div id="kpi_provider_paid" class="kpi-value">0</div></div>
        </div>
      </div>
     
      <!-- KPIs normales (para otros roles) -->
      <div id="normalKPIs">
        <div class="grid-5">
          <div class="kpi"><div class="kpi-title">Pedidos</div><div id="kpi_orders" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-title">Total vendido (Gs)</div><div id="kpi_sold" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-title">Entregados</div><div id="kpi_delivered" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-title">Cancelados</div><div id="kpi_canceled" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-title" id="kpi5_title">Utilidad Total (Gs)</div><div id="kpi_profit" class="kpi-value">0</div></div>
        </div>
      </div>
     
      <div id="kpiSumEntregadoRow" class="row hidden" style="gap:16px; margin-top:12px;">
        <div class="kpi"><div class="kpi-title">Suma total ENTREGADO (Gs)</div><div id="kpi_sum_entregado" class="kpi-value">0</div></div>
      </div>
     
      <!-- === NUEVO: KPIs de Comisiones Pendientes === -->
      <div id="pendingCommissionsSection" class="hidden" style="margin-top: 20px;">
        <h3>üí∞ Comisiones Pendientes de Pago</h3>
        <div class="row" style="gap:16px; margin:12px 0;">
          <div class="kpi">
            <div class="kpi-title">Total Pendiente (Gs)</div>
            <div id="kpi_total_pending" class="kpi-value">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-title">Vendedores con Pendientes</div>
            <div id="kpi_vendors_pending" class="kpi-value">0</div>
          </div>
        </div>
       
        <div class="card" style="margin-top:12px;">
          <h4>Top Vendedores con Comisiones Pendientes</h4>
          <table style="width:100%;">
            <thead>
              <tr><th>Vendedor</th><th>Pedidos Pendientes</th><th>Monto Total (Gs)</th></tr>
            </thead>
            <tbody id="pending_vendors_tbody"></tbody>
          </table>
        </div>
      </div>
     
      <!-- === NUEVO: KPI de Ganancia Delivery (solo para DELIVERY) === -->
      <div id="deliveryProfitSection" class="hidden" style="margin-top: 20px;">
        <h3>üí∞ Mi Ganancia Delivery</h3>
        <div class="row" style="gap:16px; margin:12px 0;">
          <div class="kpi">
            <div class="kpi-title">Ganancia Total (Gs)</div>
            <div id="kpi_delivery_total_profit" class="kpi-value">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-title">Pendiente de Rendir (Gs)</div>
            <div id="kpi_delivery_pending_profit" class="kpi-value">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-title">Tarifas Cobradas</div>
            <div id="kpi_delivery_fees_count" class="kpi-value">0</div>
          </div>
        </div>
      </div>
     
      <div class="row" style="gap:16px; margin-top:16px;">
        <div class="card" style="flex:2; min-height:260px;"><canvas id="chartBars"></canvas></div>
        <div class="card" style="flex:1; min-height:260px;"><canvas id="chartPie"></canvas></div>
      </div>
      <div id="guideBlocks" class="hidden">
        <div class="row" style="gap:16px; margin-top:16px;">
          <div class="kpi"><div class="kpi-title">Gu√≠as generadas</div><div id="kpi_guides_gen" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-title">Gu√≠as pendientes</div><div id="kpi_guides_pend" class="kpi-value">0</div></div>
        </div>
        <div class="row" style="gap:16px; margin-top:16px;">
          <div class="card" style="flex:1; min-height:240px;"><h4>Gu√≠as generadas por d√≠a</h4><canvas id="chartGuideGen"></canvas></div>
          <div class="card" style="flex:1; min-height:240px;"><h4>Gu√≠as pendientes por d√≠a</h4><canvas id="chartGuidePend"></canvas></div>
        </div>
      </div>
      <div class="row" style="gap:16px; margin-top:16px;">
        <div class="card" style="flex:1; min-width:300px;"><h4>Top productos</h4><ul id="topList"></ul></div>
        <div class="card" style="flex:1; min-width:300px;"><h4>Ciudades (ventas)</h4><ul id="mapList"></ul></div>
      </div>
    </div>
  </section>

  <!-- üì∞ Novedades -->
  <section id="view-news" class="hidden">
    <div class="card">
      <h3>Novedades</h3>
      <table><thead><tr><th>Fecha</th><th>Pedido</th><th>Tipo</th><th>Nota</th></tr></thead>
      <tbody id="news_tbody"></tbody></table>
    </div>
  </section>

  <!-- üõçÔ∏è Productos -->
  <section id="view-products" class="hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h3>Cat√°logo</h3>
        <!-- === MODIFICADO: PROVEEDOR tambi√©n puede agregar productos === -->
        <button id="btnAddProduct" class="btn hidden" onclick="openAddProduct()">+ Agregar producto</button>
      </div>

      <!-- === NUEVO: Toolbar de productos (b√∫squeda / toggle) === -->
      <div class="prod-toolbar">
        <input id="prod_q" class="search" placeholder="üîé Buscar por t√≠tulo, SKU‚Ä¶">
        <button id="prod_toggle_table" class="tog" onclick="toggleProdTable()">Mostrar tabla</button>
        <!-- === NUEVO: Bot√≥n de debug para productos === -->
        <button class="btn debug small" onclick="debugProducts()">Debug Productos</button>
      </div>

      <!-- === NUEVO: Tabs de productos === -->
      <div class="product-tabs">
        <button class="tab-btn active" onclick="switchProductTab('general')">üì¶ General</button>
        <button class="tab-btn" onclick="switchProductTab('favoritos')">‚≠ê Favoritos</button>
        <button class="tab-btn" onclick="switchProductTab('privados')">üîí Mis Privados</button>
      </div>

      <!-- === NUEVO: Grilla de cards === -->
      <div id="prodGrid" class="prod-grid"></div>

      <!-- (se mantiene la TABLA original, por si quer√©s verla; por defecto oculta) -->
      <div id="prodTableWrap" class="hidden" style="overflow:auto; margin-top:14px;">
        <table id="tblProducts">
          <thead><tr><th></th><th>T√≠tulo</th><th>SKU</th><th class="right">Proveedor (Gs)</th><th class="right">Stock</th><th>Proveedor</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- NUEVO: Modal de detalle de producto -->
      <div id="productModal" class="modal">
        <div class="box">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <h3>Detalle de producto</h3>
            <button class="btn" onclick="closeProductModal()">Cerrar</button>
          </div>
          <div class="pm-head" style="margin-top:8px;">
            <img id="pm_img" class="pm-img" src="" alt="Producto" onerror="this.src='https://via.placeholder.com/220x220?text=No+image'">
            <div class="pm-info">
              <div class="prod-title" id="pm_title">‚Äî</div>
              <div class="pm-row" style="margin-top:8px;">
                <div><div class="pm-k">SKU</div><div class="pm-v" id="pm_sku">‚Äî</div></div>
                <div><div class="pm-k">Proveedor (Gs)</div><div class="pm-v" id="pm_provider">0</div></div>
                <div><div class="pm-k">Stock</div><div class="pm-v" id="pm_stock">0</div></div>
                <div><div class="pm-k">Proveedor</div><div class="pm-v" id="pm_provider_email">‚Äî</div></div>
              </div>
              <div class="muted" style="margin-top:8px;">* Estos son los datos actuales en tu cat√°logo.</div>
            </div>
          </div>
          <hr style="border:0;border-top:1px solid #2a2a3a; margin:14px 0;">
          <div>
            <label>Notas internas (opcional)</label>
            <textarea id="pm_notes" rows="3" placeholder="Anot√° referencias, proveedor alternativo, costos log√≠sticos, etc. (local; no se guarda a√∫n)"></textarea>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" onclick="closeProductModal()">Listo</button>
          </div>
        </div>
      </div>

      <!-- Form agregar producto (actualizado con los nuevos campos) -->
      <div id="addProductBox" class="hidden" style="margin-top:12px;">
        <div class="row" style="gap:10px;">
          <input id="np_title" placeholder="T√≠tulo">
          <input id="np_sku" placeholder="SKU">
          <input id="np_price" type="number" placeholder="Proveedor (Gs)">
          <input id="np_stock" type="number" placeholder="Stock">
          <input id="np_img" placeholder="Imagen URL">
        </div>
       
        <div class="row" style="gap:10px; margin-top:8px;">
          <!-- CAMPO 1: Email del proveedor -->
          <input id="np_provider_email" placeholder="Email del proveedor">
         
          <!-- NUEVO CAMPO: Vendedores autorizados -->
          <input id="np_private_to" placeholder="Vendedores autorizados (opcional)">
         
          <button class="btn" onclick="saveNewProduct()">Guardar</button>
        </div>
       
        <!-- Mensajes informativos -->
        <div class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap;">
          <small class="badge" style="background:#2a2a40;">
            ‚ö†Ô∏è Si sos PROVEEDOR: el email se autocompleta
          </small>
          <small class="badge" style="background:#2a2a40;">
            üìß Vendedores autorizados: vac√≠o = visible para TODOS
          </small>
        </div>
      </div>
    </div>
  </section>

  <!-- üìù Cargar pedido -->
  <section id="view-order" class="hidden">
    <div class="card">
      <h3>Cargar pedido</h3>
      <div class="row" style="gap:16px;">
        <div style="flex:1; min-width:320px;">
          <label>Cliente</label><input id="o_customer">
          <label>Tel√©fono</label><input id="o_phone">
          <label>Ciudad</label>
          <select id="o_city" onchange="recalcOrder()"></select>
          <div class="row"><span class="chip" id="cityHint"></span></div>
          <label>Calle</label><input id="o_street">
          <label>Barrio</label><input id="o_district">
          <label>Email</label><input id="o_email" placeholder="Opcional">
          <label>Observaci√≥n</label><textarea id="o_obs" rows="2"></textarea>
        </div>
        <div style="flex:2; min-width:420px;">
          <label>Items</label>
          <div id="itemsBox"></div>
          <div class="row" style="margin-top:8px;">
            <button class="btn" onclick="addItemRow()">+ Agregar √≠tem</button>
            <span id="catalogStatus" class="chip">Cargando cat√°logo...</span>
          </div>
          <div class="row" style="margin-top:12px;">
            <div style="flex:1;"><label>Total (Gs)</label><input id="o_total" readonly></div>
            <div style="flex:1;"><label>Delivery cobrado (Gs)</label><input id="o_delivery" readonly></div>
            <div style="flex:1;"><label>Comisi√≥n estimada (Gs)</label><input id="o_commission" readonly></div>
          </div>
          <div class="row" style="margin-top:12px;"><button class="btn" onclick="saveOrder()">Guardar pedido</button></div>
        </div>
      </div>
    </div>
  </section>


  <section id="view-shopifyInbox" class="hidden">
    <div class="card">
      <h3>Pedidos de Shopify + WhatsApp</h3>
      <div class="muted" style="margin:6px 0 12px;">Peg√° aqu√≠ las filas copiadas desde tu Google Sheet de Shopify (Ctrl+C / Ctrl+V). Acepta encabezado. Luego import√° para que queden en estado <b>PENDIENTE</b>.</div>

      <label>Pegado (tabla)</label>
      <textarea id="shopify_paste" rows="8" placeholder="Peg√° ac√°..."></textarea>
      <div class="row" style="margin-top:10px; gap:10px;">
        <button class="btn" onclick="importShopifyPaste()">Guardar / Importar</button>
        <button class="btn" style="background:#252538;" onclick="document.getElementById('shopify_paste').value=''">Limpiar</button>
        <span id="shopify_import_msg" class="chip">‚Äî</span>
      </div>

      <hr style="border:0;border-top:1px solid #2a2a3a; margin:14px 0;">

      <div class="row" style="gap:10px; flex-wrap:wrap; margin-bottom:10px;">
        <label>Desde</label><input id="sb_from" type="date">
        <label>Hasta</label><input id="sb_to" type="date">
        <label>Estado</label>
        <select id="sb_status">
          <option value="">Todos</option>
          <option value="PENDIENTE">PENDIENTE</option>
          <option value="CARGADO">CARGADO</option>
          <option value="CANCELADO">CANCELADO</option>
          <option value="REPETIDO">REPETIDO</option>
        </select>
        <button class="btn small" onclick="loadShopifyInbox()">Filtrar</button>
      </div>

      <div style="overflow:auto;">
        <table id="tblShopifyInbox">
          <thead>
            <tr>
              <th>Fecha</th><th>Cliente</th><th>Tel√©fono</th><th>Ciudad</th><th>Producto</th><th class="right">Cant.</th><th class="right">Monto</th><th>Estado</th><th class="right">Acciones</th>
            </tr>
          </thead>
          <tbody id="shopify_tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- üì¶ Pedidos -->
  <section id="view-orders" class="hidden">
    <div class="card">
      <h3>Pedidos</h3>
      <div class="row" id="ordersFilters" style="gap:12px; margin-bottom:10px;">
        <label>Desde</label><input id="of_from" type="date">
        <label>Hasta</label><input id="of_to" type="date">
        <div class="row" style="flex:1; min-width:360px;">
          <input id="orderSearch" class="search" placeholder="üîé Buscar por cliente, tel√©fono, ID o ciudad" style="flex:1;">
          <button class="btn small" onclick="renderOrdersLast()">Filtrar</button>
          <!-- === NUEVO: Bot√≥n para mostrar/ocultar filtros avanzados === -->
          <button class="btn small" onclick="toggleAdvancedFilters()" style="background:#2a2a40;">Filtros Avanzados</button>
        </div>
      </div>
     
      <!-- === MODIFICADO: Filtros Simplificados (solo para ADMIN, PROVEEDOR, DESPACHANTE, VENDEDOR) === -->
      <div id="advancedFiltersSection" class="advanced-filters hidden">
        <select id="filter_provider">
          <option value="">Todos los proveedores</option>
        </select>
        <select id="filter_status">
          <option value="">Todos los estados</option>
          <option value="PENDIENTE">PENDIENTE</option>
          <option value="EN RUTA">EN RUTA</option>
          <option value="ENTREGADO">ENTREGADO</option>
          <option value="ENCOMIENDA ENTREGADA">ENCOMIENDA ENTREGADA</option>
          <option value="CANCELADO">CANCELADO</option>
        </select>
        <button class="btn small" onclick="applyAdvancedFiltersSimplified()">Aplicar Filtros</button>
        <button class="btn small" onclick="clearAdvancedFiltersSimplified()" style="background:#2a2a40;">Limpiar</button>
      </div>
     
      <div style="overflow:auto;">
        <table id="tblOrders">
          <thead>
            <tr>
              <!-- NUEVO: Checkbox para seleccionar todos -->
              <th style="width:50px; text-align:center;">
                <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAll('orders')" title="Seleccionar todos">
              </th>
              <!-- Columnas existentes (NO TOCAR) -->
              <th>Fecha</th>
              <th>ID</th>
              <th>Ciudad</th>
              <th>Cliente</th>
              <th>Vendedor</th>
              <th>Delivery asignado</th>
              <th class="right">Total (Gs)</th>
              <th class="right" id="th_comm">Monto a comisionar / Tarifa (Gs)</th>
              <!-- NUEVA COLUMNA: PROVEEDORES -->
              <th>Proveedores</th>
              <th>Estado 1</th>
              <th>Estado 2 (ADMIN/DESP)</th>
              <th>Asignar Delivery</th>
              <th>Gu√≠a</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- üöö Costos delivery -->
  <section id="view-rates" class="hidden">
    <div class="card">
      <h3>Costos de delivery por ciudad</h3>

      <!-- === MODIFICADO: PROVEEDOR tambi√©n puede ver tarifas === -->
      <div id="ratesAdminBox" class="hidden" style="margin-bottom:8px;">
        <div class="row" style="gap:10px;">
          <input id="dr_email" placeholder="delivery@email.com">
          <input id="dr_city"  placeholder="Ciudad">
          <input id="dr_rate"  type="number" placeholder="Tarifa (Gs)">
          <button class="btn" onclick="saveRate()">Guardar/Actualizar</button>
        </div>
      </div>

      <table><thead><tr><th>Email</th><th>Ciudad</th><th class="right">Tarifa (Gs)</th></tr></thead>
      <tbody id="rates_tbody"></tbody></table>

      <hr style="border:0;border-top:1px solid #2a2a3a;margin:16px 0;">

      <h3 style="margin-top:0;">Precio al cliente por ciudad</h3>
      <div id="clientPricesAdminBox" class="hidden" style="margin-bottom:8px;">
        <div class="row" style="gap:10px;">
          <input id="cp_city"  placeholder="Ciudad">
          <input id="cp_price" type="number" placeholder="Precio al cliente (Gs)">
          <button class="btn" onclick="saveClientPrice()">Guardar/Actualizar</button>
        </div>
        <small class="badge">Impacta en el formulario de pedido (Delivery cobrado).</small>
      </div>
      <table><thead><tr><th>Ciudad</th><th class="right">Precio cliente (Gs)</th></tr></thead>
      <tbody id="client_prices_tbody"></tbody></table>
    </div>
  </section>

  <!-- üëõ Wallet -->
  <section id="view-wallet" class="hidden">
    <div class="card">
      <h3>Wallet</h3>
      <div class="grid-5">
        <div class="kpi"><div class="kpi-title">Saldo</div><div id="w_balance" class="kpi-value">0</div></div>
      </div>
      <table style="margin-top:12px;"><thead><tr><th>Fecha</th><th>Tipo</th><th>Pedido</th><th class="right">Monto (Gs)</th><th>Nota</th></tr></thead>
        <tbody id="wallet_tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- üí∏ Pago de comisiones (ADMIN y PROVEEDOR) -->
  <section id="view-commissions" class="hidden">
    <div class="card">
      <h3 id="commissions_title">Pago de comisiones</h3>
     
      <div class="row" style="gap:10px; margin-bottom:10px;">
        <label>Desde</label><input id="pc_from" type="date">
        <label>Hasta</label><input id="pc_to" type="date">
       
        <!-- CAMBIO: Para VENDEDOR, el email viene precargado y bloqueado -->
        <div id="vendor_email_box" class="hidden" style="display:flex; align-items:center; gap:6px;">
          <span class="chip">Email:</span>
          <input id="pc_vendor" value="" readonly style="background:#2a2a40; color:#ccc; min-width:250px;">
          <span class="chip">üîí</span>
        </div>
       
        <!-- Para ADMIN/PROVEEDOR sigue igual -->
        <div id="vendor_email_admin_box">
          <select id="pc_vendor_admin" style="min-width:300px;"><option value="">Todos los vendedores</option></select>
        </div>

        <select id="comm_filter_provider" style="min-width:300px;">
          <option value="">Todos los proveedores</option>
        </select>

        <select id="pc_only" style="width:auto; min-width:160px;">
          <option value="">Todos</option>
          <option value="PENDIENTE">Pendiente</option>
          <option value="PAGADO">Pagado</option>
        </select>
       
        <input id="pc_q" placeholder="üîé Buscar por cliente, tel√©fono o ID" style="min-width:300px;">
        <button class="btn" onclick="loadCommissionsForVendor()">Aplicar</button>
      </div>
     
      <!-- === MODIFICADO: PROVEEDOR tambi√©n puede marcar como pagado === -->
      <div id="bulkActions" class="row" style="margin:6px 0 12px;">
        <button class="btn small" onclick="markAllCommissionsPaid()">Marcar todos como PAGADO (vista actual)</button>
      </div>

      <!-- === NUEVO: KPIs de Pago de comisiones (NO TOCAR NADA M√ÅS) === -->
      <div class="grid-5" style="margin:10px 0 12px;">
        <div class="kpi">
          <div class="kpi-title">Pedidos filtrados</div>
          <div id="pc_k_cnt" class="kpi-value">0</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Suma Monto a comisionar (Gs)</div>
          <div id="pc_k_sum" class="kpi-value">0</div>
        </div>
      </div>
      <!-- === FIN NUEVO === -->

      <div style="overflow:auto;">
        <table id="tblComms">
          <thead>
            <tr>
              <th>Fecha</th><th>ID</th><th>Ciudad</th><th>Cliente</th><th>Vendedor</th><th>Delivery asignado</th>
              <th class="right">Total (Gs)</th><th class="right">Monto a comisionar (Gs)</th><th>Estado 1</th><th>Pago comisi√≥n</th><th>Gu√≠a</th>
            </tr>
          </thead>
          <tbody id="comms_tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- üî¢ Actualizar Contador -->
  <section id="view-counter" class="hidden">
    <div class="card">
      <h3>Actualizar Contador de √ìrdenes</h3>
      <div class="row" style="gap:10px; margin-bottom:10px;">
        <span class="chip">Prefijo: <b id="seq_prefix"></b></span>
        <span class="chip">Padding: <b id="seq_pad"></b></span>
        <span class="chip">Contador actual: <b id="seq_value"></b></span>
      </div>
      <div class="row" style="gap:10px;">
        <input id="seq_new" type="number" placeholder="Nuevo contador (ej. 356)">
        <button class="btn" onclick="setSeq()">Guardar contador</button>
      </div>
      <small class="badge">Ejemplo: si pones 356, el pr√≥ximo ID ser√° A357</small>
    </div>
  </section>

  <!-- ‚úÖ Cierres (ADMIN y PROVEEDOR) -->
  <section id="view-closures" class="hidden">
    <div class="card">
      <h3>Cierres</h3>

      <div class="row" style="gap:10px; margin-bottom:10px;">
        <label>Desde (asignado)</label><input id="cl_from" type="date">
        <label>Hasta</label><input id="cl_to" type="date">
        <select id="cl_delivery" style="min-width:280px;">
          <option value="">Todos los repartidores</option>
        </select>
        <select id="cl_type" style="min-width:220px;">
          <option value="">Todos los tipos (Estado 1)</option>
          <option value="ENTREGADO" selected>ENTREGADO</option>
          <option value="ENCOMIENDA ENTREGADA">ENCOMIENDA ENTREGADA</option>
          <option value="EN RUTA">EN RUTA</option>
          <option value="PENDIENTE">PENDIENTE</option>
          <option value="REAGENDADO">REAGENDADO</option>
          <option value="NO CONTESTA">NO CONTESTA</option>
          <option value="RECHAZADO">RECHAZADO</option>
          <option value="RECHAZADO EN EL LUGAR">RECHAZADO EN EL LUGAR</option>
          <option value="CANCELADO">CANCELADO</option>
          <option value="NO DESEA">NO DESEA</option>
          <option value="CANCEL√ì POR WHATSAPP">CANCEL√ì POR WHATSAPP</option>
          <option value="DEVUELTO A DEP√ìSITO">DEVUELTO A DEP√ìSITO</option>
        </select>
        <button class="btn" onclick="loadClosures()">Aplicar</button>
      </div>
     
      <!-- === NUEVO: Control de Rendici√≥n Pagada === -->
      <div id="rendicionControlBox" class="hidden" style="margin:15px 0; padding:12px; background:#1a1a2e; border-radius:10px; border:1px solid #2a2a40;">
        <h4>üè∑Ô∏è Control de Rendici√≥n</h4>
       
        <div class="row" style="gap:15px; align-items:center; margin-top:8px;">
          <div style="flex:1;">
            <div class="row" style="gap:8px; align-items:center;">
              <span class="chip">Delivery:</span>
              <span id="rendicion_delivery_name" class="badge">Seleccione un delivery</span>
            </div>
            <div class="row" style="gap:8px; align-items:center; margin-top:4px;">
              <span class="chip">Total a pagar:</span>
              <span id="rendicion_total_pagar" class="kpi-value" style="font-size:18px;">0 Gs</span>
            </div>
          </div>
         
          <div style="flex:1;">
            <div class="row" style="gap:8px; align-items:center;">
              <span class="chip">Fecha:</span>
              <span id="rendicion_fecha" class="badge">Hoy</span>
            </div>
            <div class="row" style="gap:8px; align-items:center; margin-top:4px;">
              <span class="chip">Estado:</span>
              <span id="rendicion_estado" class="badge" style="background:#ffa72620; color:#ffa726;">‚è≥ PENDIENTE</span>
            </div>
          </div>
         
          <div>
            <button id="btnMarcarPagado" class="btn" onclick="marcarRendicionPagada()" style="background:linear-gradient(135deg,#28a745,#1e7e34);">
              ‚úÖ MARCAR COMO PAGADO
            </button>
            <button id="btnDesmarcarPagado" class="btn hidden" onclick="desmarcarRendicionPagada()" style="background:linear-gradient(135deg,#dc3545,#c82333);">
              ‚ùå DESMARCAR PAGADO
            </button>
          </div>
        </div>
       
        <!-- Opcional: Nota -->
        <div style="margin-top:8px;">
          <input id="rendicion_nota" placeholder="Agregar nota (opcional)" style="width:100%; padding:8px;">
        </div>
      </div>

      <small class="badge">Los KPIs se calculan <b>solo</b> con Estado 1 = <b>ENTREGADO</b>.</small>

      <!-- === NUEVO: KPIs detallados de Cierres === -->
      <div class="grid-5" style="margin:10px 0 12px;">
        <div class="kpi">
          <div class="kpi-title">ENTREGADOS</div>
          <div class="kpi-value" id="cl_k_entregados_cnt">0</div>
          <small class="kpi-title">Gs <span id="cl_k_entregados_rev">0</span></small>
        </div>
        <div class="kpi">
          <div class="kpi-title">ENCOMIENDAS ENTREGADAS</div>
          <div class="kpi-value" id="cl_k_encomiendas_cnt">0</div>
          <small class="kpi-title">Gs <span id="cl_k_encomiendas_rev">0</span></small>
        </div>
        <div class="kpi">
          <div class="kpi-title">Ganancia Delivery (Gs)</div>
          <div class="kpi-value" id="cl_k_delivery_fee">0</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Neto a Rendir (Gs)</div>
          <div class="kpi-value" id="cl_k_net_rendir">0</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Pedidos asignados hoy</div>
          <div class="kpi-value" id="cl_k_assigned_today">0</div>
        </div>
      </div>

      <!-- === NUEVO: Bot√≥n de rendici√≥n === -->
      <div id="rendicionBtnContainer" class="hidden">
        <button id="rendicionBtn" class="rendicion-btn pendiente" onclick="toggleRendicion()">PENDIENTE DE RENDIR</button>
      </div>

      <div style="overflow:auto;">
        <table id="tblClosures" style="min-width:1100px;">
          <thead>
            <tr>
              <th>Asignado</th><th>ID</th><th>Ciudad</th><th>Cliente</th>
              <th class="right">Total (Gs)</th><th class="right">Tarifa (Gs)</th><th class="right">Neto (Gs)</th>
              <th>Estado 1</th>
              <th>Estado de retiro</th> <!-- NUEVA COLUMNA -->
              <th>Estado 2 (cierre)</th>
            </tr>
          </thead>
          <tbody id="cl_tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- === NUEVO: Vista Pedidos con gu√≠as (KPI + tabla pedida) === -->
  <section id="view-withGuides" class="hidden">
    <div class="card">
      <h3>Pedidos con gu√≠as</h3>
      <!-- KPI de gu√≠as pendientes -->
      <div class="grid-5" style="margin:6px 0 10px;">
        <div class="kpi">
          <div class="kpi-title">Gu√≠as pendientes</div>
          <div id="pg_k_cnt" class="kpi-value">0</div>
        </div>
      </div>
      <!-- Filtros (B√∫squeda + Avanzados) -->
      <div class="row" style="gap:10px; margin-bottom:10px;">
        <input id="pg_q" class="search" placeholder="üîé Buscar por cliente, tel√©fono, ID o ciudad" style="flex:1;">
        <button class="btn" onclick="renderPendingGuidesSimplified()">Filtrar</button>
        <button class="btn" onclick="togglePendingGuidesAdvanced()">Filtros Avanzados</button>
      </div>

      <div id="pg_adv" class="card" style="padding:10px; margin-bottom:10px; display:none;">
        <div class="row" style="gap:10px;">
          <select id="pg_filter_provider" style="min-width:220px;">
            <option value="">Todos los proveedores</option>
          </select>
         <select id="pg_filter_tipo" style="min-width:220px;">
           <option value="PENDIENTES">Gu√≠as pendientes</option>
           <option value="GENERADAS">Gu√≠as generadas</option>
           <option value="TODAS">Todas</option>
         </select>
          <select id="pg_filter_status" style="min-width:220px;">
            <option value="">Todos los estados</option>
            <option value="PENDIENTE">PENDIENTE</option>
            <option value="EN RUTA">EN RUTA</option>
            <option value="ENTREGADO">ENTREGADO</option>
            <option value="ENCOMIENDA ENTREGADA">ENCOMIENDA ENTREGADA</option>
            <option value="CANCELADO">CANCELADO</option>
          </select>
        </div>
        <div class="row" style="gap:10px; margin-top:10px;">
          <button class="btn" onclick="renderPendingGuidesSimplified()">Aplicar Filtros</button>
          <button class="btn" onclick="clearPendingGuidesFiltersSimplified()">Limpiar</button>
        </div>
        <small class="badge" style="margin-top:8px; display:inline-block;">La b√∫squeda (lupa) de arriba es independiente. Estos son filtros avanzados.</small>
      </div>
      <div style="overflow:auto;">
        <table id="tblPendingGuides" style="min-width:1300px;">
          <thead>
            <tr>
              <!-- Checkbox para seleccionar todos -->
              <th style="width:50px; text-align:center;">
                <input type="checkbox" id="selectAllGuides" onchange="toggleSelectAll('guides')" title="Seleccionar todos">
              </th>
              <!-- Columnas actualizadas -->
              <th>Fecha</th>
              <th>ID</th>
              <th>Ciudad</th>
              <th>Cliente</th>
              <th>Vendedor</th>
              <th>Proveedor</th> <!-- NUEVA COLUMNA -->
              <th>Estado 2 (ADMIN/DESP)</th>
              <th>Gu√≠a</th>
            </tr>
          </thead>
          <tbody id="pg_tbody"></tbody>
        </table>
      </div>
    </div>
  </section>
  <!-- === FIN NUEVO === -->

  <!-- === NUEVO: Chat (DM + Online + Le√≠do) === -->
  <section id="view-chat" class="hidden">
    <div class="card">
      <h3>Chat</h3>
      <div class="row" style="gap:12px; align-items:stretch;">

        <!-- Panel de conversaciones -->
        <div id="chatThreadsPanel" class="card" style="width:320px; padding:12px; overflow:auto; max-height:520px;">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <b>Conversaciones</b>
            <button class="btn small" onclick="loadChatThreads()">‚Üª</button>
          </div>

          <label>Escribir a</label>
          <select id="chatToSelect" onchange="startChatWithSelected()">
            <option value="">-- Elegir destinatario --</option>
          </select>

          <div style="height:10px;"></div>
          <div id="chatThreads"></div>
        </div>

        <!-- Panel de mensajes -->
        <div style="flex:1; min-width:320px;">
          <div class="card" style="padding:12px; margin-bottom:10px;">
            <div class="row" style="justify-content:space-between; align-items:flex-start;">
              <div>
                <div class="badge">Chat con</div>
                <div id="chatThreadTitle" style="font-weight:700; margin-top:6px;">Seleccione un destinatario</div>
                <div id="chatPresence" class="badge" style="margin-top:8px; display:inline-block;">‚Äî</div>
              </div>
              <div class="row" style="gap:8px;">
                <button class="btn small" onclick="loadChatMessages()">Actualizar</button>
              </div>
            </div>
          </div>

          <div id="chatMessages" class="card" style="padding:12px; max-height:420px; overflow:auto; margin-bottom:10px;"></div>

          <div class="row" style="gap:10px;">
            <input id="chatText" class="search" placeholder="Escrib√≠ tu mensaje..." style="flex:1;">
            <input id="chatFile" type="file" style="max-width:200px;">
            <button class="btn" onclick="sendChat()">Enviar</button>
          </div>
          <small class="badge" style="margin-top:10px; display:inline-block;">Adjuntos: recomendado &lt; 2MB.</small>
        </div>

      </div>
    </div>
  </section>
  <!-- === FIN CHAT === -->


<!-- === NUEVO: Vista Rendiciones pagadas (ADMIN / PROVEEDOR) === -->
  <section id="view-rendicionesPagadas" class="hidden">
    <div class="card">
      <h3>Rendiciones pagadas</h3>
      <div class="row" style="gap:10px; margin-bottom:12px;">
        <select id="rp_delivery" style="min-width:260px;"><option value="">Todos los delivery</option></select>
        <label>Desde</label><input id="rp_from" type="date">
        <label>Hasta</label><input id="rp_to" type="date">
        <button class="btn" onclick="loadRendicionesPagadas()">Actualizar</button>
      </div>
      <div style="overflow:auto;">
        <table id="tblRendicionesPagadas" style="min-width:1100px;">
          <thead>
            <tr>
              <th>Delivery</th>
              <th>Fecha</th>
              <th class="right">Monto Total (Gs)</th>
              <th>Nota</th>
              <th>Marcado por</th>
              <th>Marcado en</th>
              <th>Pagado en</th>
            </tr>
          </thead>
          <tbody id="rp_tbody"></tbody>
        </table>
      </div>
      <small class="badge" style="margin-top:10px; display:inline-block;">
        Se carga desde la hoja <b>RENDICIONES_PAGADAS</b>.
      </small>
    </div>
  </section>
  <!-- === FIN NUEVO === -->

  <!-- === NUEVO: Vista Asignar Pedidos === -->
  <section id="view-assignOrders" class="hidden">
    <div class="card">
      <h3>Asignar Pedidos</h3>
     
      <!-- Filtros -->
      <div class="row" style="gap:10px; margin-bottom:12px;">
        <label>Desde</label><input id="as_from" type="date">
        <label>Hasta</label><input id="as_to" type="date">
        <input id="as_q" placeholder="üîé Buscar cliente, ID, ciudad..." style="flex:1;">
        <button class="btn" onclick="loadAssignableOrders()">Filtrar</button>
      </div>
     
      <!-- Para ADMIN/PROVEEDOR: selecci√≥n masiva -->
      <div id="adminAssignBox" class="hidden row" style="gap:10px; margin-bottom:12px;">
        <select id="as_delivery">
          <option value="">Seleccionar delivery...</option>
          <!-- Se llena con JS -->
        </select>
        <button class="btn" onclick="bulkAssignSelected()">Asignar seleccionados</button>
      </div>
     
      <!-- Tabla de pedidos -->
      <div style="overflow:auto;">
        <table id="tblAssign">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
              <th>Fecha</th><th>ID</th><th>Ciudad</th><th>Cliente</th>
              <th>Estado</th><th>Asignado a</th><th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="assign_tbody"></tbody>
        </table>
      </div>
    </div>
  </section>
  <!-- === FIN NUEVO: Vista Asignar Pedidos === -->

  <!-- === NUEVA PESTA√ëA: üèÜ Ranking Delivery === -->
  <section id="view-rankingDelivery" class="hidden">
    <div class="card">
      <h3>üèÜ Ranking de Delivery</h3>
     
      <!-- Filtros de fecha -->
      <div class="row" style="gap:10px; margin-bottom:12px;">
        <label>Desde</label><input id="rank_from" type="date">
        <label>Hasta</label><input id="rank_to" type="date">
       
        <!-- NUEVO: Filtro de proveedores -->
        <select id="rank_provider">
          <option value="">Todos los proveedores</option>
        </select>
       
        <!-- Filtro de m√©trica -->
        <select id="rank_metric" onchange="updateRankingChart()">
          <option value="entregados">Entregados</option>
          <option value="encomiendas">Encomiendas</option>
          <option value="cancelados">Cancelados</option>
          <option value="efectividad">Efectividad</option>
        </select>
       
        <!-- NUEVO: Multiselect de delivery (solo ADMIN/DESPACHANTE) -->
        <select id="rank_delivery_multiple" multiple style="min-width:200px; display:none;">
          <option value="">Seleccionar delivery...</option>
        </select>
       
        <button class="btn" onclick="loadDeliveryRankingEnhanced()">Actualizar</button>
      </div>
     
      <!-- KPIs resumen -->
      <div class="grid-5" style="margin:10px 0 12px;">
        <div class="kpi"><div class="kpi-title">Total Delivery</div><div id="rank_total_delivery" class="kpi-value">0</div></div>
        <div class="kpi"><div class="kpi-title">Promedio Entregados</div><div id="rank_avg_entregados" class="kpi-value">0</div></div>
        <div class="kpi"><div class="kpi-title">Promedio Efectividad</div><div id="rank_avg_efectividad" class="kpi-value">0%</div></div>
        <div class="kpi"><div class="kpi-title">Mejor Efectividad</div><div id="rank_best_efectividad" class="kpi-value">0%</div></div>
        <div class="kpi"><div class="kpi-title">Total Pedidos</div><div id="rank_total_pedidos" class="kpi-value">0</div></div>
      </div>
     
      <!-- Vista para PROVEEDOR/ADMIN/DESPACHANTE -->
      <div id="fullRankingView" class="hidden">
        <div class="row" style="gap:20px; margin-top:16px;">
          <div style="flex:1; min-width:400px;">
            <h4>Top 10 Delivery</h4>
            <table class="ranking-table">
              <thead>
                <tr>
                  <th>Pos</th><th>Delivery</th><th>ENT</th><th>ENC</th><th>CAN</th><th>Efect.</th>
                </tr>
              </thead>
              <tbody id="ranking_tbody"></tbody>
            </table>
          </div>
          <div style="flex:2; min-width:500px;">
            <h4>Gr√°fico de Ranking</h4>
            <canvas id="chartRanking" style="max-height: 400px;"></canvas>
          </div>
        </div>
      </div>
     
      <!-- Vista para DELIVERY (su posici√≥n personal) -->
      <div id="personalRankingView" class="hidden">
        <div class="card" style="margin:16px 0; background: linear-gradient(135deg, #1a1a2e, #252538);">
          <h4 style="color: var(--brand);">üéØ Mi Posici√≥n en el Ranking</h4>
          <div class="row" style="align-items:center; gap:20px;">
            <div id="my_position_badge" class="position-badge position-other">-</div>
            <div style="flex:1;">
              <div class="metric-row">
                <span class="metric-label">Mi Efectividad:</span>
                <span class="metric-value" id="my_efectividad">0%</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Mis Entregados:</span>
                <span class="metric-value" id="my_entregados">0</span>
              </div>
            </div>
          </div>
        </div>
       
        <div class="row" style="gap:20px; margin-top:16px;">
          <div style="flex:1;">
            <h4>Comparaci√≥n con el Promedio</h4>
            <div class="metric-card">
              <div class="metric-row">
                <span class="metric-label">Entregados:</span>
                <span>
                  <span id="my_vs_avg_entregados" class="metric-value">0</span>
                  <span id="my_vs_avg_entregados_diff" class="comparison-badge neutral">0%</span>
                </span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Encomiendas:</span>
                <span>
                  <span id="my_vs_avg_encomiendas" class="metric-value">0</span>
                  <span id="my_vs_avg_encomiendas_diff" class="comparison-badge neutral">0%</span>
                </span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Cancelados:</span>
                <span>
                  <span id="my_vs_avg_cancelados" class="metric-value">0</span>
                  <span id="my_vs_avg_cancelados_diff" class="comparison-badge neutral">0%</span>
                </span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Efectividad:</span>
                <span>
                  <span id="my_vs_avg_efectividad" class="metric-value">0%</span>
                  <span id="my_vs_avg_efectividad_diff" class="comparison-badge neutral">0%</span>
                </span>
              </div>
            </div>
          </div>
          <div style="flex:2;">
            <h4>Top 5 del Ranking</h4>
            <table class="ranking-table">
              <thead>
                <tr><th>Pos</th><th>Delivery</th><th>ENT</th><th>Efect.</th></tr>
              </thead>
              <tbody id="top5_tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- === FIN NUEVA PESTA√ëA === -->

  <!-- ========= NUEVO: PERFIL (todos los roles) ========= -->
  <section id="view-profile" class="hidden">
    <div class="card">
      <h3>Perfil</h3>
      <div class="note">Estos datos se usan para contacto y para <b>pago de comisiones</b>.</div>

      <div class="grid-2" style="margin-top:12px;">
        <!-- Datos personales -->
        <div class="card" style="flex:1;">
          <div class="box-title">Datos personales</div>

          <!-- === NUEVO: Foto de perfil (preview local) === -->
          <div class="row" style="gap:12px; align-items:flex-start; margin-bottom:8px;">
            <img id="pf_avatar" class="photo" src="https://via.placeholder.com/88x88?text=Foto" alt="Foto de perfil">
            <div>
              <label>Foto</label>
              <input id="pf_file" type="file" accept="image/*">
              <div class="muted">Formato JPG/PNG, m√°x. 2MB.</div>
            </div>
          </div>
          <!-- === FIN NUEVO === -->

          <label>Nombre</label><input id="pf_name" placeholder="Tu nombre">
          <label>Email (de sesi√≥n)</label><input id="pf_email" readonly>
          <label>Tel√©fono</label><input id="pf_phone" placeholder="+595...">
          <label>Documento (CI/RUC)</label><input id="pf_doc" placeholder="CI o RUC">
          <label>Direcci√≥n</label><input id="pf_addr" placeholder="Calle, N¬∞, Barrio, Ciudad">
        </div>

        <!-- Datos bancarios / Billetera -->
        <div class="card" style="flex:1;">
          <div class="box-title">Pago de comisiones</div>

          <div class="row" style="gap:10px;">
            <span class="chip">Banco</span>
            <span class="chip">o Billetera</span>
          </div>

          <label>Banco</label><input id="pf_bank_name" placeholder="Banco...">
          <label>Tipo de cuenta</label>
          <select id="pf_bank_type">
            <option value="">(seleccionar)</option>
            <option>CAJA DE AHORRO</option>
            <option>CUENTA CORRIENTE</option>
          </select>
          <label>N¬∞ de cuenta</label><input id="pf_bank_num" placeholder="000-000-000">
          <label>Titular</label><input id="pf_bank_holder" placeholder="Nombre y apellido del titular">
          <label>CI del titular</label><input id="pf_bank_holder_ci" placeholder="N¬∞ documento">

          <hr style="border:0;border-top:1px solid #2a2a3a; margin:12px 0;">

          <label>Proveedor billetera</label>
          <select id="pf_wallet_provider">
            <option value="">(ninguno)</option>
            <option>Tigo Money</option>
            <option>Personal</option>
            <option>Bancard/Payphone</option>
            <option>UENO</option>
            <option>Binance Pay</option>
          </select>
          <label>N¬∞ billetera / Alias</label><input id="pf_wallet_number" placeholder="Ej: 0981... / alias">
          <label>Titular billetera</label><input id="pf_wallet_holder" placeholder="Nombre del titular">
        </div>
      </div>

      <div class="row" style="margin-top:12px; gap:10px;">
        <button class="btn" onclick="saveProfile()">Guardar</button>
        <span class="badge">Solo actualiza tus datos. (ADMIN ver√° estos datos para pagos)</span>
      </div>
    </div>
  </section>
  <!-- ======== FIN PERFIL ======== -->

  <!-- üë• USUARIOS (solo ADMIN) -->
  <section id="view-users" class="hidden">
    <div class="card">
      <h3>üë• Gesti√≥n de Usuarios</h3>
     
      <!-- KPIs -->
      <div class="grid-5" style="margin:10px 0 12px;">
        <div class="kpi">
          <div class="kpi-title">Total usuarios</div>
          <div id="users_total" class="kpi-value">0</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">En l√≠nea</div>
          <div id="users_online" class="kpi-value">0</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Pendientes</div>
          <div id="users_pending" class="kpi-value">0</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Vendedores</div>
          <div id="users_vendors" class="kpi-value">0</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Delivery</div>
          <div id="users_delivery" class="kpi-value">0</div>
        </div>
      </div>
     
      <!-- Filtros -->
      <div class="row" style="gap:10px; margin-bottom:10px;">
        <input id="users_search" placeholder="üîé Buscar por nombre, email, rol..." style="flex:1;">
        <select id="users_filter_role">
          <option value="">Todos los roles</option>
          <option value="ADMIN">ADMIN</option>
          <option value="VENDEDOR">VENDEDOR</option>
          <option value="DELIVERY">DELIVERY</option>
          <option value="DESPACHANTE">DESPACHANTE</option>
          <option value="PROVEEDOR">PROVEEDOR</option>
          <option value="PENDIENTE">PENDIENTE</option>
        </select>
        <select id="users_filter_status">
          <option value="">Todos los estados</option>
          <option value="online">En l√≠nea</option>
          <option value="offline">Offline</option>
        </select>
        <button class="btn" onclick="loadUsers()">Filtrar</button>
        <button class="btn" onclick="exportUsers()">üìã Exportar</button>
      </div>
     
      <!-- Tabla de usuarios -->
      <div style="overflow:auto;">
        <table id="tblUsers" style="min-width:1000px;">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Registro</th>
              <th>Estado</th>
              <th>√öltima actividad</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="users_tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Toast -->
  <div id="toast" class="card hidden"></div>

  <!-- Modal Gu√≠a -->
  <div id="guideModal" class="modal">
    <div class="box">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h3>Vista previa de gu√≠a</h3>
        <button class="btn" onclick="closeGuide()">Cerrar</button>
      </div>
      <textarea id="guideText" rows="12" style="width:100%; margin:8px 0;" readonly>Cargando...</textarea>
      <button class="btn" onclick="downloadGuide()">Descargar PDF</button>
    </div>
  </div>

  <!-- Modal Reset Request -->
  <div id="resetReqModal" class="modal">
    <div class="box">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h3>Restablecer contrase√±a</h3>
        <button class="btn" onclick="closeResetRequest()">Cerrar</button>
      </div>
      <label>Email de tu cuenta</label>
      <input id="reset_email" placeholder="tu@email.com">
      <div class="row" style="margin-top:10px;">
        <button class="btn" onclick="submitResetRequest()">Enviar enlace</button>
      </div>
      <small class="badge">Si el email existe, te enviaremos un enlace v√°lido por 60 minutos.</small>
    </div>
  </div>

  <!-- Modal Set New Password -->
  <div id="resetSetModal" class="modal">
    <div class="box">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h3>Definir nueva contrase√±a</h3>
        <button class="btn" onclick="closeResetSet()">Cerrar</button>
      </div>
      <label>Nueva contrase√±a</label>
      <input id="reset_newpass" type="password" placeholder="Nueva contrase√±a">
      <label>Confirmar contrase√±a</label>
      <input id="reset_newpass2" type="password" placeholder="Confirmar">
      <div class="row" style="margin-top:10px;">
        <button class="btn" onclick="submitResetSet()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- === NUEVO: Modal Editar Producto === -->
  <div id="editProductModal" class="modal">
    <div class="box">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h3>Editar Producto</h3>
        <button class="btn" onclick="closeEditProductModal()">Cerrar</button>
      </div>
      <input type="hidden" id="edit_prod_id">
      <div class="row" style="gap:10px; margin-top:12px;">
        <div style="flex:1;">
          <label>T√≠tulo</label>
          <input id="edit_prod_title" placeholder="T√≠tulo del producto">
        </div>
        <div style="flex:1;">
          <label>SKU</label>
          <input id="edit_prod_sku" placeholder="SKU">
        </div>
      </div>
      <div class="row" style="gap:10px; margin-top:8px;">
        <div style="flex:1;">
          <label>Precio Proveedor (Gs)</label>
          <input id="edit_prod_price" type="number" placeholder="Precio">
        </div>
        <div style="flex:1;">
          <label>Stock</label>
          <input id="edit_prod_stock" type="number" placeholder="Stock">
        </div>
      </div>
      <div style="margin-top:8px;">
        <label>Imagen URL</label>
        <input id="edit_prod_img" placeholder="URL de la imagen">
      </div>
      <div style="margin-top:8px;">
        <label>Email del proveedor</label>
        <input id="edit_prod_provider" placeholder="proveedor@email.com">
      </div>
     
      <!-- NUEVO CAMPO: Vendedores autorizados -->
      <div style="margin-top:8px;">
        <label>Vendedores autorizados (opcional)</label>
        <input id="edit_prod_private_to" placeholder="vendedor1@email.com, vendedor2@email.com">
        <small class="badge">Separar con comas. Vac√≠o = visible para TODOS los vendedores</small>
      </div>
     
      <div class="row" style="margin-top:12px; gap:10px;">
        <button class="btn" onclick="saveProductEdit()">Guardar Cambios</button>
        <button class="btn danger" onclick="deleteCurrentProduct()">Eliminar Producto</button>
      </div>
    </div>
  </div>

  <!-- === NUEVO: Modal Editar Pedido === -->
  <div id="editOrderModal" class="modal">
    <div class="box">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h3>Editar Pedido</h3>
        <button class="btn" onclick="closeEditOrderModal()">Cerrar</button>
      </div>
      <input type="hidden" id="edit_order_id">
      <div class="row" style="gap:10px; margin-top:12px;">
        <div style="flex:1;">
          <label>Cliente</label>
          <input id="edit_order_customer" placeholder="Nombre del cliente">
        </div>
        <div style="flex:1;">
          <label>Tel√©fono</label>
          <input id="edit_order_phone" placeholder="Tel√©fono">
        </div>
      </div>
      <div class="row" style="gap:10px; margin-top:8px;">
        <div style="flex:1;">
          <label>Ciudad</label>
          <input id="edit_order_city" placeholder="Ciudad">
        </div>
        <div style="flex:1;">
          <label>Calle</label>
          <input id="edit_order_street" placeholder="Calle">
        </div>
      </div>
      <div class="row" style="gap:10px; margin-top:8px;">
        <div style="flex:1;">
          <label>Barrio</label>
          <input id="edit_order_district" placeholder="Barrio">
        </div>
        <div style="flex:1;">
          <label>Email</label>
          <input id="edit_order_email" placeholder="Email (opcional)">
        </div>
      </div>
      <div style="margin-top:8px;">
        <label>Observaci√≥n</label>
        <textarea id="edit_order_obs" rows="2" placeholder="Observaciones"></textarea>
      </div>
      <div class="row" style="margin-top:12px; gap:10px;">
        <button class="btn" onclick="saveOrderEdit()">Guardar Cambios</button>
        <button class="btn danger" onclick="deleteCurrentOrder()">Eliminar Pedido</button>
      </div>
    </div>
  </div>

  <!-- === PROBLEMA 4 RESUELTO: Modal para Pago Masivo (AGREGADO) === -->
  <div id="bulkProcessModal" class="modal">
    <div class="box">
      <h3>üîÑ Procesando pagos masivos</h3>
     
      <!-- Barra de progreso -->
      <div class="progress-bar">
        <div class="progress-fill" id="processProgress"></div>
      </div>
     
      <!-- Contadores -->
      <div class="row" style="gap: 15px; margin: 15px 0;">
        <span class="chip">‚úÖ <span id="successCount">0</span> exitosos</span>
        <span class="chip">‚ùå <span id="errorCount">0</span> fallados</span>
        <span class="chip">üìã <span id="totalCount">0</span> total</span>
      </div>
     
      <!-- Log -->
      <div class="process-log" id="processLog" style="max-height: 200px; overflow-y: auto;"></div>
     
      <!-- Botones -->
      <div class="row" style="margin-top: 20px; gap: 10px;">
        <button class="btn" onclick="pauseProcess()">‚è∏Ô∏è Pausar</button>
        <button class="btn danger" onclick="cancelProcess()">‚ùå Cancelar</button>
        <button class="btn" onclick="closeProcessModal()">Cerrar</button>
      </div>
    </div>
  </div>

<script>
  // =========================
  // Variables y helpers
  // =========================
  let me=null, products=[], deliveries=[], lastOrders=[], catalogMap={}, clientCityPrices=[];
  let CHART_BARS=null, CHART_PIE=null, CHART_GG=null, CHART_GP=null, CHART_RANKING=null;
  let guideOrderId=null;
  let rateMap = {}; let allRatesMap = {};
  const tokenKey='skyline_token';
  const emailKey='skyline_email';
  const nf = n=> {
    if (isNaN(Number(n)) || n === null || n === undefined) return '0';
    return new Intl.NumberFormat('es-PY').format(Number(n||0));
  };
  const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();

  const toast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2200); };
  const show = (name)=>{ ['auth','dashboard','products','order','orders','shopifyInbox','wallet','rates','news','chat','commissions','counter','closures','withGuides','rendicionesPagadas','profile','assignOrders','rankingDelivery','users']
      .forEach(v=>document.getElementById('view-'+v).classList.toggle('hidden', v!==name)); };

  // sello de √∫ltima actualizaci√≥n
  function timeStamp(){ const d=new Date(); return d.toLocaleString('es-PY'); }
  function markUpdated(){ const el=document.getElementById('lastUpdateText'); if (el) el.textContent=timeStamp(); }

  function setUserBoxUI(user){
    const box=document.getElementById('userBox');
    box.innerHTML=user?`<span class="chip">${user.email}</span><button class="btn" onclick="logout()">Salir</button>`:'';
  }
 
  // === MODIFICADO: PROVEEDOR ahora ve Pago de comisiones, Cierres y Asignar Pedidos ===
  function setNavForAuth(isAuthed, role){
    const vis=(id,ok)=>document.getElementById(id).classList.toggle('hidden', !ok);
    vis('navLogin', !isAuthed);
   
    // === MODIFICACI√ìN: DESPACHANTE sin 4 pesta√±as ===
    if (role === 'DESPACHANTE') {
      vis('navDash', false);        // ‚ùå NO mostrar Dashboard
      vis('navRates', false);       // ‚ùå NO mostrar Costos delivery
      vis('navWallet', false);      // ‚ùå NO mostrar Wallet
      vis('navProfile', false);     // ‚ùå NO mostrar Perfil
    } else {
      vis('navDash', isAuthed);
      vis('navRates', isAuthed);
      vis('navWallet', isAuthed);
      vis('navProfile', isAuthed);
    }
   
    // El resto queda igual...
    vis('navNews', isAuthed);
   vis('navChat', isAuthed);

    // === NUEVO: bot√≥n visible solo para ADMIN y DESPACHANTE
    vis('navWithGuides', isAuthed && (role==='ADMIN' || role==='DESPACHANTE' || role==='PROVEEDOR'));

    // === NUEVO: Pesta√±a Ranking Delivery para roles espec√≠ficos
    vis('navRanking', isAuthed && (role==='PROVEEDOR' || role==='DELIVERY' ||
        role==='ADMIN' || role==='DESPACHANTE'));

    vis('navOrders', isAuthed);
    
    // üõí Shopify Inbox (solo VENDEDOR)
    vis('navShopifyInbox', isAuthed && role==='VENDEDOR');
vis('navProd', isAuthed && role!=='DELIVERY');
    vis('navOrder', isAuthed && role==='VENDEDOR');
   
    // === MODIFICADO: PROVEEDOR tambi√©n ve Pago de comisiones
    vis('navComms', isAuthed && (role==='ADMIN' || role==='PROVEEDOR' || role==='VENDEDOR'));
   
    vis('navCounter', isAuthed && role==='ADMIN');
   
    // === MODIFICADO: PROVEEDOR tambi√©n ve Cierres
    vis('navClosures', isAuthed && (role==='ADMIN' || role==='PROVEEDOR'));

    // === NUEVO: Rendiciones pagadas
    vis('navRendPaid', isAuthed && (role==='ADMIN' || role==='PROVEEDOR'));

    // ===== NUEVO: ASIGNAR PEDIDOS para ADMIN, PROVEEDOR y DELIVERY =====
    vis('navAssign', isAuthed && (role==='ADMIN' || role==='PROVEEDOR' || role==='DELIVERY'));
   
    // ===== NUEVO: USUARIOS solo para ADMIN =====
    vis('navUsers', isAuthed && role==='ADMIN');
   
    // ===== NUEVO: PERFIL para TODOS (ya manejado arriba con la condici√≥n especial para DESPACHANTE) =====
   
    // === NUEVO: Mostrar barra de impresi√≥n masiva solo para ADMIN, DESPACHANTE, PROVEEDOR ===
    const bulkHeader = document.getElementById('bulkActionsHeader');
    if (bulkHeader) {
      if (isAuthed && (role==='ADMIN' || role==='DESPACHANTE' || role==='PROVEEDOR')) {
        bulkHeader.classList.remove('hidden');
      } else {
        bulkHeader.classList.add('hidden');
      }
    }
  }
 
  const openLogin = ()=>{ me=null; setUserBoxUI(null); setNavForAuth(false); document.getElementById('roleChip').textContent='';
    show('auth');
    // precargar email recordado
    const saved = localStorage.getItem(emailKey)||''; if (saved){ li_email.value=saved; li_saveemail.checked=true; }
  };

  // =========================
  // Auth
  // =========================
  function onRegister(){
    google.script.run.withSuccessHandler(()=>{ toast('Cuenta creada. Inicia sesi√≥n.'); li_email.value = re_email.value.trim(); })
      .withFailureHandler(e=>toast(e.message||e))
      .register(re_name.value.trim(), re_email.value.trim(), re_pass.value, re_role.value);
  }
  function onLogin(){
    const remember = !!document.getElementById('li_remember').checked;
    const rememberEmail = !!document.getElementById('li_saveemail').checked;
    if (rememberEmail) localStorage.setItem(emailKey, (li_email.value||'').trim());
    else localStorage.removeItem(emailKey);

    google.script.run.withSuccessHandler(res=>{
        localStorage.setItem(tokenKey, res.session.token);
        init();
      })
      .withFailureHandler(e=>toast(e.message||e))
      .login(li_email.value.trim(), li_pass.value, remember);
  }
  function logout(){ localStorage.removeItem(tokenKey); openLogin(); }

  // =========================
  // Funci√≥n unificada para actualizar estado de pedidos
  // =========================
  function updateOrderStatusUnified(selectElement, successCallback) {
    const id = selectElement.getAttribute('data-id');
    const newStatus = selectElement.value;
    const tok = localStorage.getItem(tokenKey);
   
    if (!id || !newStatus) return;
   
    // Deshabilitar y mostrar estado "cargando"
    selectElement.disabled = true;
    selectElement.classList.add('updating');
    const previousStatus = selectElement.dataset.previous || selectElement.value;
   
    google.script.run
      .withSuccessHandler(() => {
        selectElement.disabled = false;
        selectElement.classList.remove('updating');
        selectElement.classList.add('success-flash');
        setTimeout(() => selectElement.classList.remove('success-flash'), 800);
        selectElement.dataset.previous = newStatus;
        toast('‚úÖ Estado actualizado');
       
        // Ejecutar callback personalizado si existe
        if (typeof successCallback === 'function') {
          successCallback();
        }
       
        // Actualizaciones globales
        refreshDashboard();
        refreshWallet();
      })
      .withFailureHandler((error) => {
        selectElement.disabled = false;
        selectElement.classList.remove('updating');
        selectElement.classList.add('error-flash');
        setTimeout(() => selectElement.classList.remove('error-flash'), 800);
        selectElement.value = previousStatus;
        toast('‚ùå Error: ' + (error.message || error));
      })
      .updateOrderStatus(tok, id, newStatus, '');
  }

  // =========================
  // Init
  // =========================
  function init(){
    const tok=localStorage.getItem(tokenKey);
    google.script.run.withSuccessHandler(res=>{
      if (!res.authenticated){ openLogin(); return; }
      me=res.user; setUserBoxUI(me); setNavForAuth(true, me.role);
      document.getElementById('roleChip').textContent = me.role;

      const today=new Date(); const ymd=d=>d.toISOString().slice(0,10); const d7=new Date(today.getTime()-6*24*3606*1000);
      ['dash_from','of_from','pc_from','pg_from','as_from'].forEach(id=>{ const el=document.getElementById(id); if (el) el.value = ymd(d7); });
      ['dash_to','of_to','pc_to','pg_to','as_to'].forEach(id=>{ const el=document.getElementById(id); if (el) el.value = ymd(today); });
      ['cl_from','cl_to'].forEach(id=>{ const el=document.getElementById(id); if (el) el.value = ymd(today); });

      // Inicializar fechas para ranking
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      const rankFrom = document.getElementById('rank_from');
      const rankTo = document.getElementById('rank_to');
      if (rankFrom) rankFrom.value = weekAgo.toISOString().slice(0, 10);
      if (rankTo) rankTo.value = today.toISOString().slice(0, 10);

      if (me.role==='DELIVERY'){
        document.getElementById('kpi5_title').textContent='Monto a rendir (Gs)';
        document.getElementById('th_comm').textContent='Tarifa repartidor (Gs)';
        document.getElementById('kpiSumEntregadoRow').classList.remove('hidden');
      } else {
        document.getElementById('th_comm').textContent='Monto a comisionar (Gs)';
      }
     
      // === NUEVO: Mostrar KPIs espec√≠ficos para PROVEEDOR ===
      if (me.role === 'PROVEEDOR') {
        document.getElementById('providerKPIs').classList.remove('hidden');
        document.getElementById('normalKPIs').classList.add('hidden');
        document.getElementById('debugProviderBtn').classList.remove('hidden');
      } else {
        document.getElementById('providerKPIs').classList.add('hidden');
        document.getElementById('normalKPIs').classList.remove('hidden');
        document.getElementById('debugProviderBtn').classList.add('hidden');
      }
     
      document.getElementById('guideBlocks')?.classList.toggle('hidden', me.role!=='DESPACHANTE');

      // === NUEVO: Mostrar/ocultar secciones seg√∫n rol ===
      // Mostrar secci√≥n de comisiones pendientes
      document.getElementById('pendingCommissionsSection')?.classList.toggle('hidden',
          !(me.role === 'ADMIN' || me.role === 'PROVEEDOR'));
     
      // Mostrar secci√≥n de ganancia delivery
      document.getElementById('deliveryProfitSection')?.classList.toggle('hidden',
          me.role !== 'DELIVERY');
     
      // Mostrar filtros avanzados
      document.getElementById('advancedFiltersSection')?.classList.toggle('hidden',
          !(me.role === 'ADMIN' || me.role === 'DESPACHANTE' || me.role === 'PROVEEDOR'));
     
      // === NUEVO: CONFIGURAR PAGOS DE COMISIONES SEG√öN ROL ===
      if (me?.role === 'VENDEDOR') {
        document.getElementById('navComms').textContent = 'üí∞ Mis Comisiones';
        document.getElementById('navComms').onclick = function() {
          show('commissions');
          loadCommissionsForVendor();
        };
      }
     
      // === NUEVO: MOSTRAR CONTROL DE RENDICI√ìN SOLO PARA PROVEEDOR/ADMIN ===
      const rendicionBox = document.getElementById('rendicionControlBox');
      if (rendicionBox) {
        rendicionBox.classList.toggle('hidden', !(me?.role === 'PROVEEDOR' || me?.role === 'ADMIN'));
      }

      loadCatalog();
      buildCityDropdown();
      refreshOrders();
      loadRates();
      loadClientPrices();
      refreshDashboard();
      refreshWallet();
     
      // === CORRECCI√ìN CR√çTICA: PROVEEDOR tambi√©n necesita ver repartidores ===
      if (me.role==='ADMIN' || me.role==='PROVEEDOR'){
        google.script.run.withSuccessHandler(ds=>{
          const sel = document.getElementById('cl_delivery');
          const asSel = document.getElementById('as_delivery'); // NUEVO: selector para asignaci√≥n masiva
          if (sel){
            const opts = ['<option value="">Todos los repartidores</option>']
              .concat((ds||[]).map(d=>`<option value="${(d.email||'').toLowerCase()}">${d.name||d.email}</option>`));
            sel.innerHTML = opts.join('');
          }
          if (asSel) {
            const opts = ['<option value="">Seleccionar delivery...</option>']
              .concat((ds||[]).map(d=>`<option value="${(d.email||'').toLowerCase()}">${d.name||d.email}</option>`));
            asSel.innerHTML = opts.join('');
          }
        }).withFailureHandler(()=>{}).listUsersByRole(tok,'DELIVERY');
      }

      // preparar b√∫squeda en vivo
      wireSearchInputs();
      // b√∫squeda productos en vivo
      wireProductSearch();

      // === NUEVO: b√∫squeda en vivo vista Pedidos con gu√≠as
      wirePendingGuidesSearch();
     
      // === NUEVO: b√∫squeda en vivo vista Asignar Pedidos
      wireAssignSearch();

      // === NUEVO: al cambiar delivery en Cierres, refrescar todo (KPIs + Control de Rendici√≥n)
      document.getElementById('cl_delivery')?.addEventListener('change', ()=>{ loadClosures(); });
      // === AGREGADO: Cargar proveedores en filtros ===
      if (me.role === 'ADMIN' || me.role === 'DESPACHANTE' || me.role === 'PROVEEDOR') {
        loadProvidersForFilters();
    loadVendorsForCommissionsFilter(); // Cargar proveedores en filtros
      }
     
      // === NUEVO: Cargar proveedores para filtro de gu√≠as ===
      // (Para PROVEEDOR se deshabilita el select autom√°ticamente)
      if (me?.role === 'DESPACHANTE' || me?.role === 'ADMIN' || me?.role === 'PROVEEDOR') {
        loadProvidersForGuidesFilter();
      }

      // === NUEVO: Cargar delivery para Rendiciones pagadas ===
      if (me?.role === 'ADMIN' || me?.role === 'PROVEEDOR') {
        loadDeliveriesForRendicionesPagadas();
      }
     
      // === NUEVO: CARGAR PROVEEDORES EN FILTRO DE RANKING ===
      if (me?.role === 'PROVEEDOR' || me?.role === 'ADMIN' || me?.role === 'DESPACHANTE') {
        loadProvidersForRankingFilter();
      }

      markUpdated();
      show('dashboard');

      const b=document.getElementById('btnAddProduct');
      // === MODIFICADO: PROVEEDOR tambi√©n puede agregar productos ===
      if (b) b.classList.toggle('hidden', !(me.role==='ADMIN' || me.role==='PROVEEDOR'));
     
      // === MODIFICADO: Ocultar bulk actions si no es ADMIN o PROVEEDOR ===
      const bulk = document.getElementById('bulkActions');
      if (bulk) bulk.classList.toggle('hidden', !(me.role==='ADMIN' || me.role==='PROVEEDOR'));

      // === NUEVO: Mostrar secci√≥n de tarifas para PROVEEDOR ===
      const ratesAdminBox = document.getElementById('ratesAdminBox');
      if (ratesAdminBox) ratesAdminBox.classList.toggle('hidden', !(me.role==='ADMIN' || me.role==='PROVEEDOR'));

      // === NUEVO: Mostrar caja de asignaci√≥n masiva solo para ADMIN/PROVEEDOR ===
      const adminAssignBox = document.getElementById('adminAssignBox');
      if (adminAssignBox) adminAssignBox.classList.toggle('hidden', !(me.role==='ADMIN' || me.role==='PROVEEDOR'));

      // === NUEVO: Inicializar contador de selecci√≥n ===
      initSelectionCounter();

      // === NUEVO: Cargar datos adicionales ===
      if (me.role === 'ADMIN' || me.role === 'PROVEEDOR') {
        loadPendingCommissionsKPIs();
      }
      if (me.role === 'DELIVERY') {
        loadDeliveryProfit();
      }

      // === NUEVO: Cargar favoritos del usuario ===
      loadFavorites();
     
      // === NUEVO: Auto-completar email del proveedor si es PROVEEDOR ===
      if (me?.role === 'PROVEEDOR') {
        const providerEmailInput = document.getElementById('np_provider_email');
        const editProviderEmailInput = document.getElementById('edit_prod_provider');
       
        if (providerEmailInput) {
          providerEmailInput.value = me.email;
          providerEmailInput.readOnly = true;
          providerEmailInput.style.backgroundColor = '#2a2a40';
        }
       
        if (editProviderEmailInput) {
          editProviderEmailInput.value = me.email;
          editProviderEmailInput.readOnly = true;
          editProviderEmailInput.style.backgroundColor = '#2a2a40';
        }
      }

    }).me(tok);

    try{
      const params = new URLSearchParams(location.search);
      const resetTok = params.get('reset');
      if (resetTok){ window._pendingResetToken = resetTok; openResetSet(); }
    }catch(e){}

    document.getElementById('navClosures')?.addEventListener('click', ()=>{
      loadRates(); refreshOrders(); loadClosures();
    });

    // === NUEVO: al cambiar delivery/fecha en Cierres, refrescar Control de Rendici√≥n ===
    try {
      const clDel = document.getElementById('cl_delivery');
      if (clDel && !clDel._rendicionWired) {
        clDel._rendicionWired = true;
        clDel.addEventListener('change', ()=>{
          loadClosures();
        });
      }
      const clFrom = document.getElementById('cl_from');
      if (clFrom && !clFrom._rendicionWired) {
        clFrom._rendicionWired = true;
        clFrom.addEventListener('change', ()=>{
          loadClosures();
        });
      }
    } catch(e) {}
  }

  // =========================
  // === FUNCI√ìN PARA CARGAR PROVEEDORES EN FILTROS ===
  // =========================
  function loadProvidersForFilters() {
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;
   
    console.log('Cargando proveedores para filtros...');
   
    google.script.run
      .withSuccessHandler(providers => {
        console.log('Proveedores recibidos:', providers);
       
        // Cargar proveedores (solo esto)
        const select = document.getElementById('filter_provider');
        const pgSelect = document.getElementById('pg_filter_provider');
        const commSelect = document.getElementById('comm_filter_provider');
       
        if (select || pgSelect || commSelect) {
          let options = '<option value="">Todos los proveedores</option>';
          if (providers && providers.length > 0) {
            // Ordenar alfab√©ticamente por email
            providers.sort((a, b) => {
              const emailA = (a.email || '').toLowerCase();
              const emailB = (b.email || '').toLowerCase();
              return emailA.localeCompare(emailB);
            });
           
            options += providers.map(p =>
              `<option value="${p.email}">${p.name || 'Sin nombre'} (${p.email})</option>`
            ).join('');
          }
         
          if (select) select.innerHTML = options;
          if (pgSelect) pgSelect.innerHTML = options;
          if (commSelect) commSelect.innerHTML = options;
        }
       
        toast('‚úÖ Filtros de proveedor cargados');
      })
      .withFailureHandler(e => {
        console.error('Error cargando proveedores:', e);
        toast('‚ùå Error: ' + e.message);
      })
      .listUsersByRole(tok, 'PROVEEDOR');
  }

  // ===== NUEVA FUNCI√ìN: Cargar proveedores para filtro de gu√≠as =====
  function loadProvidersForGuidesFilter() {
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;
    google.script.run
      .withSuccessHandler(providers => {
        const select = document.getElementById('pg_filter_provider');
        if (!select) return;

        let options = '<option value="">Todos los proveedores</option>';
        if (providers && providers.length > 0) {
          providers.sort((a, b) => (a.email || '').toLowerCase().localeCompare((b.email || '').toLowerCase()));
          options += providers.map(p => `<option value="${p.email}">${p.name || 'Sin nombre'} (${p.email})</option>`).join('');
        }
        select.innerHTML = options;

        // Si el usuario es PROVEEDOR, fijar su correo y bloquear el selector
        try {
          if (window.me && me?.role === 'PROVEEDOR') {
            select.value = me.email;
            select.disabled = true;
          } else {
            select.disabled = false;
          }
        } catch(e) {}
      })
      .withFailureHandler(e => console.error('Error cargando proveedores:', e))
      .listUsersByRole(tok, 'PROVEEDOR');
  }

  // ===== NUEVO: Cargar vendedores para filtro de comisiones (ADMIN/PROVEEDOR) =====
  function loadVendorsForCommissionsFilter() {
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;
    google.script.run
      .withSuccessHandler(users => {
        const sel = document.getElementById('pc_vendor_admin');
        if (!sel) return;
        let opt = '<option value="">Todos los vendedores</option>';
        (users || []).sort((a,b)=>String(a.email||'').toLowerCase().localeCompare(String(b.email||'').toLowerCase()));
        opt += (users || []).map(u => `<option value="${u.email}">${u.name || 'Sin nombre'} (${u.email})</option>`).join('');
        sel.innerHTML = opt;
      })
      .withFailureHandler(e => console.error('Error cargando vendedores:', e))
      .listUsersByRole(tok, 'VENDEDOR');
  }

  // ===== NUEVA FUNCI√ìN: Cargar proveedores para filtro de ranking =====
  function loadProvidersForRankingFilter() {
    const tok = localStorage.getItem(tokenKey);
    google.script.run
      .withSuccessHandler(providers => {
        const select = document.getElementById('rank_provider');
        if (select) {
          let options = '<option value="">Todos los proveedores</option>';
          if (providers && providers.length > 0) {
            options += providers.map(p =>
              `<option value="${p.email}">${p.name || p.email}</option>`
            ).join('');
          }
          select.innerHTML = options;
        }
      })
      .withFailureHandler(e => console.error('Error:', e))
      .listUsersByRole(tok, 'PROVEEDOR');
  }

  // ===== NUEVO: Cargar deliveries para Rendiciones pagadas =====
  function loadDeliveriesForRendicionesPagadas() {
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;
    google.script.run
      .withSuccessHandler(users => {
        const sel = document.getElementById('rp_delivery');
        if (!sel) return;
        let opt = '<option value="">Todos los delivery</option>';
        (users || []).sort((a,b)=>String(a.email||'').toLowerCase().localeCompare(String(b.email||'').toLowerCase()));
        opt += (users || []).map(u => `<option value="${u.email}">${u.name || u.email} (${u.email})</option>`).join('');
        sel.innerHTML = opt;
      })
      .withFailureHandler(e => console.error('Error cargando delivery:', e))
      .listUsersByRole(tok, 'DELIVERY');
  }

  // ===== NUEVO: Cargar tabla Rendiciones pagadas =====
  function loadRendicionesPagadas() {
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;
    const deliveryEmail = document.getElementById('rp_delivery')?.value || '';
    const desde = document.getElementById('rp_from')?.value || '';
    const hasta = document.getElementById('rp_to')?.value || '';

    google.script.run
      .withSuccessHandler(rows => {
        const tb = document.getElementById('rp_tbody');
        if (!tb) return;
        tb.innerHTML = '';
        (rows || []).forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.delivery_email || ''}</td>
            <td>${r.fecha_rendicion || ''}</td>
            <td class="right">${nf(r.monto_total || 0)}</td>
            <td>${r.nota || ''}</td>
            <td>${r.marcado_por || ''}</td>
            <td>${r.marcado_en ? new Date(r.marcado_en).toLocaleString('es-PY') : ''}</td>
            <td>${r.pagado_en ? new Date(r.pagado_en).toLocaleString('es-PY') : ''}</td>
          `;
          tb.appendChild(tr);
        });
        toast(`‚úÖ ${rows?.length || 0} rendiciones`);
      })
      .withFailureHandler(e => toast('‚ùå Error: ' + (e.message || e)))
      .getRendicionesPagadas(tok, deliveryEmail, desde, hasta);
  }

  // =========================
  // üí¨ Chat (DM + Online + Le√≠do)
  // =========================
  let chatSelectedKey = '';
  let chatPeerEmail = '';
  let chatPollTimer = null;
  let chatPingTimer = null;

  function _threadKey(a,b){
    a = String(a||'').trim().toLowerCase();
    b = String(b||'').trim().toLowerCase();
    if(!a || !b) return '';
    return (a < b) ? (a + '|' + b) : (b + '|' + a);
  }

  function loadChat(){
    loadChatContacts();
    loadChatThreads();

    if (!chatPingTimer){
      chatPingTimer = setInterval(()=>{ chatPing(); }, 15000);
      chatPing();
    }
    if (!chatPollTimer){
      chatPollTimer = setInterval(()=>{
        loadChatThreads(true);
        if (chatSelectedKey) loadChatMessages(true);
      }, 5000);
    }

    if (!chatSelectedKey){
      const title = document.getElementById('chatThreadTitle');
      if (title) title.textContent = 'Seleccione un destinatario';
      const pres = document.getElementById('chatPresence');
      if (pres) pres.textContent = '‚Äî';
      const box = document.getElementById('chatMessages');
      if (box) box.innerHTML = '<span class="badge">Eleg√≠ un destinatario para empezar.</span>';
    }
  }

  function loadChatContacts(){
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;

    google.script.run
      .withSuccessHandler(list=>{
        const sel = document.getElementById('chatToSelect');
        if (!sel) return;

        let html = '<option value="">-- Elegir destinatario --</option>';
        (list||[]).forEach(u=>{
          const label = `${u.role} ¬∑ ${u.name || u.email} (${u.email})`;
          html += `<option value="${u.email}">${label}</option>`;
        });
        sel.innerHTML = html;

        if (chatPeerEmail){
          sel.value = chatPeerEmail;
        }
      })
      .withFailureHandler(e=>toast('‚ùå Chat contactos: ' + (e.message||e)))
      .listChatContacts(tok);
  }

  function startChatWithSelected(){
    const sel = document.getElementById('chatToSelect');
    const email = String(sel?.value || '').trim().toLowerCase();
    if (!email) return;
    startChatWith(email);
  }

  function startChatWith(email){
    chatPeerEmail = String(email||'').trim().toLowerCase();
    chatSelectedKey = _threadKey(me?.email, chatPeerEmail);

    const title = document.getElementById('chatThreadTitle');
    if (title) title.textContent = chatPeerEmail;

    loadChatMessages();
    loadChatThreads(true);
  }

  function loadChatThreads(silent=false){
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;

    google.script.run
      .withSuccessHandler(threads=>{
        const box = document.getElementById('chatThreads');
        if (!box) return;
        box.innerHTML = '';

        (threads||[]).forEach(t=>{
          const peer = t.peer_email || '';
          const unread = Number(t.unread||0);

          const btn = document.createElement('button');
          btn.className = 'btn small';
          btn.style.cssText = 'width:100%; text-align:left; margin-bottom:6px; display:flex; justify-content:space-between; gap:8px;';

          const left = document.createElement('span');
          left.textContent = peer;

          const right = document.createElement('span');
          right.className = 'badge';
          right.style.opacity = unread ? '1' : '0.55';
          right.textContent = unread ? `Nuevo (${unread})` : 'OK';

          btn.appendChild(left);
          btn.appendChild(right);

          btn.onclick = ()=>{
            chatPeerEmail = peer.toLowerCase();
            chatSelectedKey = t.thread_key;
            const sel = document.getElementById('chatToSelect');
            if (sel) sel.value = chatPeerEmail;
            const title = document.getElementById('chatThreadTitle');
            if (title) title.textContent = peer;
            loadChatMessages();
          };

          box.appendChild(btn);
        });

        if (!silent) toast('‚úÖ Chat actualizado');
      })
      .withFailureHandler(e=>{ if(!silent) toast('‚ùå Chat hilos: ' + (e.message||e)); })
      .listChatThreads(tok);
  }

  function loadChatMessages(silent=false){
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;
    if (!chatSelectedKey){
      const box = document.getElementById('chatMessages');
      if (box) box.innerHTML = '<span class="badge">Eleg√≠ un destinatario para empezar.</span>';
      return;
    }

    google.script.run
      .withSuccessHandler(res=>{
        const box = document.getElementById('chatMessages');
        if (!box) return;

        const peerOnline = !!res.peer_online;
        const lastSeen = res.peer_last_seen_at ? new Date(res.peer_last_seen_at).toLocaleString('es-PY') : '';
        const pres = document.getElementById('chatPresence');
        if (pres){
          pres.textContent = peerOnline ? 'üü¢ En l√≠nea' : (lastSeen ? ('‚ö™ √ölt. vez: ' + lastSeen) : '‚ö™ Desconectado');
        }

        const peerLastReadMs = res.peer_last_read_at ? new Date(res.peer_last_read_at).getTime() : 0;

        box.innerHTML = '';
        (res.messages || []).forEach(m=>{
          const mine = String(m.from_email||'').toLowerCase() === String(me?.email||'').toLowerCase();

          const wrap = document.createElement('div');
          wrap.style.cssText = `margin:8px 0; display:flex; justify-content:${mine ? 'flex-end' : 'flex-start'};`;

          const bubble = document.createElement('div');
          bubble.className = 'card';
          bubble.style.cssText = `max-width:75%; padding:10px; border-radius:14px; border:1px solid #2a2a40;`;

          const who = document.createElement('div');
          who.className = 'badge';
          who.textContent = (m.from_role || '') + ' ¬∑ ' + (m.from_email || '');

          const txt = document.createElement('div');
          txt.style.marginTop = '6px';
          txt.textContent = m.message_text || '';

          bubble.appendChild(who);
          bubble.appendChild(txt);

          if (m.attachment_url){
            const a = document.createElement('a');
            a.href = m.attachment_url;
            a.target = '_blank';
            a.textContent = 'üìé ' + (m.attachment_name || 'archivo');
            a.style.display = 'block';
            a.style.marginTop = '8px';
            bubble.appendChild(a);
          }

          const ts = document.createElement('div');
          ts.style.cssText = 'margin-top:6px; font-size:11px; color:var(--muted); display:flex; justify-content:space-between; gap:10px;';
          const left = document.createElement('span');
          left.textContent = m.created_at ? new Date(m.created_at).toLocaleString('es-PY') : '';

          const right = document.createElement('span');
          if (mine){
            const sentMs = m.created_at ? new Date(m.created_at).getTime() : 0;
            right.textContent = peerLastReadMs && sentMs && (peerLastReadMs >= sentMs) ? '‚úì‚úì' : '‚úì';
          } else {
            right.textContent = '';
          }

          ts.appendChild(left);
          ts.appendChild(right);
          bubble.appendChild(ts);

          wrap.appendChild(bubble);
          box.appendChild(wrap);
        });

        box.scrollTop = box.scrollHeight;

        google.script.run.withFailureHandler(()=>{}).markChatRead(tok, chatSelectedKey);

        if (!silent) toast('‚úÖ Mensajes cargados');
      })
      .withFailureHandler(e=>{ if(!silent) toast('‚ùå Chat mensajes: ' + (e.message||e)); })
      .listChatMessages(tok, chatSelectedKey);
  }

  function sendChat(){
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;
    if (!chatPeerEmail){
      toast('Seleccione un destinatario');
      return;
    }

    const textEl = document.getElementById('chatText');
    const fileEl = document.getElementById('chatFile');
    const text = (textEl?.value || '').trim();
    const file = fileEl?.files && fileEl.files[0] ? fileEl.files[0] : null;

    const payload = { to_email: chatPeerEmail, message_text: text };

    const sendPayload = (pl)=>{
      google.script.run
        .withSuccessHandler(()=>{
          if (textEl) textEl.value = '';
          if (fileEl) fileEl.value = '';
          loadChatMessages(true);
          loadChatThreads(true);
          toast('‚úÖ Mensaje enviado');
        })
        .withFailureHandler(e=>toast('‚ùå Chat: ' + (e.message || e)))
        .sendChatMessage(tok, pl);
    };

    if (!file){
      sendPayload(payload);
      return;
    }

    const reader = new FileReader();
    reader.onload = ()=>{
      const dataUrl = String(reader.result || '');
      const b64 = dataUrl.split(',')[1] || '';
      payload.attachment_base64 = b64;
      payload.attachment_name = file.name;
      payload.attachment_mime = file.type || 'application/octet-stream';
      sendPayload(payload);
    };
    reader.onerror = ()=>toast('‚ùå No se pudo leer el archivo');
    reader.readAsDataURL(file);
  }

  function chatPing(){
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;
    google.script.run.withFailureHandler(()=>{}).chatPing(tok);
  }


  // =========================
  // Refresco suave (sin cerrar sesi√≥n)
  // =========================
  function softRefresh(){
    refreshOrders();
    refreshDashboard();
    refreshWallet();
    loadRates();
    loadClientPrices();

    // === NUEVO: re-render vista Pedidos con gu√≠as
    renderPendingGuidesSimplified();

    markUpdated();
    toast('Actualizado');
  }

  // =========================
  // Cat√°logo / Productos
  // =========================
  function loadCatalog(){
    const tok=localStorage.getItem(tokenKey);
    const stat=document.getElementById('catalogStatus'); if (stat) stat.textContent='Cargando cat√°logo...';
    google.script.run.withSuccessHandler(rows=>{
      products=rows; catalogMap={};
     
      if (rows && rows.length > 0) {
        rows.forEach(p=>catalogMap[(p.sku||'').trim()]=p);
      }

      // === render tabla (lo que ya ten√≠as)
      const tb=document.querySelector('#tblProducts tbody'); if (tb){ tb.innerHTML='';
        rows.forEach(p=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td><img class="thumb" src="${p.image_url||''}" onerror="this.src='https://via.placeholder.com/64'"></td>
            <td>${p.title}</td><td>${p.sku}</td><td class="right">${nf(p.provider_price_gs)}</td><td class="right">${p.stock}</td>
            <td>${p.provider_email || ''}</td>
            <td class="action-buttons">
              ${(me.role==='ADMIN' || me.role==='DESPACHANTE' || me.role==='PROVEEDOR') ?
                `<button class="btn small warning" onclick="openEditProductModal('${p.id}')">Editar</button>
                 <button class="btn small danger" onclick="deleteProduct('${p.id}')">Eliminar</button>` :
                ''}
            </td>`;
          tb.appendChild(tr);
        });
      }
      if (stat) stat.textContent='Cat√°logo cargado';

      // === NUEVO: render cards
      renderProductCards();

      // si est√°s en "Cargar pedido", inicializar items
      const box=document.getElementById('itemsBox'); if (box){ if(!box.children.length){ addItemRow(); } recalcOrder(); }
      markUpdated();
    }).withFailureHandler(e=>toast(e.message||e)).listProducts(tok);
  }

  // === NUEVO: Variables para tabs de productos ===
  let currentProductTab = 'general';
  let userFavorites = [];

  // === NUEVO: Cargar favoritos del localStorage ===
  function loadFavorites() {
    if (me && me.email) {
      const favs = localStorage.getItem(`favorites_${me.email}`);
      userFavorites = favs ? JSON.parse(favs) : [];
    } else {
      userFavorites = [];
    }
  }

  // === NUEVO: Cambiar tab de productos ===
  function switchProductTab(tab){
    currentProductTab = tab;
   
    // Actualizar botones activos
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.textContent.includes(
        tab === 'general' ? 'General' :
        tab === 'favoritos' ? 'Favoritos' : 'Privados'
      )) {
        btn.classList.add('active');
      }
    });
   
    // Re-renderizar productos
    renderProductCards();
  }

  // === NUEVO: Toggle favorito ===
  function toggleFavorite(sku) {
    if (!me || !me.email) return;
   
    const index = userFavorites.indexOf(sku);
    if (index === -1) {
      userFavorites.push(sku);
    } else {
      userFavorites.splice(index, 1);
    }
   
    // Guardar en localStorage
    localStorage.setItem(`favorites_${me.email}`, JSON.stringify(userFavorites));
   
    // Re-renderizar si estamos en tab de favoritos
    renderProductCards();
  }

  // === NUEVO: b√∫squeda en vivo de productos (cards)
  function wireProductSearch(){
    const q=document.getElementById('prod_q'); if (!q) return;
    let t=null;
    const trigger=()=>{ clearTimeout(t); t=setTimeout(renderProductCards, 160); };
    // q.addEventListener('input', trigger); // desactivado: usar bot√≥n Filtrar
    q.addEventListener('keyup', (e)=>{ if (e.key==='Enter') renderProductCards(); });
  }

  // === NUEVO: renderizador de cards con tabs ===
  function renderProductCards(){
    const grid=document.getElementById('prodGrid'); if (!grid) return;
    const q=(document.getElementById('prod_q')?.value||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
   
    // Filtrar por tab actual
    let filtered = products || [];
   
    if (currentProductTab === 'favoritos') {
      filtered = filtered.filter(p => userFavorites.includes(p.sku));
    } else if (currentProductTab === 'privados') {
      filtered = filtered.filter(p => {
        const providerField = p.provider_email || '';
        const allowedEmails = providerField.split(',').map(e => e.trim().toLowerCase());
        return allowedEmails.includes(me.email.toLowerCase());
      });
    }
   
    // Filtrar por b√∫squeda
    if (q) {
      filtered = filtered.filter(p=>{
        const hay=[p.title||'', p.sku||'', p.provider_email||''].join(' ').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        return hay.includes(q);
      });
    }

    grid.innerHTML='';
    filtered.forEach(p=>{
      const isFavorite = userFavorites.includes(p.sku);
      const div=document.createElement('div');
      div.className='prod-card';
     
      // === CORREGIDO: HTML mejorado para la tarjeta de producto ===
      div.innerHTML = `
        <img class="prod-img" src="${p.image_url||''}" onerror="this.src='https://via.placeholder.com/400x320?text=Sin+imagen'">
        <div class="prod-body">
          <div class="prod-title">${p.title||''}</div>
          <div class="prod-meta">
            <span class="badge">SKU: ${p.sku||''}</span>
            <span class="badge">Stock: ${Number(p.stock||0)}</span>
            ${p.provider_email ? `<span class="badge">Prov: ${p.provider_email}</span>` : ''}
          </div>
        </div>
        <div class="prod-footer">
          <button class="btn-icon favorite-btn" onclick="toggleFavorite('${p.sku}'); event.stopPropagation()" title="${isFavorite ? 'Quitar de favoritos' : 'Agregar a favoritos'}">
            ${isFavorite ? '‚òÖ' : '‚òÜ'}
          </button>
          <div class="price-info">
            <span class="muted">Gs ${nf(p.provider_price_gs||0)}</span>
          </div>
          <div class="action-buttons">
            <button class="btn small" onclick="openProductModal('${p.sku||''}'); event.stopPropagation()">Ver</button>
            ${(me.role==='ADMIN' || me.role==='DESPACHANTE' || me.role==='PROVEEDOR') ?
              `<button class="btn small warning" onclick="openEditProductModal('${p.id}'); event.stopPropagation()">Editar</button>` :
              ''}
            ${me.role === 'VENDEDOR' ?
              `<button class="btn small" onclick="cargarProducto('${p.sku}', ${p.provider_price_gs}); event.stopPropagation()">‚ûï Cargar</button>`
            : ''}
          </div>
        </div>
      `;
     
      // click en toda la card
      div.addEventListener('click', (ev)=>{
        // evitar doble apertura si clic en el bot√≥n
        if ((ev.target||{}).closest && (ev.target).closest('button')) return;
        openProductModal(p.sku||'');
      });
      grid.appendChild(div);
    });
  }

  // === NUEVO: Funci√≥n para cargar producto al formulario de pedido ===
  function cargarProducto(sku, precioProveedor) {
    // 1. Cambiar a pesta√±a "order"
    show('order');
   
    // 2. Esperar que se cargue la vista
    setTimeout(() => {
      // 3. Agregar fila de item
      addItemRow();
     
      // 4. Buscar el select reci√©n creado y seleccionar el SKU
      const lastRow = itemsBox.lastElementChild;
      const select = lastRow.querySelector('.itemSelect');
      if (select) {
        select.value = sku;
       
        // 5. Sugerir precio de venta (precio proveedor + margen sugerido)
        const precioVentaSugerido = Math.round(precioProveedor * 1.3); // 30% de margen
        const ventaInput = lastRow.querySelector('.ventaInp');
        if (ventaInput) {
          ventaInput.value = precioVentaSugerido;
        }
       
        // 6. Recalcular
        recalcOrder();
      }
    }, 300);
  }

  // === NUEVO: toggle tabla (se conserva la tabla original, por si la quer√©s usar)
  function toggleProdTable(){
    const wrap=document.getElementById('prodTableWrap');
    const btn=document.getElementById('prod_toggle_table');
    const hidden=wrap.classList.toggle('hidden');
    btn.textContent = hidden ? 'Mostrar tabla' : 'Ocultar tabla';
  }

  // === NUEVO: Modal de producto
  function openProductModal(sku){
    const p = (products||[]).find(x=>String(x.sku||'')===String(sku));
    if (!p) return;
    document.getElementById('pm_img').src = p.image_url || 'https://via.placeholder.com/220x220?text=No+image';
    document.getElementById('pm_title').textContent = p.title || '‚Äî';
    document.getElementById('pm_sku').textContent = p.sku || '‚Äî';
    document.getElementById('pm_provider').textContent = nf(p.provider_price_gs||0);
    document.getElementById('pm_stock').textContent = nf(p.stock||0);
    document.getElementById('pm_provider_email').textContent = p.provider_email || '‚Äî';

    document.getElementById('productModal').style.display='flex';
  }
  function closeProductModal(){ document.getElementById('productModal').style.display='none'; }

  // === NUEVO: Modal editar producto
  function openEditProductModal(productId){
    const p = (products||[]).find(x=>String(x.id)===String(productId));
    if (!p) return;
   
    document.getElementById('edit_prod_id').value = p.id;
    document.getElementById('edit_prod_title').value = p.title || '';
    document.getElementById('edit_prod_sku').value = p.sku || '';
    document.getElementById('edit_prod_price').value = p.provider_price_gs || 0;
    document.getElementById('edit_prod_stock').value = p.stock || 0;
    document.getElementById('edit_prod_img').value = p.image_url || '';
    document.getElementById('edit_prod_provider').value = p.provider_email || '';
    document.getElementById('edit_prod_private_to').value = p.private_to_emails || '';

    document.getElementById('editProductModal').style.display='flex';
  }
  function closeEditProductModal(){ document.getElementById('editProductModal').style.display='none'; }

  function saveProductEdit(){
    const tok=localStorage.getItem(tokenKey);
    const productId = document.getElementById('edit_prod_id').value;
    const data = {
      title: document.getElementById('edit_prod_title').value.trim(),
      sku: document.getElementById('edit_prod_sku').value.trim(),
      provider_price_gs: Number(document.getElementById('edit_prod_price').value||0),
      stock: Number(document.getElementById('edit_prod_stock').value||0),
      image_url: document.getElementById('edit_prod_img').value.trim(),
      provider_email: document.getElementById('edit_prod_provider').value.trim(),
      private_to_emails: document.getElementById('edit_prod_private_to').value.trim()
    };

    if (!data.title || !data.sku) {
      toast('T√≠tulo y SKU son obligatorios');
      return;
    }

    // Si es PROVEEDOR, forzar su propio email
    if (me?.role === 'PROVEEDOR') {
      data.provider_email = me.email;
    }

    google.script.run.withSuccessHandler(()=>{
      toast('Producto actualizado');
      closeEditProductModal();
      loadCatalog();
    }).withFailureHandler(e=>toast(e.message||e)).updateProduct(tok, productId, data);
  }

  function deleteProduct(productId){
    if (!confirm('¬øEst√°s seguro de que quer√©s eliminar este producto?')) return;
   
    const tok=localStorage.getItem(tokenKey);
    google.script.run.withSuccessHandler(()=>{
      toast('Producto eliminado');
      loadCatalog();
    }).withFailureHandler(e=>toast(e.message||e)).deleteProduct(tok, productId);
  }

  function deleteCurrentProduct(){
    const productId = document.getElementById('edit_prod_id').value;
    closeEditProductModal();
    deleteProduct(productId);
  }

  function openAddProduct(){ document.getElementById('addProductBox').classList.toggle('hidden'); }
 
  // ===== NUEVA FUNCI√ìN: Guardar producto con ambos campos =====
  function saveNewProduct() {
    const tok = localStorage.getItem(tokenKey);
   
    // Obtener valores de los nuevos campos
    const provider_email = (np_provider_email.value || '').trim();
    const private_to_emails = (np_private_to.value || '').trim();
   
    const p = {
      title: np_title.value.trim(),
      sku: np_sku.value.trim(),
      provider_price_gs: Number(np_price.value || 0),
      stock: Number(np_stock.value || 0),
      image_url: np_img.value.trim(),
      provider_email: provider_email,
      private_to_emails: private_to_emails
    };
   
    if (!p.title || !p.sku) {
      toast('T√≠tulo y SKU son obligatorios');
      return;
    }
   
    // Si es PROVEEDOR, forzar su propio email
    if (me?.role === 'PROVEEDOR') {
      p.provider_email = me.email;
    }
   
    google.script.run
      .withSuccessHandler(() => {
        toast('Producto guardado');
        loadCatalog();
       
        // Limpiar y ocultar
        document.getElementById('addProductBox').classList.add('hidden');
        np_title.value = '';
        np_sku.value = '';
        np_price.value = '';
        np_stock.value = '';
        np_img.value = '';
        np_provider_email.value = '';
        np_private_to.value = '';
      })
      .withFailureHandler(e => toast(e.message || e))
      .addProduct(tok, p);
  }

  // =========================
  // Ciudades (cliente)
  // =========================
  function buildCityDropdown(){
    const tok=localStorage.getItem(tokenKey);
    google.script.run.withSuccessHandler(rows=>{
      clientCityPrices=rows||[];
      const sel=o_city; sel.innerHTML='<option value="">Selecciona ciudad‚Ä¶</option>'+rows.map(r=>`<option>${r.city}</option>`).join('');
    }).getDeliveryClientPrices(tok);
  }

  // =========================
  // Pedido (form)
  // =========================
  function addItemRow(){
    const box=document.getElementById('itemsBox');
    const idx=box.children.length;
   
    let options = '';
    if (products && products.length > 0) {
      options = products.map(p=>`<option value="${p.sku}" ${p.stock<=0?'disabled':''}>${p.title} ‚Äî ${p.sku} (Prov ${nf(p.provider_price_gs)}) ${p.provider_email ? `[${p.provider_email}]` : ''}</option>`).join('');
    } else {
      options = '<option value="">Cargando productos...</option>';
    }
   
    const row=document.createElement('div'); row.className='row orderItemRow';
    row.innerHTML=`
      <select class="itemSelect" id="it_sku_${idx}" style="flex:2" onchange="recalcOrder()">
        ${options}
      </select>
      <span class="chip">Prov: <span class="provUnit">0</span></span>
      <input class="ventaInp" id="it_sale_${idx}" type="number" placeholder="Venta TOTAL (Gs)" style="flex:1" oninput="recalcOrder()">
      <input class="qtyInp" id="it_qty_${idx}" type="number" value="1" placeholder="Cant." style="width:90px" oninput="recalcOrder()">
      <span class="chip">Prov√óCant: <span class="subProv">0</span></span>
      <button class="btn small" onclick="this.parentElement.remove(); recalcOrder()">Quitar</button>`;
    box.appendChild(row); recalcOrder();
  }
 
  function getItems(){
    const rows=[...document.querySelectorAll('.orderItemRow')]; const items=[];
    rows.forEach(row=>{
      const sel=row.querySelector('.itemSelect'); const sale=row.querySelector('.ventaInp'); const qty=row.querySelector('.qtyInp');
      const sku=sel?.value; const s=Number(sale?.value||0); const q=Number(qty?.value||0);
      if (!sku || s<=0 || q<=0) return; items.push({sku, sale_gs:s, qty:q});
    });
    return items;
  }
 
  function recalcOrder(){
    if (!catalogMap || Object.keys(catalogMap).length === 0) {
      // Cat√°logo no cargado a√∫n
      return;
    }
   
    const rows=[...document.querySelectorAll('.orderItemRow')];
    let totalVenta=0, totalProv=0;
    rows.forEach(row=>{
      const sel=row.querySelector('.itemSelect'); const sale=row.querySelector('.ventaInp'); const qty=row.querySelector('.qtyInp');
      const provSpan=row.querySelector('.provUnit'); const subProv=row.querySelector('.subProv');
      const sku=sel?.value||''; const provUnit=Number(catalogMap[sku]?.provider_price_gs||0);
      if (provSpan) provSpan.textContent=nf(provUnit);
      const s=Number(sale?.value||0); const q=Number(qty?.value||0);
      totalVenta+=s; totalProv+=provUnit*q; if (subProv) subProv.textContent=nf(provUnit*q);
    });
    const city=(o_city.value||'').trim();
    const found=(clientCityPrices||[]).find(c=>String(c.city||'').toLowerCase()===city.toLowerCase());
    const del=found?Number(found.price||0):0;
    cityHint.textContent = del?`Delivery cobrado: ${nf(del)} Gs`:'';
    o_total.value=nf(totalVenta); o_delivery.value=nf(del);
    o_commission.value = nf(totalVenta - (totalProv + del));
  }

  // === NUEVO: Variable para prevenir duplicados en saveOrder ===
  let isSavingOrder = false;
 
  function saveOrder(){
    if (isSavingOrder) {
      toast('Ya se est√° guardando un pedido, esper√°...');
      return;
    }
   
    const tok = localStorage.getItem(tokenKey);
    const order={ customer_name:o_customer.value.trim(), phone:o_phone.value.trim(), city:o_city.value.trim(), street:o_street.value.trim(), district:o_district.value.trim(),
      email:o_email.value.trim(), obs:o_obs.value.trim(), items:getItems() };
   
    if (!order.customer_name || !order.phone || !order.city) {
      toast('Completa cliente / tel√©fono / ciudad');
      return;
    }
   
    if (order.items.length===0){
      toast('Agrega al menos 1 √≠tem');
      return;
    }
   
    // Bloquear bot√≥n
    isSavingOrder = true;
    const saveBtn = document.querySelector('button[onclick="saveOrder()"]');
    const originalText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.textContent = 'Guardando...';
   
    google.script.run
      .withSuccessHandler(()=>{
        toast('‚úÖ Pedido guardado');
        refreshOrders();
        refreshDashboard();
       
        // Limpiar formulario
        o_customer.value='';
        o_phone.value='';
        o_email.value='';
        o_street.value='';
        o_district.value='';
        o_obs.value='';
        itemsBox.innerHTML='';
        addItemRow();
       
        // Re-habilitar bot√≥n
        isSavingOrder = false;
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
      })
      .withFailureHandler(e=>{
        toast('‚ùå Error: ' + e.message);
       
        // Re-habilitar bot√≥n
        isSavingOrder = false;
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
      })
      .addOrder(tok,order);
  }

  // =========================
  // WhatsApp (DELIVERY)
  // =========================
  function toWhatsAppNumber(raw){
    const s = String(raw||'').replace(/[^\d+]/g,'');
    if (!s) return '';
    if (s.startsWith('+')) return s.replace(/\s+/g,'');
    let d = s.replace(/^0+/, '');
    if (!d.startsWith('595')) d = '595' + d;
    return '+' + d;
  }
  function sendWhatsApp(orderId){
    const tok=localStorage.getItem(tokenKey);
    const order=(lastOrders||[]).find(o=>String(o.id)===String(orderId));
    if (!order){ toast('Pedido no encontrado'); return; }
    const phone=toWhatsAppNumber(order.phone||'');
    if (!phone){ toast('El pedido no tiene tel√©fono v√°lido'); return; }
    const header=`Buenas, le escribo del sector de repartos üëã
Quiero coordinar la entrega de su pedido. Estos son los detalles:`;
    const footer = `\n¬øPodr√≠a enviarme su ubicaci√≥n por Google Maps para llegar de forma segura? Muchas gracias.`;
    google.script.run.withSuccessHandler(txt=>{
      const msg = `${header}\n\n${txt}\n${footer}`;
      const url = `https://wa.me/${phone.replace('+','')}?text=${encodeURIComponent(msg)}`;
      window.open(url,'_blank');
    }).withFailureHandler(e=>toast(e.message||e)).getGuideText(tok,orderId);
  }

  // =========================
  // Pedidos (listado) - MODIFICADO CON COLUMNA DE PROVEEDORES
  // =========================
  function refreshOrders(){
    const tok=localStorage.getItem(tokenKey);
    google.script.run.withSuccessHandler(rows=>{
      lastOrders=rows;
      renderOrdersLast();
      // === NUEVO: refrescar tambi√©n la vista Pedidos con gu√≠as
      renderPendingGuidesSimplified();
      markUpdated();
    })
      .withFailureHandler(e=>toast(e.message||e)).listOrders(tok);
    google.script.run.withSuccessHandler(ds=>{ deliveries=ds||[]; renderOrdersLast(); })
      .withFailureHandler(()=>{}).listUsersByRole(tok,'DELIVERY');
  }

  // üîé B√∫squeda: soporta ID tipo "A1089" y "1089" + normaliza acentos
  function renderOrdersLast(){
    const tb=document.querySelector('#tblOrders tbody'); if (!tb) return;

    const fromEl=document.getElementById('of_from');
    const toEl=document.getElementById('of_to');
    const qEl=document.getElementById('orderSearch');

    const f=fromEl?.value? new Date(fromEl.value+'T00:00:00'):new Date('1970-01-01');
    const t=toEl?.value  ? new Date(toEl.value  +'T23:59:59'):new Date('2999-12-31');
    const qNorm=norm(qEl?.value||'');

    if (me?.role==='DESPACHANTE'){
      document.querySelector('#tblOrders thead').innerHTML=`
        <tr>
          <th style="width:50px; text-align:center;">Sel</th>
          <th>Fecha</th><th>ID</th><th>Ciudad</th><th>Cliente</th><th>Vendedor</th>
          <th class="right">Total (Gs)</th>
          <th>Proveedores</th> <!-- NUEVA COLUMNA -->
          <th>Estado 2 (ADMIN/DESP)</th><th>Estado 3 (Empaques)</th><th>Gu√≠a</th><th>Acciones</th>
        </tr>`;
    } else if (me?.role==='DELIVERY'){
      document.querySelector('#tblOrders thead').innerHTML=`
        <tr>
          <th style="width:50px; text-align:center;">Sel</th>
          <th>Asignado</th><th>ID</th><th>Ciudad</th><th>Cliente</th><th>Vendedor</th>
          <th class="right">Total (Gs)</th><th class="right">Tarifa repartidor (Gs)</th>
          <th>Estado 1</th><th>Acciones</th><th></th>
        </tr>`;
    } else {
      document.querySelector('#tblOrders thead').innerHTML=`
        <tr>
          <th style="width:50px; text-align:center;">
            <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAll('orders')" title="Seleccionar todos">
          </th>
          <th>Fecha</th><th>ID</th><th>Ciudad</th><th>Cliente</th><th>Vendedor</th><th>Delivery asignado</th>
          <th class="right">Total (Gs)</th><th class="right" id="th_comm">${me?.role==='DELIVERY'?'Tarifa repartidor (Gs)':'Monto a comisionar (Gs)'}</th>
          <th>Proveedores</th> <!-- NUEVA COLUMNA -->
          <th>Estado 1</th><th>Estado 2 (ADMIN/DESP)</th><th>Asignar Delivery</th><th>Gu√≠a</th>
          <th>Acciones</th>
        </tr>`;
    }

    const data=(lastOrders||[]).filter(o=>{
      const baseDate = (me?.role==='DELIVERY' && o.assigned_at) ? o.assigned_at : o.created_at;
      const d=new Date(baseDate);
      if (d<f || d>t) return false;
      if (!qNorm) return true;

      const idNum = String(o.id||'').replace(/^[a-z]+/i,''); // A1089 -> 1089
      const hay = [
        o.customer_name||'', o.phone||'', o.id||'', idNum, o.city||'', o.created_by||''
      ].map(norm).join(' ');

      return hay.includes(qNorm);
    });

    const tbBody=tb;
    tbBody.innerHTML='';

    data.forEach(o=>{
      const meRole=me?.role||'';

      if (meRole==='DELIVERY'){
        // === MODIFICADO: Delivery SIN "DEVUELTO A DEP√ìSITO" ===
        const deliveryStatuses = [
          'PENDIENTE', 'EN RUTA', 'ENTREGADO', 'ENCOMIENDA ENTREGADA',
          'CANCELADO', 'REAGENDADO', 'NO CONTESTA', 'RECHAZADO',
          'RECHAZADO EN EL LUGAR', 'NO DESEA', 'CANCEL√ì POR WHATSAPP'
          // ‚ùå NO incluye "DEVUELTO A DEP√ìSITO"
        ];
       
        const stateSel = `<select data-id="${o.id}" class="stateSel">
          ${deliveryStatuses.map(s=>`<option value="${s}" ${s===o.status?'selected':''}>${s}</option>`).join('')}
        </select>`;

        const feeAsentado=Number(o.delivery_fee_gs||0);
        const fee = feeAsentado>0 ? feeAsentado : (rateMap[norm(o.city)]||0);
        const dateShown = o.assigned_at ? new Date(o.assigned_at).toLocaleString('es-PY') : new Date(o.created_at).toLocaleString('es-PY');

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td style="text-align:center;">
            <input type="checkbox" class="bulk-checkbox" data-id="${o.id}" data-type="orders" title="Seleccionar para impresi√≥n masiva">
          </td>
          <td>${dateShown}</td>
          <td>${o.id}</td><td>${o.city||''}</td><td>${o.customer_name||''}</td><td>${o.created_by||''}</td>
          <td class="right">${nf(o.total_gs)}</td><td class="right">${nf(fee)}</td>
          <td>${stateSel}</td>
          <td>
            <div class="row" style="gap:4px; flex-wrap:nowrap;">
              <button class="btn small" onclick="abrirGuiaLimpia('${o.id}')" style="padding:4px 8px; font-size:11px;">üìÑ</button>
              <button class="btn small" onclick="openGuide('${o.id}')" style="background:#6c757d; padding:4px 8px; font-size:11px;">üëÅÔ∏è</button>
              <button class="btn small" onclick="copiarGuiaLimpia('${o.id}')" style="padding:4px 8px; font-size:11px;">üìã</button>
            </div>
          </td>
          <td></td>`;
        tbBody.appendChild(tr);
        return;
      }

      if (meRole==='DESPACHANTE'){
        const state2Opts=['--','GUIA GENERADA','FUERA DE COBERTURA','CANCELADO','REPETIDO','RENDIDO'];
        const state2Sel = `<select data-id="${o.id}" class="state2Sel">
          ${state2Opts.map(s=>`<option value="${s}" ${s===o.status2?'selected':''}>${s}</option>`).join('')}
        </select>`;
       
        // ===== NUEVO: Mostrar proveedores para DESPACHANTE (con el nuevo formato) =====
        const providersHtml = o.provider_emails_list
          ? `<div class="provider-display" style="position: relative;">
              <span class="chip provider-chip ${o.provider_emails_list.split(',').length > 1 ? 'multiple' : ''}"
                   title="${o.provider_emails_list}"
                   onclick="debugOrderProviders('${o.id}')">
                ${o.provider_emails_list.split(',')[0].split('@')[0]}
                ${o.provider_emails_list.split(',').length > 1 ? ` +${o.provider_emails_list.split(',').length-1}` : ''}
              </span>
              <button class="btn-icon small" onclick="updateSingleProvider('${o.id}')"
                      style="margin-left: 4px; padding: 2px 4px; font-size: 10px;"
                      title="Recalcular proveedores">
                üîÑ
              </button>
            </div>`
          : `<div class="provider-display">
              <span class="chip muted" style="background: #ff6b6b20; color: #ff6b6b;">Sin prov</span>
              <button class="btn-icon small" onclick="updateSingleProvider('${o.id}')"
                      style="margin-left: 4px; padding: 2px 4px; font-size: 10px;"
                      title="Calcular proveedores">
                üîç
              </button>
            </div>`;
       
        const packInput = `<div class="row" style="gap:6px;">
            <input data-id="${o.id}" class="packInp" type="number" min="0" value="${Number(o.pack_count||0)}" style="width:120px">
            <span class="chip">Gs ${nf(Number(o.pack_count||0)*3500)}</span>
          </div>`;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td style="text-align:center;">
            <input type="checkbox" class="bulk-checkbox" data-id="${o.id}" data-type="orders" title="Seleccionar para impresi√≥n masiva">
          </td>
          <td>${new Date(o.created_at).toLocaleString('es-PY')}</td>
          <td>${o.id}</td><td>${o.city||''}</td><td>${o.customer_name||''}</td><td>${o.created_by||''}</td>
          <td class="right">${nf(o.total_gs)}</td>
          <td>${providersHtml}</td> <!-- NUEVA COLUMNA -->
          <td>${state2Sel}</td>
          <td>${packInput}</td>
          <td>
            <div class="row" style="gap:4px; flex-wrap:nowrap;">
              <button class="btn small" onclick="abrirGuiaLimpia('${o.id}')" style="padding:4px 8px; font-size:11px;">üìÑ</button>
              <button class="btn small" onclick="openGuide('${o.id}')" style="padding:4px 8px; font-size:11px;">üëÅÔ∏è</button>
              <button class="btn small" onclick="copiarGuiaLimpia('${o.id}')" style="padding:4px 8px; font-size:11px;">üìã</button>
            </div>
          </td>
          <td class="action-buttons">
            ${(me.role==='ADMIN' || me.role==='DESPACHANTE' || me.role==='PROVEEDOR') ?
              `<button class="btn small warning" onclick="openEditOrderModal('${o.id}')">Editar</button>
               <button class="btn small danger" onclick="deleteOrder('${o.id}')">Eliminar</button>` :
              ''}
          </td>`;
        tbBody.appendChild(tr);
        return;
      }

      // Para ADMIN, VENDEDOR, PROVEEDOR
      const disableState1 = (meRole==='VENDEDOR');
      const disableState2 = !(meRole==='ADMIN' || meRole==='DESPACHANTE' || meRole==='PROVEEDOR');
      const disableDevuelto = (meRole==='DELIVERY');
      const canAssign = (meRole==='ADMIN' || meRole==='PROVEEDOR');

      const state1Opts = ['PENDIENTE','EN RUTA','ENTREGADO','ENCOMIENDA ENTREGADA','CANCELADO','REAGENDADO','NO CONTESTA','RECHAZADO','RECHAZADO EN EL LUGAR','NO DESEA','CANCEL√ì POR WHATSAPP','DEVUELTO A DEP√ìSITO'];
      const state2Opts = ['--','GUIA GENERADA','FUERA DE COBERTURA','CANCELADO','REPETIDO','RENDIDO'];

      const stateSel = `<select data-id="${o.id}" class="stateSel" ${disableState1?'disabled':''}>
          ${state1Opts.map(s=>`<option value="${s}" ${s===o.status?'selected':''} ${(disableDevuelto&&s==='DEVUELTO A DEP√ìSITO')?'disabled':''}>${s}</option>`).join('')}
        </select>`;
      const state2Sel = `<select data-id="${o.id}" class="state2Sel" ${disableState2?'disabled':''}>
          ${state2Opts.map(s=>`<option value="${s}" ${s===o.status2?'selected':''}>${s}</option>`).join('')}
        </select>`;
      const delSel = `<select data-id="${o.id}" class="assignSel" ${canAssign?'':'disabled'}>
          <option value="">-- Sin asignar --</option>
          ${deliveries.map(d=>`<option value="${d.email}" ${o.assigned_delivery===d.email?'selected':''}>${d.name||d.email}</option>`).join('')}
        </select>`;

      let colVal;
      if (meRole === 'DELIVERY') {
        const feeAsentado = Number(o.delivery_fee_gs||0);
        colVal = feeAsentado > 0 ? feeAsentado : (rateMap[norm(o.city)] || 0);
      } else { colVal = Number(o.commission_gs||0); }

      // ===== NUEVO: Mostrar proveedores para ADMIN, VENDEDOR, PROVEEDOR (con el nuevo formato) =====
      const providersHtml = o.provider_emails_list
        ? `<div class="provider-display" style="position: relative;">
            <span class="chip provider-chip ${o.provider_emails_list.split(',').length > 1 ? 'multiple' : ''}"
                 title="${o.provider_emails_list}"
                 onclick="debugOrderProviders('${o.id}')">
              ${o.provider_emails_list.split(',')[0].split('@')[0]}
              ${o.provider_emails_list.split(',').length > 1 ? ` +${o.provider_emails_list.split(',').length-1}` : ''}
            </span>
            <button class="btn-icon small" onclick="updateSingleProvider('${o.id}')"
                    style="margin-left: 4px; padding: 2px 4px; font-size: 10px;"
                    title="Recalcular proveedores">
              üîÑ
            </button>
          </div>`
        : `<div class="provider-display">
            <span class="chip muted" style="background: #ff6b6b20; color: #ff6b6b;">Sin prov</span>
            <button class="btn-icon small" onclick="updateSingleProvider('${o.id}')"
                    style="margin-left: 4px; padding: 2px 4px; font-size: 10px;"
                    title="Calcular proveedores">
              üîç
            </button>
          </div>`;

      // === MODIFICADO: Para VENDEDOR - Mostrar bot√≥n eliminar condicional ===
      let deleteButton = '';
      if (meRole === 'VENDEDOR') {
        const canDelete =
          (o.status === 'PENDIENTE' || o.status === 'EN RUTA') &&
          (!o.status2 || o.status2 === '' || o.status2 === '--') &&
          o.created_by.toLowerCase() === me.email.toLowerCase();
       
        if (canDelete) {
          deleteButton = `<button class="btn small danger" onclick="deleteOrder('${o.id}')">Eliminar</button>`;
        }
      }

      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td style="text-align:center;">
          <input type="checkbox" class="bulk-checkbox" data-id="${o.id}" data-type="orders" title="Seleccionar para impresi√≥n masiva">
        </td>
        <td>${new Date(o.created_at).toLocaleString('es-PY')}</td>
        <td>${o.id}</td><td>${o.city||''}</td><td>${o.customer_name||''}</td>
        <td>${o.created_by||''}</td><td>${o.assigned_delivery||''}</td>
        <td class="right">${nf(o.total_gs)}</td>
        <td class="right">${nf(colVal)}</td>
        <td>${providersHtml}</td> <!-- NUEVA COLUMNA: PROVEEDORES -->
        <td>${stateSel}</td><td>${state2Sel}</td><td>${delSel}</td>
        <td>
          <div class="row" style="gap:4px; flex-wrap:nowrap;">
            <button class="btn small" onclick="abrirGuiaLimpia('${o.id}')" style="padding:4px 8px; font-size:11px;">üìÑ</button>
            <button class="btn small" onclick="openGuide('${o.id}')" style="background:#6c757d; padding:4px 8px; font-size:11px;">üëÅÔ∏è</button>
            <button class="btn small" onclick="copiarGuiaLimpia('${o.id}')" style="padding:4px 8px; font-size:11px;">üìã</button>
          </div>
        </td>
        <td class="action-buttons">
          ${deleteButton}
          ${(me.role==='ADMIN' || me.role==='DESPACHANTE' || me.role==='PROVEEDOR') ?
            `<button class="btn small warning" onclick="openEditOrderModal('${o.id}')">Editar</button>
             <button class="btn small danger" onclick="deleteOrder('${o.id}')">Eliminar</button>` :
            ''}
        </td>`;
     
      tbBody.appendChild(tr);
     
      // Agregar event listeners a los checkboxes
      const checkbox = tr.querySelector('.bulk-checkbox');
      if (checkbox) {
        checkbox.onchange = (e) => {
          const success = toggleBulkSelection(o.id, e.target.checked, 'orders');
          if (!success) e.target.checked = false;
        };
       
        // Marcar si ya est√° seleccionado
        checkbox.checked = selectedOrders.has(o.id);
        if (checkbox.checked) tr.classList.add('selected-row');
      }
    });

    // === CORREGIDO: Usar la funci√≥n unificada para cambios de estado ===
    tb.querySelectorAll('.stateSel').forEach(sel=>{
      sel.onchange=(e)=>{
        updateOrderStatusUnified(e.target);
      };
    });
   
    tb.querySelectorAll('.state2Sel').forEach(sel=>{
      sel.onchange=(e)=>{
        const id=e.target.getAttribute('data-id'); const status2=e.target.value;
        const tok=localStorage.getItem(tokenKey);
       
        // Deshabilitar durante actualizaci√≥n
        e.target.disabled = true;
        e.target.classList.add('updating');
        const previousStatus = e.target.value;
       
        google.script.run.withSuccessHandler(()=>{
          e.target.disabled = false;
          e.target.classList.remove('updating');
          e.target.classList.add('success-flash');
          setTimeout(() => e.target.classList.remove('success-flash'), 800);
          toast('Estado 2 actualizado ‚úì');
          refreshWallet();
          refreshDashboard();
        })
          .withFailureHandler(err=>{
            e.target.disabled = false;
            e.target.classList.remove('updating');
            e.target.classList.add('error-flash');
            setTimeout(() => e.target.classList.remove('error-flash'), 800);
            e.target.value = previousStatus;
            toast('Error: ' + (err.message||err));
          })
          .updateOrderStatus2(tok,id,status2);
      };
    });
   
    tb.querySelectorAll('.assignSel').forEach(sel=>{
      sel.onchange=(e)=>{
        const id=e.target.getAttribute('data-id'); const deliveryEmail=e.target.value; const tok=localStorage.getItem(tokenKey);
       
        // Deshabilitar durante actualizaci√≥n
        e.target.disabled = true;
        e.target.classList.add('updating');
        const previousStatus = e.target.value;
       
        google.script.run.withSuccessHandler(()=>{
          e.target.disabled = false;
          e.target.classList.remove('updating');
          e.target.classList.add('success-flash');
          setTimeout(() => e.target.classList.remove('success-flash'), 800);
          toast('Delivery asignado ‚úì');
          refreshDashboard();
        })
          .withFailureHandler(err=>{
            e.target.disabled = false;
            e.target.classList.remove('updating');
            e.target.classList.add('error-flash');
            setTimeout(() => e.target.classList.remove('error-flash'), 800);
            e.target.value = previousStatus;
            toast('Error: ' + (err.message||err));
          })
          .assignDelivery(tok,id,deliveryEmail);
      };
    });
   
    tb.querySelectorAll('.packInp').forEach(inp=>{
      inp.onchange=(e)=>{
        const id=e.target.getAttribute('data-id'); const qty=Number(e.target.value||0);
        const tok=localStorage.getItem(tokenKey);
        google.script.run.withSuccessHandler(()=>{ toast('Empaques guardados'); refreshWallet(); })
          .withFailureHandler(err=>{ toast(err.message||err); })
          .setPackCount?.(tok,id,qty);
      };
    });
   
    updateBulkUI();
  }

  // === NUEVO: Funci√≥n deleteOrder mejorada ===
  function deleteOrder(orderId) {
    if (!confirm('¬øEst√°s seguro de que quer√©s eliminar este pedido?')) return;
   
    const tok = localStorage.getItem(tokenKey);
   
    google.script.run
      .withSuccessHandler(() => {
        toast('‚úÖ Pedido eliminado');
        refreshOrders();
        refreshDashboard();
        refreshWallet();
      })
      .withFailureHandler(e => {
        toast('‚ùå Error: ' + e.message);
      })
      .deleteOrder(tok, orderId);
  }

  // === NUEVO: Modal editar pedido
  function openEditOrderModal(orderId){
    const order = (lastOrders||[]).find(o=>String(o.id)===String(orderId));
    if (!order) return;
   
    document.getElementById('edit_order_id').value = order.id;
    document.getElementById('edit_order_customer').value = order.customer_name || '';
    document.getElementById('edit_order_phone').value = order.phone || '';
    document.getElementById('edit_order_city').value = order.city || '';
    document.getElementById('edit_order_street').value = order.street || '';
    document.getElementById('edit_order_district').value = order.district || '';
    document.getElementById('edit_order_email').value = order.email || '';
    document.getElementById('edit_order_obs').value = order.obs || '';

    document.getElementById('editOrderModal').style.display='flex';
  }
  function closeEditOrderModal(){ document.getElementById('editOrderModal').style.display='none'; }

  function saveOrderEdit(){
    const tok=localStorage.getItem(tokenKey);
    const orderId = document.getElementById('edit_order_id').value;
    const data = {
      customer_name: document.getElementById('edit_order_customer').value.trim(),
      phone: document.getElementById('edit_order_phone').value.trim(),
      city: document.getElementById('edit_order_city').value.trim(),
      street: document.getElementById('edit_order_street').value.trim(),
      district: document.getElementById('edit_order_district').value.trim(),
      email: document.getElementById('edit_order_email').value.trim(),
      obs: document.getElementById('edit_order_obs').value.trim()
    };

    if (!data.customer_name || !data.phone || !data.city) { toast('Cliente, tel√©fono y ciudad son obligatorios'); return; }

    google.script.run.withSuccessHandler(()=>{
      toast('Pedido actualizado');
      closeEditOrderModal();
      refreshOrders();
    }).withFailureHandler(e=>toast(e.message||e)).updateOrder(tok, orderId, data);
  }

  function deleteCurrentOrder(){
    const orderId = document.getElementById('edit_order_id').value;
    closeEditOrderModal();
    deleteOrder(orderId);
  }

  // B√∫squeda en vivo
  function wireSearchInputs(){
    const os=document.getElementById('orderSearch');
    if (!os) return;
    let t=null;
    const trigger=()=>{ clearTimeout(t); t=setTimeout(renderOrdersLast, 180); };
    os.addEventListener('input', trigger);
    os.addEventListener('keyup', (e)=>{ if (e.key==='Enter') renderOrdersLast(); });
  }

  // =========================
  // Dashboard
  // =========================
  function refreshDashboard(){
    const tok=localStorage.getItem(tokenKey);
    const f=document.getElementById('dash_from')?.value||''; const t=document.getElementById('dash_to')?.value||'';
   
    // === NUEVO: PROVEEDOR usa m√©tricas espec√≠ficas ===
    if (me?.role === 'PROVEEDOR') {
      google.script.run.withSuccessHandler(res=>{
        kpi_provider_orders.textContent = nf(res.cards.orders);
        kpi_provider_sold.textContent = nf(res.cards.sold);
        kpi_provider_delivered.textContent = nf(res.cards.delivered);
        kpi_provider_canceled.textContent = nf(res.cards.canceled);
        kpi_provider_profit.textContent = nf(res.cards.profit);
        kpi_provider_pending.textContent = nf(res.cards.pending_commissions);
        kpi_provider_paid.textContent = nf(res.cards.paid_commissions);

        const labels=res.series.map(s=>s.date), values=res.series.map(s=>s.value);
        if (CHART_BARS) CHART_BARS.destroy();
        CHART_BARS=new Chart(document.getElementById('chartBars').getContext('2d'),{
          type:'bar', data:{labels, datasets:[{label:'Ventas por d√≠a (Gs)', data:values}]},
          options:{responsive:true, maintainAspectRatio:false}
        });

        const pl=Object.keys(res.pie), pv=pl.map(k=>res.pie[k]);
        if (CHART_PIE) CHART_PIE.destroy();
        CHART_PIE=new Chart(document.getElementById('chartPie').getContext('2d'),{
          type:'pie', data:{labels:pl, datasets:[{data:pv}]}, options:{responsive:true, maintainAspectRatio:false}
        });

        const tl=document.getElementById('topList'); tl.innerHTML='';
        (res.top||[]).forEach(x=>{ const li=document.createElement('li'); li.textContent=`${x.name}: ${nf(x.qty)} (Gs ${nf(x.revenue)})`; tl.appendChild(li); });
        const ml=document.getElementById('mapList'); ml.innerHTML='';
        (res.map||[]).forEach(x=>{ const li=document.createElement('li'); li.textContent=`${x.city}: ${nf(x.qty)} pedidos (Gs ${nf(x.revenue)})`; ml.appendChild(li); });

        markUpdated();
      }).withFailureHandler(e=>toast(e.message||e)).providerMetrics(tok,f,t);
    } else {
      // M√©tricas normales para otros roles
      google.script.run.withSuccessHandler(res=>{
        kpi_orders.textContent=nf(res.cards.orders);
        kpi_sold.textContent=nf(res.cards.sold);
        kpi_delivered.textContent=nf(res.cards.delivered);
        kpi_canceled.textContent=nf(res.cards.canceled);

        if (me?.role === 'DELIVERY') {
          const fromDate = f ? new Date(f+'T00:00:00') : new Date('1970-01-01');
          const toDate   = t ? new Date(t+'T23:59:59') : new Date('2999-12-31');
          let montoRendir = 0; let sumaEntregadoTotal = 0;
          (lastOrders||[]).forEach(o=>{
            const baseDate = o.assigned_at ? new Date(o.assigned_at) : new Date(o.created_at);
            if (baseDate < fromDate || baseDate > toDate) return;
            if ((o.assigned_delivery||'').toLowerCase() !== (me.email||'').toLowerCase()) return;
            const status = String(o.status||'').toUpperCase();
            if (status === 'ENTREGADO') {
              const total = Number(o.total_gs||0);
              const feeReal = Number(o.delivery_fee_gs||0);
              const feeEst  = rateMap[norm(o.city)] || 0;
              const fee = feeReal>0 ? feeReal : feeEst;
              sumaEntregadoTotal += total;
              montoRendir += (total - fee);
            }
          });
          document.getElementById('kpi_sum_entregado').textContent = nf(sumaEntregadoTotal);
          kpi_profit.textContent = nf(montoRendir);
        } else {
          kpi_profit.textContent = nf(res.cards.profit);
        }

        const labels=res.series.map(s=>s.date), values=res.series.map(s=>s.value);
        if (CHART_BARS) CHART_BARS.destroy();
        CHART_BARS=new Chart(document.getElementById('chartBars').getContext('2d'),{
          type:'bar', data:{labels, datasets:[{label:'Ventas por d√≠a (Gs)', data:values}]},
          options:{responsive:true, maintainAspectRatio:false}
        });

        const pl=Object.keys(res.pie), pv=pl.map(k=>res.pie[k]);
        if (CHART_PIE) CHART_PIE.destroy();
        CHART_PIE=new Chart(document.getElementById('chartPie').getContext('2d'),{
          type:'pie', data:{labels:pl, datasets:[{data:pv}]}, options:{responsive:true, maintainAspectRatio:false}
        });

        if (me?.role==='DESPACHANTE'){
          kpi_guides_gen.textContent = nf(res.guides?.generated||0);
          kpi_guides_pend.textContent = nf(res.guides?.pending||0);
          const gl=(res.guides?.series||[]).map(x=>x.date);
          const gg=(res.guides?.series||[]).map(x=>x.gen);
          const gp=(res.guides?.series||[]).map(x=>x.pend);
          if (CHART_GG) CHART_GG.destroy();
          CHART_GG=new Chart(document.getElementById('chartGuideGen').getContext('2d'),{
            type:'line', data:{labels:gl, datasets:[{label:'Generadas', data:gg}]}, options:{responsive:true, maintainAspectRatio:false}
          });
          if (CHART_GP) CHART_GP.destroy();
          CHART_GP=new Chart(document.getElementById('chartGuidePend').getContext('2d'),{
            type:'line', data:{labels:gl, datasets:[{label:'Pendientes', data:gp}]}, options:{responsive:true, maintainAspectRatio:false}
          });
        }

        const tl=document.getElementById('topList'); tl.innerHTML='';
        (res.top||[]).forEach(x=>{ const li=document.createElement('li'); li.textContent=`${x.name}: ${nf(x.qty)} (Gs ${nf(x.revenue)})`; tl.appendChild(li); });
        const ml=document.getElementById('mapList'); ml.innerHTML='';
        (res.map||[]).forEach(x=>{ const li=document.createElement('li'); li.textContent=`${x.city}: ${nf(x.qty)} pedidos (Gs ${nf(x.revenue)})`; ml.appendChild(li); });

        markUpdated();
      }).withFailureHandler(e=>toast(e.message||e)).metrics(tok,f,t);
    }
   
    // === NUEVO: Cargar datos adicionales ===
    if (me?.role === 'ADMIN' || me?.role === 'PROVEEDOR') {
      loadPendingCommissionsKPIs();
    }
    if (me?.role === 'DELIVERY') {
      loadDeliveryProfit();
    }
  }

  // =========================
  // Wallet
  // =========================
  function refreshWallet(){
    const tok=localStorage.getItem(tokenKey);
    google.script.run.withSuccessHandler(res=>{
      w_balance.textContent = nf(res.balance_gs||0);
      const tb=document.getElementById('wallet_tbody'); tb.innerHTML='';
      (res.txs||[]).forEach(t=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${new Date(t.created_at).toLocaleString('es-PY')}</td>
          <td>${t.type}</td><td>${t.order_id||''}</td><td class="right">${nf(t.amount_gs)}</td><td>${t.note||''}</td>`;
        tb.appendChild(tr);
      });
      markUpdated();
    }).getWallet(tok, '');
  }

  // =========================
  // Novedades
  // =========================
  function refreshNews(){
    const tok=localStorage.getItem(tokenKey);
    google.script.run.withSuccessHandler(rows=>{
      const tb=document.getElementById('news_tbody'); tb.innerHTML='';
      (rows||[]).forEach(n=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${new Date(n.created_at).toLocaleString('es-PY')}</td><td>${n.order_id}</td><td>${n.type}</td><td>${n.note||''}</td>`;
        tb.appendChild(tr);
      });
      markUpdated();
    }).listNews(tok);
  }

  // =========================
  // Tarifas + Precios cliente
  // =========================
  function loadRates(){
    const tok=localStorage.getItem(tokenKey);
    // === MODIFICADO: PROVEEDOR tambi√©n puede ver tarifas ===
    document.getElementById('ratesAdminBox').classList.toggle('hidden', !(me?.role==='ADMIN' || me?.role==='PROVEEDOR'));
    google.script.run.withSuccessHandler(rows=>{
      const tb=document.getElementById('rates_tbody'); tb.innerHTML='';
      (rows||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.email}</td><td>${r.city}</td><td class="right">${nf(r.rate_gs)}</td>`; tb.appendChild(tr); });
      allRatesMap = {};
      (rows||[]).forEach(r=>{ const em = norm(String(r.email||'')); const ct = norm(String(r.city||'')); if (!allRatesMap[em]) allRatesMap[em] = {}; allRatesMap[em][ct] = Number(r.rate_gs||0); });
      rateMap = {}; if (me?.role === 'DELIVERY') { (rows||[]).forEach(r=>{ rateMap[norm(r.city)] = Number(r.rate_gs||0); }); }
      markUpdated();
    }).getDeliveryRates(tok, '');
  }
  function saveRate(){
    const tok=localStorage.getItem(tokenKey);
    google.script.run.withSuccessHandler(()=>{ toast('Tarifa guardada'); loadRates(); })
      .withFailureHandler(e=>toast(e.message||e))
      .setDeliveryRate(tok, dr_email.value.trim(), dr_city.value.trim(), Number(dr_rate.value||0));
  }
  function loadClientPrices(){
    const tok=localStorage.getItem(tokenKey);
    document.getElementById('clientPricesAdminBox').classList.toggle('hidden', me?.role!=='ADMIN');
    google.script.run.withSuccessHandler(rows=>{
      const tb=document.getElementById('client_prices_tbody'); if (!tb) return; tb.innerHTML='';
      (rows||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${r.city}</td><td class="right">${nf(r.price)}</td>`; tb.appendChild(tr); });
      markUpdated();
    }).withFailureHandler(e=>toast(e.message||e)).getDeliveryClientPrices(tok);
  }
  function saveClientPrice(){
    const tok=localStorage.getItem(tokenKey);
    const city = (cp_city.value||'').trim(); const price = Number(cp_price.value||0);
    if (!city || price<=0){ toast('Ciudad y precio son obligatorios'); return; }
    google.script.run.withSuccessHandler(()=>{ toast('Precio guardado'); cp_city.value=''; cp_price.value=''; loadClientPrices(); buildCityDropdown(); })
      .withFailureHandler(e=>toast(e.message||e))
      .setClientCityPrice(tok, city, price);
  }

  // =========================
  // Gu√≠a
  // =========================
  function openGuide(id){
    guideOrderId=id; guideText.value='Cargando...'; document.getElementById('guideModal').style.display='flex';
    const tok=localStorage.getItem(tokenKey);
    google.script.run.withSuccessHandler(txt=>{ guideText.value=txt; })
      .withFailureHandler(e=>{ guideText.value='Error: '+(e.message||e); })
      .getGuideText(tok,id);
  }
  function closeGuide(){ document.getElementById('guideModal').style.display='none'; }
  function downloadGuide(){
    const tok=localStorage.getItem(tokenKey);
    google.script.run.withSuccessHandler(f=>{ window.open(f.url,'_blank'); })
      .withFailureHandler(e=>toast(e.message||e))
      .generateGuidePDF(tok, guideOrderId);
  }

  // =========================
  // Pago de Comisiones (ADMIN y PROVEEDOR) con Estado 1 editable
  // =========================
  function loadCommissions(){
    const tok = localStorage.getItem(tokenKey);
    const f=document.getElementById('pc_from').value||''; const t=document.getElementById('pc_to').value||'';
    const vend=(document.getElementById('pc_vendor_admin').value||'').trim(); const only=document.getElementById('pc_only').value||''; const q=(document.getElementById('pc_q').value||'').trim();
    const providerFilter = document.getElementById('comm_filter_provider')?.value || '';

    // NUEVO: usamos la funci√≥n FLEX que no obliga Estado 1 = ENTREGADO
    google.script.run.withSuccessHandler(rows=>{
      const tb=document.getElementById('comms_tbody'); tb.innerHTML='';

      // === En Comisi√≥n, limitar selector Estado 1 a estos 2 (como pediste):
      const state1Opts = ['ENTREGADO','ENCOMIENDA ENTREGADA']; // <-- SOLO estos 2 aqu√≠

      // Mostrar SOLO filas con esos estados (si quer√©s ver los dem√°s, quit√° este filtro)
      const allowed = new Set(state1Opts.map(s=>s.toUpperCase()));
      const visibles = (rows||[]).filter(o => allowed.has(String(o.status||'').toUpperCase()));

      /* === NUEVO: KPIs de Pago de comisiones (cantidad y suma de comisiones) === */
      const pcCnt = visibles.length;
      let pcSum = 0;
      visibles.forEach(o => { pcSum += Number(o.commission_gs || 0); });
      const kCntEl = document.getElementById('pc_k_cnt');
      const kSumEl = document.getElementById('pc_k_sum');
      if (kCntEl) kCntEl.textContent = nf(pcCnt);
      if (kSumEl) kSumEl.textContent = nf(pcSum);
      /* === FIN NUEVO === */

      (visibles||[]).forEach(o=>{
        const stateSel = `<select class="commStateSel" data-id="${o.id}">
          ${state1Opts.map(s=>`<option value="${s}" ${s===o.status?'selected':''}>${s}</option>`).join('')}
        </select>`;
        const selPay=`<select class="commPaySel" data-id="${o.id}">
          <option value="PENDIENTE" ${!o.commission_paid?'selected':''}>PENDIENTE</option>
          <option value="PAGADO" ${o.commission_paid?'selected':''}>PAGADO</option>
        </select>`;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${new Date(o.created_at).toLocaleString('es-PY')}</td>
          <td>${o.id}</td><td>${o.city||''}</td><td>${o.customer_name||''}</td><td>${o.vendor_email||''}</td>
          <td>${o.assigned_delivery||''}</td><td class="right">${nf(o.total_gs)}</td><td class="right">${nf(o.commission_gs)}</td>
          <td>${stateSel}</td>
          <td>${selPay} ${o.paid_at?`<span class="chip">${new Date(o.paid_at).toLocaleDateString('es-PY')}</span>`:''}</td>
          <td><button class="btn small" onclick="abrirGuiaLimpia('${o.id}')" style="padding:4px 8px; font-size:11px;">üìÑ</button></td>`;
        tb.appendChild(tr);
      });

      tb.querySelectorAll('.commStateSel').forEach(s=>{
        s.onchange=(e)=>{
          // Usar la funci√≥n unificada
          updateOrderStatusUnified(e.target);
        };
      });
     
      tb.querySelectorAll('.commPaySel').forEach(s=>{
        s.onchange=(e)=>{
          const id=e.target.getAttribute('data-id'); const paid=(e.target.value==='PAGADO'); const tok=localStorage.getItem(tokenKey);
         
          // Deshabilitar durante actualizaci√≥n
          e.target.disabled = true;
          e.target.classList.add('updating');
          const previousStatus = e.target.value;
         
          google.script.run.withSuccessHandler(()=>{
            e.target.disabled = false;
            e.target.classList.remove('updating');
            e.target.classList.add('success-flash');
            setTimeout(() => e.target.classList.remove('success-flash'), 800);
            toast('Pago comisi√≥n actualizado ‚úì');
            refreshWallet();
            // No llamar a loadCommissions() para evitar recarga completa
          })
          .withFailureHandler(err=>{
            e.target.disabled = false;
            e.target.classList.remove('updating');
            e.target.classList.add('error-flash');
            setTimeout(() => e.target.classList.remove('error-flash'), 800);
            e.target.value = previousStatus;
            toast('Error: ' + (err.message||err));
          })
          .payVendorCommission(tok,id,paid);
        };
      });
      markUpdated();
    }).withFailureHandler(e=>toast(e.message||e))
      .listCommissionsFlex(tok,f,t,vend,only,q,providerFilter);
  }
 
  // ===== NUEVA FUNCI√ìN: Cargar comisiones para VENDEDOR ===
  function loadCommissionsForVendor() {
    const tok = localStorage.getItem(tokenKey);
   
    // Si es VENDEDOR, usar su email autom√°ticamente
    if (me?.role === 'VENDEDOR') {
      document.getElementById('vendor_email_box').classList.remove('hidden');
      document.getElementById('vendor_email_admin_box').classList.add('hidden');
     
      const vendorEmail = me.email;
      document.getElementById('pc_vendor').value = vendorEmail;
     
      // Cambiar t√≠tulo
      document.getElementById('commissions_title').textContent = 'üí∞ Mis Comisiones';
     
      // Cargar comisiones espec√≠ficas del vendedor
      const f = document.getElementById('pc_from')?.value || '';
      const t = document.getElementById('pc_to')?.value || '';
      const only = document.getElementById('pc_only')?.value || '';
      const q = (document.getElementById('pc_q')?.value || '').trim();
     
      google.script.run
        .withSuccessHandler(rows => {
          renderCommissionsTable(rows || []);
        })
        .withFailureHandler(e => toast(e.message || e))
        .getVendorCommissions(tok, f, t, only, q);
    } else {
      // ADMIN/PROVEEDOR - comportamiento normal
      document.getElementById('vendor_email_box').classList.add('hidden');
      document.getElementById('vendor_email_admin_box').classList.remove('hidden');
      document.getElementById('commissions_title').textContent = 'üí∞ Pago de comisiones';
      loadCommissions();
    }
  }

  // =========================
  // PROBLEMA 6 RESUELTO: Funci√≥n mejorada para marcar todas las comisiones como pagadas
  // =========================
  async function markAllCommissionsPaid() {
    const rows = [...document.querySelectorAll('#comms_tbody tr')];
    if (!rows.length) { toast('No hay filas en vista'); return; }
   
    const ids = rows.map(tr => tr.children[1]?.textContent?.trim()).filter(Boolean);
    const total = ids.length;
   
    if (!confirm(`¬øMarcar ${total} pedidos como PAGADO?\nMonto total: ${document.getElementById('pc_k_sum').textContent}`)) {
      return;
    }
   
    // Mostrar modal
    showBulkProcessModal(ids);
   
    // Procesar en lotes
    await processInBatches(ids);
  }

  // =========================
  // FUNCIONES PARA EL MODAL DE PROCESO MASIVO
  // =========================

  let isProcessing = false;
  let isPaused = false;
  let processedCount = 0;
  let successCount = 0;
  let errorCount = 0;
  let currentBatch = [];

  function showBulkProcessModal(ids) {
    currentBatch = ids;
    processedCount = 0;
    successCount = 0;
    errorCount = 0;
    isProcessing = true;
    isPaused = false;
   
    document.getElementById('totalCount').textContent = ids.length;
    document.getElementById('successCount').textContent = '0';
    document.getElementById('errorCount').textContent = '0';
    document.getElementById('processProgress').style.width = '0%';
    document.getElementById('processLog').innerHTML = '<div class="info">Iniciando procesamiento...</div>';
   
    document.getElementById('bulkProcessModal').style.display = 'flex';
  }

  function closeProcessModal() {
    if (isProcessing && !confirm('¬øEst√°s seguro de cerrar? El proceso se cancelar√°.')) {
      return;
    }
    isProcessing = false;
    document.getElementById('bulkProcessModal').style.display = 'none';
    loadCommissions(); // Recargar comisiones
  }

  function pauseProcess() {
    isPaused = !isPaused;
    const btn = document.querySelector('[onclick="pauseProcess()"]');
    btn.textContent = isPaused ? '‚ñ∂Ô∏è Reanudar' : '‚è∏Ô∏è Pausar';
    addLog(isPaused ? 'Proceso pausado' : 'Proceso reanudado', 'info');
  }

  function cancelProcess() {
    if (confirm('¬øCancelar procesamiento?')) {
      isProcessing = false;
      addLog('Proceso cancelado por el usuario', 'error');
      setTimeout(() => {
        document.getElementById('bulkProcessModal').style.display = 'none';
        loadCommissions();
      }, 2000);
    }
  }

  function addLog(message, type = 'info') {
    const log = document.getElementById('processLog');
    const div = document.createElement('div');
    div.className = type;
    div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  async function processInBatches(ids) {
    const BATCH_SIZE = 5;
    const DELAY_MS = 500;
    const tok = localStorage.getItem(tokenKey);
   
    for (let i = 0; i < ids.length; i += BATCH_SIZE) {
      if (!isProcessing) break;
     
      // Esperar si est√° pausado
      while (isPaused && isProcessing) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
     
      if (!isProcessing) break;
     
      const batch = ids.slice(i, i + BATCH_SIZE);
      const promises = batch.map(id =>
        google.script.run
          .withSuccessHandler(() => ({ success: true, id }))
          .withFailureHandler(error => ({ success: false, id, error }))
          .payVendorCommission(tok, id, true)
      );
     
      try {
        const results = await Promise.all(promises);
       
        results.forEach(result => {
          processedCount++;
          if (result.success) {
            successCount++;
            addLog(`‚úÖ ${result.id}: Marcado como PAGADO`, 'success');
          } else {
            errorCount++;
            addLog(`‚ùå ${result.id}: Error - ${result.error.message || result.error}`, 'error');
          }
         
          // Actualizar UI
          const progress = (processedCount / ids.length) * 100;
          document.getElementById('processProgress').style.width = `${progress}%`;
          document.getElementById('successCount').textContent = successCount;
          document.getElementById('errorCount').textContent = errorCount;
        });
       
        // Peque√±o delay entre lotes
        if (i + BATCH_SIZE < ids.length) {
          await new Promise(resolve => setTimeout(resolve, DELAY_MS));
        }
       
      } catch (error) {
        addLog(`‚ùå Error en lote: ${error.message}`, 'error');
      }
    }
   
    // Finalizar
    isProcessing = false;
    addLog(`‚úÖ Proceso completado: ${successCount} exitosos, ${errorCount} fallados`, 'info');
   
    // Actualizar wallet y dashboard despu√©s de completar
    refreshWallet();
    refreshDashboard();
   
    // Cerrar autom√°ticamente despu√©s de 5 segundos
    setTimeout(() => {
      if (!isPaused) {
        document.getElementById('bulkProcessModal').style.display = 'none';
        loadCommissions();
      }
    }, 5000);
  }

  // =========================
  // Secuencia de IDs (admin)
  // =========================
  function loadSeqAdmin(){
    if (!me || me.role!=='ADMIN') return;
    const tok=localStorage.getItem(tokenKey);
    google.script.run
      .withSuccessHandler(res=>{
        document.getElementById('seq_prefix').textContent = res.prefix;
        document.getElementById('seq_pad').textContent    = res.pad;
        document.getElementById('seq_value').textContent  = res.value;
      })
      .withFailureHandler(e=>toast(e.message||e))
      .adminGetOrderCounter(tok);
  }
  function setSeq(){
    const tok=localStorage.getItem(tokenKey);
    const n = Number(document.getElementById('seq_new').value || '');
    if (!Number.isInteger(n) || n<0){ toast('Ingres√° un entero >= 0'); return; }
    google.script.run
      .withSuccessHandler(res=>{
        toast('Contador actualizado');
        document.getElementById('seq_value').textContent = res.value;
        document.getElementById('seq_new').value = '';
      })
      .withFailureHandler(e=>toast(e.message||e))
      .adminSetOrderCounter(tok, n);
  }

  // =========================
  // Reset de contrase√±a
  // =========================
  function openResetRequest(){ document.getElementById('resetReqModal').style.display='flex'; }
  function closeResetRequest(){ document.getElementById('resetReqModal').style.display='none'; }
  function submitResetRequest(){
    const email = (document.getElementById('reset_email').value||'').trim();
    if (!email){ toast('Ingres√° tu email'); return; }
    google.script.run
      .withSuccessHandler(()=>{ toast('Si el email existe, te enviamos un enlace'); closeResetRequest(); })
      .withFailureHandler(e=>toast(e.message||e))
      .requestPasswordReset(email);
  }

  function openResetSet(){ document.getElementById('resetSetModal').style.display='flex'; }
  function closeResetSet(){ document.getElementById('resetSetModal').style.display='none'; }
  function submitResetSet(){
    const p1 = (document.getElementById('reset_newpass').value||'');
    const p2 = (document.getElementById('reset_newpass2').value||'');
    if (!p1 || !p2){ toast('Complet√° ambas contrase√±as'); return; }
    if (p1 !== p2){ toast('Las contrase√±as no coinciden'); return; }
    const tok = window._pendingResetToken || '';
    if (!tok){ toast('Token inv√°lido'); return; }
    google.script.run
      .withSuccessHandler(res=>{
        toast('Contrase√±a actualizada');
        if (res?.session?.token){
          localStorage.setItem(tokenKey, res.session.token);
          closeResetSet();
          init();
        } else {
          closeResetSet();
        }
      })
      .withFailureHandler(e=>toast(e.message||e))
      .resetPasswordWithToken(tok, p1);
  }

  // =========================
  // Cierres (ADMIN y PROVEEDOR): Estado 1 editable + sin "eliminar"
  // =========================
  function getOrderFeeForDelivery(o){
    const asentada = Number(o.delivery_fee_gs||0);
    if (asentada > 0) return asentada;
    const em = norm(String(o.assigned_delivery||'')); const ct = norm(String(o.city||'')); const byDel = allRatesMap[em] || {};
    return Number(byDel[ct]||0);
  }
 
  // === NUEVO: Funci√≥n para calcular pedidos asignados hoy ===
  function calculateAssignedToday(rows, f, t, dsel) {
    const today = new Date().toISOString().slice(0, 10); // Fecha actual en formato YYYY-MM-DD
    const assignedToday = rows.filter(o => {
      const assignedDate = o.assigned_at ? new Date(o.assigned_at).toISOString().slice(0, 10) : null;
      if (!assignedDate || assignedDate !== today) return false;
      if (dsel && String(o.assigned_delivery||'').toLowerCase()!==dsel) return false;
      return true;
    });
    return assignedToday.length;
  }
 
  // === NUEVO: Funci√≥n para alternar estado de rendici√≥n ===
  function toggleRendicion() {
    const btn = document.getElementById('rendicionBtn');
    if (btn.classList.contains('pendiente')) {
      btn.classList.remove('pendiente');
      btn.classList.add('rendido');
      btn.textContent = 'RENDIDO HOY';
      toast('Estado cambiado a RENDIDO');
    } else {
      btn.classList.remove('rendido');
      btn.classList.add('pendiente');
      btn.textContent = 'PENDIENTE DE RENDIR';
      toast('Estado cambiado a PENDIENTE');
    }
  }

  // === NUEVO: Funci√≥n para cargar cierres con KPIs detallados ===
  function loadClosuresDetailed() {
    const tok = localStorage.getItem(tokenKey);
    const f = document.getElementById('cl_from')?.value || '';
    const t = document.getElementById('cl_to')?.value || '';
    const d = document.getElementById('cl_delivery')?.value || '';
   
    google.script.run
      .withSuccessHandler(result => {
        // Actualizar KPIs detallados
        document.getElementById('cl_k_entregados_cnt').textContent = nf(result.entregados.count);
        document.getElementById('cl_k_entregados_rev').textContent = nf(result.entregados.revenue);
       
        document.getElementById('cl_k_encomiendas_cnt').textContent = nf(result.encomiendas.count);
        document.getElementById('cl_k_encomiendas_rev').textContent = nf(result.encomiendas.revenue);
       
        document.getElementById('cl_k_delivery_fee').textContent = nf(result.entregados.delivery_fee);
        document.getElementById('cl_k_net_rendir').textContent = nf(result.entregados.net);
        document.getElementById('cl_k_assigned_today').textContent = nf(result.today_assigned);
      })
      .withFailureHandler(e => toast(e.message || e))
      .getClosuresDetailedKPIs(tok, f, t, d);
  }

  function loadClosures(){
    // Cargar KPIs detallados
    loadClosuresDetailed();
   
    // Mantener el resto de la l√≥gica para la tabla
    const tok = localStorage.getItem(tokenKey);
    const f = (document.getElementById('cl_from')?.value||'');
    const t = (document.getElementById('cl_to')?.value||'');
    const dsel = (document.getElementById('cl_delivery')?.value||'').trim().toLowerCase();
    const type = (document.getElementById('cl_type')?.value||'').trim().toUpperCase();

    const afterOrders = (rows)=>{
      const from = f? new Date(f+'T00:00:00') : new Date('1970-01-01');
      const to   = t? new Date(t+'T23:59:59') : new Date('2999-12-31');

      const base = (rows||[]).filter(o=>{
        const baseDate = o.assigned_at ? new Date(o.assigned_at) : (o.created_at? new Date(o.created_at): null);
        if (!baseDate || baseDate<from || baseDate>to) return false;
        if (dsel && String(o.assigned_delivery||'').toLowerCase()!==dsel) return false;
        return true;
      });

      const tableRows = base.filter(o=>{ if (!type) return true; return String(o.status||'').toUpperCase()===type; });

      const delivered = base.filter(o=> String(o.status||'').toUpperCase()==='ENTREGADO');
      const cnt = delivered.length;
      let sumTotal=0, sumFee=0;
      delivered.forEach(o=>{ sumTotal += Number(o.total_gs||0); sumFee   += getOrderFeeForDelivery(o); });
      const net = sumTotal - sumFee;

      // === NUEVO: Control de Rendici√≥n (auto monto + refrescar estado/nota) ===
      window.currentRendicionMonto = net;
      try {
        const selEl = document.getElementById('cl_delivery');
        const nameEl = document.getElementById('rendicion_delivery_name');
        const totalEl = document.getElementById('rendicion_total_pagar');
        const fechaEl = document.getElementById('rendicion_fecha');
        const fechaISO = (document.getElementById('cl_from')?.value || new Date().toISOString().slice(0,10));
        if (nameEl) {
          const optText = selEl?.options?.[selEl.selectedIndex]?.textContent || dsel || 'Seleccione un delivery';
          nameEl.textContent = optText;
        }
        if (totalEl) totalEl.textContent = nf(net) + ' Gs';
        if (fechaEl) fechaEl.textContent = fechaISO;
        if (dsel) refreshRendicionStatus(dsel, fechaISO);
      } catch(e) {}

      // === NUEVO: Calcular pedidos asignados hoy ===
      const assignedToday = calculateAssignedToday(rows, f, t, dsel);

      // === NUEVO: Mostrar bot√≥n de rendici√≥n solo para ADMIN ===
      const rendicionContainer = document.getElementById('rendicionBtnContainer');
      if (me?.role === 'ADMIN') {
        rendicionContainer.classList.remove('hidden');
      } else {
        rendicionContainer.classList.add('hidden');
      }

      const tb = document.getElementById('cl_tbody'); tb.innerHTML='';
      const state1Opts = ['PENDIENTE','EN RUTA','ENTREGADO','ENCOMIENDA ENTREGADA','CANCELADO','REAGENDADO','NO CONTESTA','RECHAZADO','RECHAZADO EN EL LUGAR','NO DESEA','CANCEL√ì POR WHATSAPP','DEVUELTO A DEP√ìSITO'];

      tableRows.sort((a,b)=> new Date(a.assigned_at||a.created_at) - new Date(b.assigned_at||b.created_at))
        .forEach(o=>{
          const fee = getOrderFeeForDelivery(o);
          const neto = Number(o.total_gs||0) - fee;
          const badgeS2 = o.status2 ? `<span class="badge">${o.status2}</span>` : '';
         
          // === NUEVO: Selector para Estado de Retiro ===
          const retiroOpts = ['PENDIENTE','REALIZADO','CANCELADO'];
          const retiroSel = `<select class="retiro-select" data-id="${o.id}" onchange="updateRetiroStatus('${o.id}', this.value)">
            ${retiroOpts.map(r=>`<option value="${r}" ${r===o.estado_retiro?'selected':''}>${r}</option>`).join('')}
          </select>`;
         
          const s1Sel = (me?.role==='ADMIN' || me?.role==='PROVEEDOR')
            ? `<select class="clo_s1" data-id="${o.id}">
                ${state1Opts.map(s=>`<option value="${s}" ${s===o.status?'selected':''}>${s}</option>`).join('')}
               </select>`
            : (o.status||'');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${new Date(o.assigned_at||o.created_at).toLocaleString('es-PY')}</td>
            <td>${o.id}</td>
            <td>${o.city||''}</td>
            <td>${o.customer_name||''}</td>
            <td class="right">${nf(o.total_gs)}</td>
            <td class="right">${nf(fee)}</td>
            <td class="right">${nf(neto)}</td>
            <td>${s1Sel}</td>
            <td>${retiroSel}</td>
            <td>
              ${badgeS2}
              <select class="clo_s2" data-id="${o.id}">
                <option value="">-- Elegir --</option>
                <option value="DEVUELTO A DEP√ìSITO">DEVUELTO A DEP√ìSITO</option>
                <option value="SALI√ì EN RUTA NUEVAMENTE">SALI√ì EN RUTA NUEVAMENTE</option>
              </select>
            </td>`;
          tb.appendChild(tr);
        });

      tb.querySelectorAll('.clo_s1').forEach(sel=>{
        sel.onchange=(e)=>{
          // Usar la funci√≥n unificada
          updateOrderStatusUnified(e.target);
        };
      });

      tb.querySelectorAll('.clo_s2').forEach(sel=>{
        sel.onchange=(e)=>{
          const orderId = e.target.getAttribute('data-id');
          const choice  = e.target.value;
          if (!choice) return;
         
          // Deshabilitar durante actualizaci√≥n
          e.target.disabled = true;
          e.target.classList.add('updating');
          const previousStatus = e.target.value;
         
          google.script.run
            .withSuccessHandler(()=>{
              e.target.disabled = false;
              e.target.classList.remove('updating');
              e.target.classList.add('success-flash');
              setTimeout(() => e.target.classList.remove('success-flash'), 800);
              toast('Estado 2 (cierre) guardado ‚úì');
            })
            .withFailureHandler(err=>{
              e.target.disabled = false;
              e.target.classList.remove('updating');
              e.target.classList.add('error-flash');
              setTimeout(() => e.target.classList.remove('error-flash'), 800);
              e.target.value = previousStatus;
              toast('Error: ' + (err.message||err));
            })
            .updateOrderStatus2(tok, orderId, choice);
        };
      });
      markUpdated();
    };

    if (Array.isArray(lastOrders) && lastOrders.length){
      afterOrders(lastOrders);
    } else {
      google.script.run.withSuccessHandler(rows=>{ lastOrders=rows; afterOrders(rows); })
        .withFailureHandler(e=>toast(e.message||e)).listOrders(tok);
    }
  }

 
  function togglePendingGuidesAdvanced(){
    const el = document.getElementById('pg_adv');
    if (!el) return;
    const show = (el.style.display === 'none' || !el.style.display);
    el.style.display = show ? 'block' : 'none';
  }

// === NUEVO: Vista Pedidos con gu√≠as Pendientes (l√≥gica)
  function wirePendingGuidesSearch(){
    const q=document.getElementById('pg_q');
    if (!q) return;
    let t=null;
    const trigger=()=>{ clearTimeout(t); t=setTimeout(renderPendingGuidesSimplified, 160); };
    // q.addEventListener('input', trigger); // desactivado: usar bot√≥n Filtrar
    q.addEventListener('keyup', (e)=>{ if (e.key==='Enter') renderPendingGuidesSimplified(); });
  }

  function isPendingGuideStatus(status2){
    const s = String(status2||'').trim().toUpperCase();
    // Consideramos "pendiente" todo lo que NO sea exactamente 'GUIA GENERADA'
    return (s === '' || s === '--' || s !== 'GUIA GENERADA');
  }

  // ===== NUEVA FUNCI√ìN: Cargar y filtrar pedidos con gu√≠as =====
 
  // ===== NUEVO: Limpiar filtros de Pedidos con gu√≠as =====
  function clearPendingGuidesFiltersSimplified(){
    const p = document.getElementById('pg_filter_provider');
    const tp = document.getElementById('pg_filter_tipo');
    const s = document.getElementById('pg_filter_status');
    const q = document.getElementById('pg_q');
    if (p) p.value = '';
    if (tp) tp.value = 'PENDIENTES';
    if (s) s.value = '';
    if (q) q.value = '';
    renderPendingGuidesSimplified();
  }

function renderPendingGuidesSimplified() {
    const providerEmail = document.getElementById('pg_filter_provider')?.value || '';
   const tipo = document.getElementById('pg_filter_tipo')?.value || 'PENDIENTES';
    const status = document.getElementById('pg_filter_status')?.value || '';
    const q = document.getElementById('pg_q')?.value || '';
    const f = document.getElementById('pg_from')?.value || '';
    const t = document.getElementById('pg_to')?.value || '';
   
    const tok = localStorage.getItem(tokenKey);
   
    // Usar la NUEVA funci√≥n para Despachante
    const filters = {
      providerEmail: providerEmail,
     tipo: tipo,
      status: status,
      q: q,
      fromISO: f,
      toISO: t
    };
   
    google.script.run
      .withSuccessHandler(rows => {
        // Actualizar KPI
        const k = document.getElementById('pg_k_cnt');
        if (k) k.textContent = nf(rows.length);
       
        // Renderizar tabla
        renderSimplifiedGuidesTable(rows);
      })
      .withFailureHandler(e => toast(e.message || e))
      .listDespachanteOrders(tok, filters);
  }

  // ================================================
  // üìÑ FUNCIONES PARA GU√çA LIMPIA (NUEVO FORMATO)
  // ================================================

  // Variables globales
  let selectedOrders = new Set();
  let selectedGuides = new Set();
  const MAX_BULK_GUIDES = 30;

  // Neto a rendir calculado en Cierres (para Control de Rendici√≥n)
  window.currentRendicionMonto = 0;

  function abrirGuiaLimpia(orderId) {
    if (!orderId) return;
   
    const tok = localStorage.getItem(tokenKey);
    if (!tok) { toast('No est√°s autenticado'); return; }
   
    toast('üìã Generando gu√≠a...');
   
    google.script.run
      .withSuccessHandler(function(resultado) {
        if (resultado.success && resultado.text) {
          const blob = new Blob([resultado.text], {
            type: 'text/plain;charset=utf-8'
          });
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank');
          setTimeout(() => URL.revokeObjectURL(url), 10000);
        }
      })
      .withFailureHandler(function(error) {
        toast('Error: ' + error.message);
      })
      .getGuideCleanText(tok, orderId);
  }

  function copiarGuiaLimpia(orderId) {
    const tok = localStorage.getItem(tokenKey);
    if (!tok) { toast('No est√°s autenticado'); return; }
   
    google.script.run
      .withSuccessHandler(function(resultado) {
        if (resultado.success && resultado.text) {
          navigator.clipboard.writeText(resultado.text)
            .then(() => toast('‚úÖ Gu√≠a copiada'))
            .catch(() => {
              const textarea = document.createElement('textarea');
              textarea.value = resultado.text;
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand('copy');
              document.body.removeChild(textarea);
              toast('‚úÖ Texto copiado ‚úì');
            });
        }
      })
      .withFailureHandler(error => toast('Error: ' + error.message))
      .getGuideCleanText(tok, orderId);
  }

  // =========================
  // üéØ FUNCIONES PARA SELECCI√ìN MASIVA
  // =========================

  function updateSelectionCounter() {
    const totalSelected = selectedOrders.size + selectedGuides.size;
    const counter = document.querySelector('.selection-counter .number');
    const limit = document.querySelector('.selection-counter .limit');
   
    if (counter) counter.textContent = totalSelected;
    if (limit) limit.textContent = '/30';
   
    updateBulkUI();
  }

  function toggleBulkSelection(orderId, checked, tableType) {
    const isOrders = tableType === 'orders';
    const targetSet = isOrders ? selectedOrders : selectedGuides;
    const currentTotal = selectedOrders.size + selectedGuides.size;
   
    if (checked && currentTotal >= MAX_BULK_GUIDES) {
      toast(`‚ö†Ô∏è M√°ximo ${MAX_BULK_GUIDES} gu√≠as`);
      return false;
    }
   
    if (checked) {
      targetSet.add(orderId);
    } else {
      targetSet.delete(orderId);
    }
   
    updateSelectionCounter();
    updateSelectAllCheckbox(tableType);
    updateRowSelection(orderId, checked);
    return true;
  }

  function toggleSelectAll(tableType) {
    const selectAllId = tableType === 'orders' ? 'selectAllOrders' : 'selectAllGuides';
    const selectAll = document.getElementById(selectAllId);
    const checkboxes = document.querySelectorAll(`.bulk-checkbox[data-type="${tableType}"]`);
    const targetSet = tableType === 'orders' ? selectedOrders : selectedGuides;
   
    const allChecked = selectAll.checked;
    let count = 0;
   
    checkboxes.forEach(cb => {
      if (!cb.disabled) {
        cb.checked = allChecked;
        const orderId = cb.getAttribute('data-id');
       
        if (allChecked) {
          if (count < MAX_BULK_GUIDES) {
            targetSet.add(orderId);
            count++;
          } else {
            cb.checked = false;
          }
        } else {
          targetSet.delete(orderId);
        }
       
        updateRowSelection(orderId, allChecked && count <= MAX_BULK_GUIDES);
      }
    });
   
    updateSelectionCounter();
    updateSelectAllCheckbox(tableType);
   
    if (allChecked && count >= MAX_BULK_GUIDES) {
      toast(`‚ö†Ô∏è M√°ximo ${MAX_BULK_GUIDES} gu√≠as seleccionadas`);
    }
  }

  function clearBulkSelection() {
    selectedOrders.clear();
    selectedGuides.clear();
   
    document.querySelectorAll('.bulk-checkbox').forEach(cb => cb.checked = false);
    document.querySelectorAll('#selectAllOrders, #selectAllGuides').forEach(cb => {
      cb.checked = false;
      cb.indeterminate = false;
    });
   
    updateSelectionCounter();
    updateBulkUI();
    toast('‚úÖ Selecci√≥n limpiada');
  }

  function updateBulkUI() {
    const totalSelected = selectedOrders.size + selectedGuides.size;
   
    updateSelectionCounter();
   
    const bulkHeader = document.getElementById('bulkActionsHeader');
    const pdfCountSpan = document.getElementById('pdfCount');
    const txtCountSpan = document.getElementById('txtCount');
    const selectedCountSpan = document.getElementById('selectedCount');
    const pdfBtn = document.getElementById('bulkPrintBtn');
    const txtBtn = document.getElementById('bulkTxtBtn');
    const bulkUpdateBtn = document.getElementById('bulkUpdateProvidersBtn');
    const updateAllBtn = document.getElementById('updateAllProvidersBtn');
   
    if (!bulkHeader || !pdfCountSpan || !txtCountSpan || !pdfBtn || !txtBtn) return;
   
    if (totalSelected > 0) {
      bulkHeader.classList.remove('hidden');
     
      pdfCountSpan.textContent = totalSelected;
      txtCountSpan.textContent = totalSelected;
      if (selectedCountSpan) selectedCountSpan.textContent = totalSelected;
     
      if (totalSelected > MAX_BULK_GUIDES) {
        pdfBtn.disabled = true;
        txtBtn.disabled = true;
        if (bulkUpdateBtn) bulkUpdateBtn.disabled = true;
        pdfBtn.innerHTML = `üñ®Ô∏è PDF (${totalSelected}) ‚ùå`;
        txtBtn.innerHTML = `üìÑ TXT (${totalSelected}) ‚ùå`;
        if (bulkUpdateBtn) bulkUpdateBtn.innerHTML = `üîÑ Proveedores (${totalSelected}) ‚ùå`;
      } else {
        pdfBtn.disabled = false;
        txtBtn.disabled = false;
        if (bulkUpdateBtn) bulkUpdateBtn.disabled = false;
        pdfBtn.innerHTML = `üñ®Ô∏è PDF (${totalSelected})`;
        txtBtn.innerHTML = `üìÑ TXT (${totalSelected})`;
        if (bulkUpdateBtn) bulkUpdateBtn.innerHTML = `üîÑ Proveedores (${totalSelected})`;
      }
     
      if (updateAllBtn) updateAllBtn.disabled = false;
    } else {
      bulkHeader.classList.add('hidden');
    }
  }

  function generateBulkTXT() {
    const allSelected = [...selectedOrders, ...selectedGuides];
   
    if (allSelected.length === 0) {
      toast('Seleccion√° al menos una gu√≠a');
      return;
    }
   
    if (allSelected.length > MAX_BULK_GUIDES) {
      toast(`M√°ximo ${MAX_BULK_GUIDES} gu√≠as`);
      return;
    }
   
    if (!confirm(`¬øGenerar TXT con ${allSelected.length} gu√≠as?`)) return;
   
    const tok = localStorage.getItem(tokenKey);
    toast(`üìÑ Generando TXT...`);
   
    const txtBtn = document.getElementById('bulkTxtBtn');
    if (txtBtn) txtBtn.disabled = true;
   
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success) {
          const binaryString = atob(result.base64Data);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
         
          const blob = new Blob([bytes], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
         
          const a = document.createElement('a');
          a.href = url;
          a.download = result.fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
         
          setTimeout(() => URL.revokeObjectURL(url), 1000);
          toast(`‚úÖ TXT descargado`);
         
        } else {
          toast('‚ùå Error al generar TXT');
        }
        if (txtBtn) txtBtn.disabled = false;
      })
      .withFailureHandler(function(error) {
        toast(`‚ùå Error: ${error.message || error}`);
        if (txtBtn) txtBtn.disabled = false;
      })
      .generateBulkGuidesTXT(tok, allSelected);
  }

  function generateBulkPDF() {
    const allSelected = [...selectedOrders, ...selectedGuides];
   
    if (allSelected.length === 0) {
      toast('Seleccion√° al menos una gu√≠a');
      return;
    }
   
    if (allSelected.length > MAX_BULK_GUIDES) {
      toast(`M√°ximo ${MAX_BULK_GUIDES} gu√≠as`);
      return;
    }
   
    if (!confirm(`¬øGenerar PDF con ${allSelected.length} gu√≠as?`)) return;
   
    const tok = localStorage.getItem(tokenKey);
    toast(`‚è≥ Generando PDF...`);
   
    const pdfBtn = document.getElementById('bulkPrintBtn');
    if (pdfBtn) pdfBtn.disabled = true;
   
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success) {
          window.open(result.downloadUrl || result.url, '_blank');
          toast(`‚úÖ PDF listo`);
        } else {
          toast('‚ùå Error al generar PDF');
        }
        if (pdfBtn) pdfBtn.disabled = false;
      })
      .withFailureHandler(function(error) {
        toast(`‚ùå Error: ${error.message || error}`);
        if (pdfBtn) pdfBtn.disabled = false;
      })
      .generateBulkGuidesPDF(tok, allSelected);
  }

  function initSelectionCounter() {
    updateSelectionCounter();
  }

  function updateSelectAllCheckbox(tableType) {
    const selectAllId = tableType === 'orders' ? 'selectAllOrders' : 'selectAllGuides';
    const selectAll = document.getElementById(selectAllId);
    if (!selectAll) return;
   
    const targetSet = tableType === 'orders' ? selectedOrders : selectedGuides;
    const checkboxes = document.querySelectorAll(`.bulk-checkbox[data-type="${tableType}"]`);
   
    if (checkboxes.length === 0) {
      selectAll.checked = false;
      selectAll.indeterminate = false;
      return;
    }
   
    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
   
    if (checkedCount === 0) {
      selectAll.checked = false;
      selectAll.indeterminate = false;
    } else if (checkedCount === checkboxes.length) {
      selectAll.checked = true;
      selectAll.indeterminate = false;
    } else {
      selectAll.checked = false;
      selectAll.indeterminate = true;
    }
  }

  function updateRowSelection(orderId, checked) {
    const rows = document.querySelectorAll('tr');
    rows.forEach(row => {
      const checkbox = row.querySelector(`.bulk-checkbox[data-id="${orderId}"]`);
      if (checkbox) {
        if (checked) {
          row.classList.add('selected-row');
        } else {
          row.classList.remove('selected-row');
        }
      }
    });
  }

  // =========================
  // ===== NUEVO: Funciones para actualizar proveedores de pedidos =====
  // =========================

  // Funci√≥n para actualizar proveedores de pedidos seleccionados
  function updateSelectedProviders() {
    const selectedIds = Array.from(selectedOrders);
    if (selectedIds.length === 0) {
      toast('Seleccion√° al menos un pedido');
      return;
    }
   
    if (!confirm(`¬øActualizar proveedores de ${selectedIds.length} pedidos seleccionados?`)) {
      return;
    }
   
    const tok = localStorage.getItem(tokenKey);
    let completed = 0;
    let errors = 0;
   
    toast(`Procesando ${selectedIds.length} pedidos...`);
   
    selectedIds.forEach((orderId, index) => {
      setTimeout(() => {
        google.script.run
          .withSuccessHandler(result => {
            completed++;
            console.log(`‚úÖ ${orderId}:`, result.providers);
           
            if (completed + errors === selectedIds.length) {
              toast(`‚úÖ Completado: ${completed} actualizados, ${errors} errores`);
              refreshOrders(); // Recargar pedidos
            }
          })
          .withFailureHandler(error => {
            errors++;
            console.error(`‚ùå ${orderId}:`, error);
           
            if (completed + errors === selectedIds.length) {
              toast(`‚úÖ Completado: ${completed} actualizados, ${errors} errores`);
              refreshOrders();
            }
          })
          .updateOrderProviders(tok, orderId);
      }, index * 500); // Delay para no saturar
    });
  }

  // Funci√≥n para actualizar TODOS los pedidos
  function updateAllProviders() {
    if (!confirm('¬øActualizar proveedores de TODOS los pedidos?\nEsto puede tomar unos minutos.')) {
      return;
    }
   
    const tok = localStorage.getItem(tokenKey);
   
    google.script.run
      .withSuccessHandler(result => {
        toast(`‚úÖ ${result.message}`);
        console.log('Resultado batch:', result);
        refreshOrders(); // Recargar pedidos
      })
      .withFailureHandler(error => {
        toast('‚ùå Error: ' + error.message);
      })
      .updateAllOrdersProviders(tok);
  }

  // Funci√≥n para verificar proveedores de un pedido espec√≠fico
  function debugOrderProviders(orderId) {
    const order = lastOrders.find(o => String(o.id) === String(orderId));
    if (!order) {
      toast('Pedido no encontrado');
      return;
    }
   
    const tok = localStorage.getItem(tokenKey);
   
    google.script.run
      .withSuccessHandler(result => {
        alert(`DEBUG - Pedido ${orderId}:\n\n` +
              `Items: ${order.items_json}\n` +
              `Proveedores calculados: ${result.providers}\n` +
              `Proveedores guardados: ${order.provider_emails_list || '(vac√≠o)'}\n\n` +
              `¬øActualizar?`);
      })
      .withFailureHandler(error => {
        toast('Error: ' + error.message);
      })
      .updateOrderProviders(tok, orderId);
  }

  // Funci√≥n para actualizar un solo pedido
  function updateSingleProvider(orderId) {
    const tok = localStorage.getItem(tokenKey);
   
    google.script.run
      .withSuccessHandler(result => {
        toast(`‚úÖ ${orderId}: ${result.providers || 'Sin proveedores'}`);
        refreshOrders(); // Recargar para ver cambios
      })
      .withFailureHandler(error => {
        toast('‚ùå Error: ' + error.message);
      })
      .updateOrderProviders(tok, orderId);
  }

  // =========================
  // NUEVAS FUNCIONES DE DEBUG PARA PROVEEDOR
  // =========================
  function debugProducts(){
    const tok = localStorage.getItem(tokenKey);
    google.script.run
      .withSuccessHandler(result => {
        console.log('DEBUG PRODUCTOS:', result);
        alert(`DEBUG PRODUCTOS:\n\nTotal productos: ${result.totalProductos}\nProductos del proveedor: ${result.productosProveedor.length}\nProductos p√∫blicos: ${result.productosPublicos.length}\nProductos privados: ${result.productosPrivados.length}`);
      })
      .withFailureHandler(e => {
        console.error('Error debug:', e);
        toast('Error en debug: ' + e.message);
      })
      .debugProducts(tok);
  }

  function debugProviderData(){
    const tok = localStorage.getItem(tokenKey);
    google.script.run
      .withSuccessHandler(result => {
        console.log('DEBUG PROVEEDOR:', result);
        const msg = `DEBUG PROVEEDOR COMPLETO:\n\nUsuario: ${result.usuario.email} (${result.usuario.rol})\nTotal productos: ${result.totalProductos}\nMis productos: ${result.productosProveedor.length}\nPedidos con mis productos: ${result.pedidosConMisProductos}\n\nMis SKUs: ${result.misSKUs.join(', ')}`;
        alert(msg);
      })
      .withFailureHandler(e => {
        console.error('Error debug:', e);
        toast('Error en debug: ' + e.message);
      })
      .debugProviderData(tok);
  }

  // =========================
  // === NUEVO: Funciones para filtros simplificados ===
  // =========================

  function applyAdvancedFiltersSimplified() {
    const providerEmail = document.getElementById('filter_provider')?.value || '';
    const status = document.getElementById('filter_status')?.value || '';
    const q = document.getElementById('orderSearch')?.value || '';
   
    // Construir filtros b√°sicos
    const filters = {
      providerEmail: providerEmail,
      status: status,
      q: q,
      fromISO: document.getElementById('of_from')?.value || '',
      toISO: document.getElementById('of_to')?.value || ''
    };
   
    applyFiltersForCurrentRole(filters);
  }

  function clearAdvancedFiltersSimplified() {
    document.getElementById('filter_provider').value = '';
    document.getElementById('filter_status').value = '';
    document.getElementById('orderSearch').value = '';
    renderOrdersLast();
  }

  // ===== NUEVA FUNCI√ìN: Renderizar tabla de gu√≠as con proveedores =====
  function renderSimplifiedGuidesTable(rows) {
    const tb = document.getElementById('pg_tbody');
    if (!tb) return;
   
    tb.innerHTML = '';
   
    const state2Opts = ['--','GUIA GENERADA','FUERA DE COBERTURA','CANCELADO','REPETIDO','RENDIDO'];
   
    rows.forEach(o => {
      const s2Sel = (me && (me.role==='ADMIN' || me.role==='DESPACHANTE' || me.role==='PROVEEDOR'))
        ? `<select class="pg_s2" data-id="${o.id}">
         ${state2Opts.map(s=>`<option value="${s}" ${s===o.status2?'selected':''}>${s}</option>`).join('')}
       </select>`
        : `<span class="badge">${o.status2||'--'}</span>`;

      // NUEVO: Mostrar proveedores
      const providersHtml = o.provider_emails_list
        ? `<div class="provider-display" style="position: relative;">
          <span class="chip provider-chip" title="${o.provider_emails_list}">
            ${o.provider_emails_list.split(',')[0].split('@')[0]}
            ${o.provider_emails_list.split(',').length > 1 ? ` +${o.provider_emails_list.split(',').length-1}` : ''}
          </span>
        </div>`
        : '<span class="chip muted">Sin proveedor</span>';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:center;">
          <input type="checkbox" class="bulk-checkbox" data-id="${o.id}" data-type="guides" title="Seleccionar para impresi√≥n masiva">
        </td>
        <td>${new Date(o.created_at).toLocaleString('es-PY')}</td>
        <td>${o.id}</td>
        <td>${o.city||''}</td>
        <td>${o.customer_name||''}</td>
        <td>${o.created_by||''}</td>
        <td>${providersHtml}</td>
        <td>${s2Sel}</td>
        <td>
          <div class="row" style="gap:4px; flex-wrap:nowrap;">
            <button class="btn small" onclick="abrirGuiaLimpia('${o.id}')" style="padding:4px 8px; font-size:11px;">üìÑ</button>
            <button class="btn small" onclick="copiarGuiaLimpia('${o.id}')" style="padding:4px 8px; font-size:11px;">üìã</button>
          </div>
        </td>
      `;
     
      // Agregar event listener al checkbox
      const checkbox = tr.querySelector('.bulk-checkbox');
      if (checkbox) {
        checkbox.onchange = (e) => {
          const success = toggleBulkSelection(o.id, e.target.checked, 'guides');
          if (!success) e.target.checked = false;
        };
       
        // Marcar si ya est√° seleccionado
        checkbox.checked = selectedGuides.has(o.id);
        if (checkbox.checked) tr.classList.add('selected-row');
      }
     
      tb.appendChild(tr);
    });

    // Manejo de cambios en Estado 2
    tb.querySelectorAll('.pg_s2').forEach(sel => {
      sel.onchange = (e) => {
        const id = e.target.getAttribute('data-id');
        const val = e.target.value;
        const tok = localStorage.getItem(tokenKey);
       
        e.target.disabled = true;
        e.target.classList.add('updating');
        const previousStatus = e.target.value;
       
        google.script.run
          .withSuccessHandler(() => {
            e.target.disabled = false;
            e.target.classList.remove('updating');
            e.target.classList.add('success-flash');
            setTimeout(() => e.target.classList.remove('success-flash'), 800);
           
            // Actualizar el objeto en memoria
            const idx = (rows||[]).findIndex(o => String(o.id) === String(id));
            if (idx >= 0) { rows[idx].status2 = val; }
           
            renderSimplifiedGuidesTable(rows);
            toast('Estado 2 actualizado ‚úì');
          })
          .withFailureHandler(err => {
            e.target.disabled = false;
            e.target.classList.remove('updating');
            e.target.classList.add('error-flash');
            setTimeout(() => e.target.classList.remove('error-flash'), 800);
            e.target.value = previousStatus;
            toast('Error: ' + (err.message || err));
          })
          .updateOrderStatus2(tok, id, val);
      };
    });
   
    updateBulkUI();
  }

  function applyFiltersForCurrentRole(filters) {
    const tok = localStorage.getItem(tokenKey);
    const currentRole = me?.role;
   
    if (currentRole === 'ADMIN' || currentRole === 'PROVEEDOR' ||
        currentRole === 'DESPACHANTE' || currentRole === 'VENDEDOR') {
     
      // Usar filtros simplificados
      if (filters.providerEmail) {
        google.script.run
          .withSuccessHandler(orders => {
            lastOrders = orders;
            renderOrdersLast();
            toast(`‚úÖ ${orders.length} pedidos encontrados`);
          })
          .withFailureHandler(e => toast('‚ùå Error: ' + e.message))
          .getOrdersByProvider(tok, filters.providerEmail, filters);
      } else {
        google.script.run
          .withSuccessHandler(orders => {
            lastOrders = orders;
            renderOrdersLast();
            toast('‚úÖ Filtros aplicados');
          })
          .withFailureHandler(e => toast('‚ùå Error: ' + e.message))
          .listOrdersFiltered(tok, filters.fromISO, filters.toISO, filters.q, '', '');
      }
    } else {
      // Para otros roles, usar el filtro normal (aunque no deber√≠a llegar aqu√≠)
      applyAdvancedFilters();
    }
  }

  // === AGREGADO: Funciones para filtros avanzados ===

  // Mostrar/ocultar filtros avanzados
  function toggleAdvancedFilters() {
    const section = document.getElementById('advancedFiltersSection');
    if (section) {
      section.classList.toggle('hidden');
      if (!section.classList.contains('hidden')) {
        loadAdvancedFilterOptions();
      }
    }
  }

  // Limpiar filtros avanzados
  function clearAdvancedFilters() {
    ['filter_provider', 'filter_status'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    renderOrdersLast();
  }

  // =========================
  // === AGREGADO: 4 funciones NUEVAS para despacho por proveedor ===
  // =========================

  // === FUNCI√ìN PARA MOSTRAR BOT√ìN DE DESPACHO POR PROVEEDOR ===
  function showProviderDispatchButton(providerEmail, orders) {
    // Eliminar si ya existe
    clearProviderDispatch();
   
    // Crear bot√≥n
    const dispatchBtn = document.createElement('button');
    dispatchBtn.id = 'providerDispatchBtn';
    dispatchBtn.className = 'btn';
    dispatchBtn.style.cssText = `
      margin: 10px 0;
      background: linear-gradient(135deg, #9c27b0, #673ab7);
      color: white;
      font-weight: bold;
      display: block;
    `;
    dispatchBtn.innerHTML = `üöö Despachar ${orders.length} pedidos de ${providerEmail}`;
    dispatchBtn.onclick = () => {
      // Mostrar selector de delivery
      addDeliverySelectorForProvider(providerEmail, orders);
    };
   
    // Insertar despu√©s de los filtros avanzados
    const advancedSection = document.getElementById('advancedFiltersSection');
    if (advancedSection) {
      advancedSection.parentNode.insertBefore(dispatchBtn, advancedSection.nextSibling);
    }
  }

  // === FUNCI√ìN PARA AGREGAR SELECTOR DE DELIVERY ===
  function addDeliverySelectorForProvider(providerEmail, orders) {
    // Crear contenedor
    const container = document.createElement('div');
    container.id = 'providerDispatchContainer';
    container.className = 'row';
    container.style.cssText = 'gap: 10px; margin: 10px 0; align-items: center;';
   
    // Cargar delivery disponibles
    const tok = localStorage.getItem(tokenKey);
    google.script.run
      .withSuccessHandler(deliveries => {
        const selectOptions = deliveries.map(d =>
          `<option value="${d.email}">${d.name || d.email}</option>`
        ).join('');
       
        container.innerHTML = `
          <select id="providerDeliverySelect" style="min-width: 250px; padding: 8px;">
            <option value="">Seleccionar delivery...</option>
            ${selectOptions}
          </select>
          <button class="btn" onclick="assignAllProviderOrders()"
                  style="background: linear-gradient(135deg, #2196f3, #3f51b5);">
            ‚úÖ Asignar todos
          </button>
          <button class="btn" onclick="clearProviderDispatch()"
                  style="background: #ff6b6b;">
            ‚ùå Cancelar
          </button>
        `;
       
        // Insertar despu√©s del bot√≥n
        const dispatchBtn = document.getElementById('providerDispatchBtn');
        if (dispatchBtn) {
          dispatchBtn.parentNode.insertBefore(container, dispatchBtn.nextSibling);
        }
      })
      .listUsersByRole(tok, 'DELIVERY');
  }

  // === FUNCI√ìN PARA ASIGNAR TODOS LOS PEDIDOS DEL PROVEEDOR ===
  function assignAllProviderOrders() {
    const deliveryEmail = document.getElementById('providerDeliverySelect')?.value;
    const providerEmail = document.getElementById('filter_provider')?.value;
   
    if (!deliveryEmail) {
      toast('‚ùå Seleccion√° un delivery primero');
      return;
    }
   
    if (!providerEmail) {
      toast('‚ùå No hay proveedor seleccionado');
      return;
    }
   
    // Filtrar pedidos del proveedor actual
    const providerOrders = lastOrders.filter(order => {
      const providers = String(order.provider_emails_list || '').split(',').map(e => e.trim());
      return providers.includes(providerEmail);
    });
   
    const orderIds = providerOrders.map(o => o.id);
   
    if (orderIds.length === 0) {
      toast('‚ùå No hay pedidos para asignar');
      return;
    }
   
    if (!confirm(`¬øAsignar ${orderIds.length} pedidos de ${providerEmail} a ${deliveryEmail}?`)) {
      return;
    }
   
    const tok = localStorage.getItem(tokenKey);
   
    google.script.run
      .withSuccessHandler(result => {
        toast(`‚úÖ ${result.updated} pedidos asignados a ${deliveryEmail}`);
        clearProviderDispatch();
        refreshOrders();
      })
      .withFailureHandler(e => toast('‚ùå Error: ' + e.message))
      .bulkAssignToDelivery(tok, orderIds, deliveryEmail);
  }

  // === FUNCI√ìN PARA LIMPIAR EL DESPACHO POR PROVEEDOR ===
  function clearProviderDispatch() {
    const btn = document.getElementById('providerDispatchBtn');
    const container = document.getElementById('providerDispatchContainer');
   
    if (btn) btn.remove();
    if (container) container.remove();
  }

  // =========================
  // NUEVAS FUNCIONES PARA LAS ACTUALIZACIONES
  // =========================

  // === NUEVO: Funciones para Dashboard mejorado ===

  // Funci√≥n para cargar KPIs de comisiones pendientes
  function loadPendingCommissionsKPIs() {
    if (!me || (me.role !== 'ADMIN' && me.role !== 'PROVEEDOR')) return;
   
    const tok = localStorage.getItem(tokenKey);
    const f = document.getElementById('dash_from')?.value || '';
    const t = document.getElementById('dash_to')?.value || '';
   
    google.script.run
      .withSuccessHandler(result => {
        document.getElementById('kpi_total_pending').textContent = nf(result.total_pending);
        document.getElementById('kpi_vendors_pending').textContent = nf(result.vendors.length);
       
        const tb = document.getElementById('pending_vendors_tbody');
        if (tb) {
          tb.innerHTML = '';
          result.vendors.forEach(v => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${v.email}</td>
              <td class="right">${v.count}</td>
              <td class="right">${nf(v.amount)} Gs</td>
            `;
            tb.appendChild(tr);
          });
        }
      })
      .withFailureHandler(e => console.error('Error cargando comisiones pendientes:', e))
      .getPendingCommissionsKPIs(tok, f, t);
  }

  // Funci√≥n para cargar ganancia del delivery
  function loadDeliveryProfit() {
    if (!me || me.role !== 'DELIVERY') return;
   
    const tok = localStorage.getItem(tokenKey);
    const f = document.getElementById('dash_from')?.value || '';
    const t = document.getElementById('dash_to')?.value || '';
   
    google.script.run
      .withSuccessHandler(result => {
        document.getElementById('kpi_delivery_total_profit').textContent = nf(result.total_profit);
        document.getElementById('kpi_delivery_pending_profit').textContent = nf(result.pending_profit);
        document.getElementById('kpi_delivery_fees_count').textContent = nf(result.details.length);
      })
      .withFailureHandler(e => console.error('Error cargando ganancia delivery:', e))
      .getDeliveryProfit(tok, f, t);
  }

  // === NUEVO: Funciones para Ranking de Delivery ===

  // Cargar ranking de delivery
  function loadDeliveryRankingEnhanced() {
    const tok = localStorage.getItem(tokenKey);
    const f = document.getElementById('rank_from')?.value || '';
    const t = document.getElementById('rank_to')?.value || '';
    const provider = document.getElementById('rank_provider')?.value || '';
   
    google.script.run
      .withSuccessHandler(result => {
        updateRankingUI(result);
        updateRankingChart(result);
       
        // Si hay filtro de proveedor, mostrar mensaje
        if (provider) {
          toast(`üèÜ Ranking filtrado por proveedor: ${provider}`);
        }
      })
      .withFailureHandler(e => toast(e.message || e))
      .getDeliveryRankingWithProviderFilter(tok, f, t, provider);
  }

  // Actualizar UI del ranking
  function updateRankingUI(result) {
    // Actualizar KPIs
    document.getElementById('rank_total_delivery').textContent = nf(result.total_deliveries);
    document.getElementById('rank_avg_entregados').textContent = nf(result.averages.entregados);
    document.getElementById('rank_avg_efectividad').textContent = result.averages.efectividad.toFixed(1) + '%';
    document.getElementById('rank_best_efectividad').textContent = result.ranking.length > 0 ?
      result.ranking[0].efectividad + '%' : '0%';
    document.getElementById('rank_total_pedidos').textContent = nf(
      result.ranking.reduce((sum, d) => sum + d.entregados + d.encomiendas + d.cancelados, 0)
    );
   
    // Mostrar vista seg√∫n rol
    if (me.role === 'DELIVERY') {
      document.getElementById('fullRankingView').classList.add('hidden');
      document.getElementById('personalRankingView').classList.remove('hidden');
      updatePersonalRankingView(result);
    } else {
      document.getElementById('fullRankingView').classList.remove('hidden');
      document.getElementById('personalRankingView').classList.add('hidden');
      updateFullRankingView(result);
    }
  }

  // Vista completa para PROVEEDOR/ADMIN/DESPACHANTE
  function updateFullRankingView(result) {
    const tb = document.getElementById('ranking_tbody');
    if (!tb) return;
   
    tb.innerHTML = '';
   
    result.ranking.forEach(d => {
      const tr = document.createElement('tr');
      const posClass = d.position <= 3 ? `position-${d.position}` : 'position-other';
     
      tr.innerHTML = `
        <td><div class="position-badge ${posClass}">${d.position}</div></td>
        <td>${d.name || d.email}</td>
        <td class="right">${d.entregados}</td>
        <td class="right">${d.encomiendas}</td>
        <td class="right">${d.cancelados}</td>
        <td class="right">
          <span class="badge" style="background: ${getEffectivenessColor(d.efectividad)}">
            ${d.efectividad}%
          </span>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  // Vista personal para DELIVERY
  function updatePersonalRankingView(result) {
    if (!result.user_position) return;
   
    const d = result.user_position;
    const avg = result.averages;
   
    // Posici√≥n
    const posBadge = document.getElementById('my_position_badge');
    posBadge.textContent = d.position;
    posBadge.className = 'position-badge ' + (d.position <= 3 ? `position-${d.position}` : 'position-other');
   
    // Mis m√©tricas
    document.getElementById('my_efectividad').textContent = d.efectividad + '%';
    document.getElementById('my_entregados').textContent = d.entregados;
   
    // Comparaciones
    updateComparison('entregados', d.entregados, avg.entregados);
    updateComparison('encomiendas', d.encomiendas, avg.encomiendas);
    updateComparison('cancelados', d.cancelados, avg.cancelados);
    updateComparison('efectividad', d.efectividad, avg.efectividad);
   
    // Top 5
    const top5 = result.ranking.slice(0, 5);
    const tb = document.getElementById('top5_tbody');
    if (tb) {
      tb.innerHTML = '';
      top5.forEach(del => {
        const tr = document.createElement('tr');
        const isMe = del.email.toLowerCase() === me.email.toLowerCase();
       
        tr.innerHTML = `
          <td><div class="position-badge ${del.position <= 3 ? `position-${del.position}` : 'position-other'}">
            ${del.position}
          </div></td>
          <td>${isMe ? 'üë§ ' : ''}${del.name || del.email}</td>
          <td class="right">${del.entregados}</td>
          <td class="right">${del.efectividad}%</td>
        `;
        if (isMe) tr.style.background = 'rgba(124, 92, 255, 0.1)';
        tb.appendChild(tr);
      });
    }
  }

  // Actualizar comparaciones
  function updateComparison(metric, myValue, avgValue) {
    const diff = myValue - avgValue;
    const percent = avgValue > 0 ? Math.round((diff / avgValue) * 100) : 0;
   
    document.getElementById(`my_vs_avg_${metric}`).textContent =
      metric === 'efectividad' ? myValue.toFixed(1) + '%' : nf(myValue);
   
    const badge = document.getElementById(`my_vs_avg_${metric}_diff`);
    badge.textContent = diff > 0 ? `+${percent}%` : `${percent}%`;
   
    badge.className = 'comparison-badge ';
    if (metric === 'cancelados') {
      badge.className += diff < 0 ? 'better' : (diff > 0 ? 'worse' : 'neutral');
    } else {
      badge.className += diff > 0 ? 'better' : (diff < 0 ? 'worse' : 'neutral');
    }
  }

  // Actualizar gr√°fico de ranking
  function updateRankingChart(result) {
    const metric = document.getElementById('rank_metric')?.value || 'entregados';
    const ctx = document.getElementById('chartRanking')?.getContext('2d');
    if (!ctx) return;
   
    const top10 = result.ranking.slice(0, 10);
   
    if (CHART_RANKING) CHART_RANKING.destroy();
   
    CHART_RANKING = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: top10.map(d => d.name || d.email.split('@')[0]),
        datasets: [{
          label: metric.toUpperCase(),
          data: top10.map(d => d[metric]),
          backgroundColor: top10.map((d, i) =>
            i < 3 ? getMedalColor(i + 1) : 'rgba(54, 162, 235, 0.6)'
          ),
          borderColor: top10.map((d, i) =>
            i < 3 ? getMedalColor(i + 1, 1) : 'rgba(54, 162, 235, 1)'
          ),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: metric === 'efectividad' ? 'Porcentaje (%)' : 'Cantidad'
            }
          }
        }
      }
    });
  }

  // Helper para colores de efectividad
  function getEffectivenessColor(percent) {
    if (percent >= 90) return 'rgba(33, 192, 139, 0.3)';
    if (percent >= 80) return 'rgba(255, 193, 7, 0.3)';
    return 'rgba(255, 92, 124, 0.3)';
  }

  // Helper para colores de medallas
  function getMedalColor(position, opacity = 0.6) {
    const colors = {
      1: `rgba(255, 215, 0, ${opacity})`,    // Oro
      2: `rgba(192, 192, 192, ${opacity})`,  // Plata
      3: `rgba(205, 127, 50, ${opacity})`    // Bronce
    };
    return colors[position] || `rgba(54, 162, 235, ${opacity})`;
  }

  // === NUEVO: FUNCIONES PARA ASIGNAR PEDIDOS - ACTUALIZADAS ===
  // Variable global para almacenar los pedidos asignables
  let assignableOrders = [];
 
  function loadAssignableOrders() {
    const tok = localStorage.getItem(tokenKey);
    const f = (document.getElementById('as_from')?.value||'');
    const t = (document.getElementById('as_to')?.value||'');
    const q = (document.getElementById('as_q')?.value||'').trim();
   
    // NUEVO: Usar la funci√≥n espec√≠fica para asignaci√≥n
    const filters = {
      fromISO: f || '',
      toISO: t || '',
      q: q || ''
    };
   
    google.script.run
      .withSuccessHandler(rows => {
        assignableOrders = rows;
        renderAssignableOrders(rows);
      })
      .withFailureHandler(e => toast(e.message||e))
      .listOrdersForAssignment(tok, filters);
  }

  // === NUEVA FUNCI√ìN: renderAssignableOrders(rows) ===
  function renderAssignableOrders(rows) {
    const tb = document.getElementById('assign_tbody');
    if (!tb) return;
   
    tb.innerHTML = '';
   
    rows.forEach(o => {
      const isAssignedToMe = String(o.assigned_delivery||'').toLowerCase() === String(me?.email||'').toLowerCase();
      const isUnassigned = !o.assigned_delivery || o.assigned_delivery === '';
     
      let actionButton = '';
      if (me?.role === 'DELIVERY') {
        if (isAssignedToMe) {
          actionButton = `<span class="chip ok">Ya es tuyo</span>`;
        } else if (isUnassigned) {
          actionButton = `<button class="btn small" onclick="assignToSelf('${o.id}')">Tomar pedido</button>`;
        } else {
          // Pedido asignado a otro - no mostrar bot√≥n
          actionButton = `<span class="chip muted">Asignado a otro</span>`;
        }
      } else if (me?.role === 'ADMIN' || me?.role === 'PROVEEDOR') {
        const checkbox = `<input type="checkbox" class="orderCheckbox" data-id="${o.id}" ${isAssignedToMe ? 'disabled' : ''}>`;
        actionButton = checkbox;
      }
     
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${(me?.role === 'ADMIN' || me?.role === 'PROVEEDOR') ? actionButton : ''}</td>
        <td>${new Date(o.created_at).toLocaleString('es-PY')}</td>
        <td>${o.id}</td>
        <td>${o.city||''}</td>
        <td>${o.customer_name||''}</td>
        <td><span class="badge">${o.status||'PENDIENTE'}</span></td>
        <td>${o.assigned_delivery || '<span class="chip muted">Sin asignar</span>'}</td>
        <td>${(me?.role === 'ADMIN' || me?.role === 'PROVEEDOR') ? '' : actionButton}</td>
      `;
      tb.appendChild(tr);
    });
   
    markUpdated();
  }

  // === NUEVO: assignToSelf actualizada con validaci√≥n ===
  function assignToSelf(orderId) {
    const tok = localStorage.getItem(tokenKey);
    if (me?.role !== 'DELIVERY') {
      toast('Solo los delivery pueden auto-asignarse');
      return;
    }
   
    // Primero verificar que el pedido no est√© asignado a otro
    const order = assignableOrders.find(o => String(o.id) === String(orderId));
   
    if (order && order.assigned_delivery &&
        order.assigned_delivery.toLowerCase() !== me.email.toLowerCase()) {
      toast('Este pedido ya est√° asignado a otro delivery');
      return;
    }
   
    google.script.run
      .withSuccessHandler(() => {
        toast('Pedido asignado a ti');
        loadAssignableOrders(); // Recargar
        refreshOrders();
        refreshDashboard();
      })
      .withFailureHandler(e => toast(e.message||e))
      .assignOrderToSelf(tok, orderId); // Usar funci√≥n espec√≠fica
  }

  // === NUEVO: B√∫squeda en vivo para Asignar Pedidos ===
  function wireAssignSearch() {
    const qInput = document.getElementById('as_q');
    if (!qInput) return;
   
    let timer = null;
    const triggerSearch = () => {
      clearTimeout(timer);
      timer = setTimeout(loadAssignableOrders, 200);
    };
   
    qInput.addEventListener('input', triggerSearch);
    qInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') loadAssignableOrders();
    });
  }

  function bulkAssignSelected() {
    const tok = localStorage.getItem(tokenKey);
    const deliveryEmail = document.getElementById('as_delivery').value;
   
    if (!deliveryEmail) {
      toast('Seleccion√° un delivery primero');
      return;
    }

    const checkboxes = document.querySelectorAll('.orderCheckbox:checked:not(:disabled)');
    if (checkboxes.length === 0) {
      toast('Seleccion√° al menos un pedido');
      return;
    }

    // Confirmaci√≥n
    if (!confirm(`¬øEst√°s seguro de asignar ${checkboxes.length} pedidos a ${deliveryEmail}?`)) {
      return;
    }

    let successCount = 0;
    let errorCount = 0;
   
    // Procesar uno por uno
    checkboxes.forEach((checkbox, index) => {
      const orderId = checkbox.getAttribute('data-id');
     
      // Peque√±o delay para no saturar
      setTimeout(() => {
        google.script.run
          .withSuccessHandler(() => {
            successCount++;
            checkbox.checked = false;
            checkbox.disabled = true;
           
            if (successCount + errorCount === checkboxes.length) {
              toast(`Asignaci√≥n completada: ${successCount} exitosos, ${errorCount} fallidos`);
              loadAssignableOrders();
              refreshOrders();
              refreshDashboard();
            }
          })
          .withFailureHandler(() => {
            errorCount++;
           
            if (successCount + errorCount === checkboxes.length) {
              toast(`Asignaci√≥n completada: ${successCount} exitosos, ${errorCount} fallidos`);
              loadAssignableOrders();
              refreshOrders();
              refreshDashboard();
            }
          })
          .assignDelivery(tok, orderId, deliveryEmail);
      }, index * 300); // Delay de 300ms entre cada llamada
    });
   
    toast(`Procesando ${checkboxes.length} pedidos...`);
  }

  function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.orderCheckbox:not(:disabled)');
   
    checkboxes.forEach(cb => {
      cb.checked = selectAll.checked;
    });
  }
  // === FIN NUEVO: FUNCIONES PARA ASIGNAR PEDIDOS ===

  /* ===================== NUEVO: PERFIL ‚Äì funciones ===================== */
  function onOpenProfile(){
    // precarga del email/nombre si ya hay sesi√≥n
    const em = me?.email || '';
    const nm = me?.name || '';
    if (document.getElementById('pf_email')) document.getElementById('pf_email').value = em;
    if (document.getElementById('pf_name') && !document.getElementById('pf_name').value) document.getElementById('pf_name').value = nm;

    // === NUEVO: enganchar preview de foto ===
    wireProfilePhotoPreview();

    loadProfile();
  }

  function loadProfile(){
    const tok = localStorage.getItem(tokenKey);
    google.script.run
      .withSuccessHandler(p=>{
        // p puede venir vac√≠o si a√∫n no guardaste nada
        const v = p || {};
        pf_name.value  = v.name || (me?.name||'');
        pf_email.value = me?.email || '';
        pf_phone.value = v.phone || '';
        pf_doc.value   = v.doc || '';
        pf_addr.value  = v.addr || '';

        pf_bank_name.value   = v.bank_name || '';
        pf_bank_type.value   = v.bank_type || '';
        pf_bank_num.value    = v.bank_num || '';
        pf_bank_holder.value = v.bank_holder || '';
        pf_bank_holder_ci.value = v.bank_holder_ci || '';

        pf_wallet_provider.value = v.wallet_provider || '';
        pf_wallet_number.value   = v.wallet_number || '';
        pf_wallet_holder.value   = v.wallet_holder || '';
      })
      .withFailureHandler(()=>{/* solo preview */})
      .getMyProfile?.(tok); // ‚Üê si a√∫n no existe en GS, no rompe
  }

  function saveProfile(){
    const tok=localStorage.getItem(tokenKey);
    const payload = {
      name: pf_name.value.trim(),
      email: pf_email.value.trim(),
      phone: pf_phone.value.trim(),
      doc: pf_doc.value.trim(),
      addr: pf_addr.value.trim(),
      bank_name: pf_bank_name.value.trim(),
      bank_type: pf_bank_type.value.trim(),
      bank_num: pf_bank_num.value.trim(),
      bank_holder: pf_bank_holder.value.trim(),
      bank_holder_ci: pf_bank_holder_ci.value.trim(),
      wallet_provider: pf_wallet_provider.value.trim(),
      wallet_number: pf_wallet_number.value.trim(),
      wallet_holder: pf_wallet_holder.value.trim()
    };
    google.script.run
      .withSuccessHandler(()=>{ toast('Perfil guardado'); })
      .withFailureHandler(e=>{ toast(e.message||e); })
      .saveMyProfile?.(tok, payload); // ‚Üê si a√∫n no existe en GS, no rompe
  }

  // === NUEVA FUNCI√ìN: preview de foto local (no toca GS) ===
  function wireProfilePhotoPreview(){
    const file = document.getElementById('pf_file');
    const img  = document.getElementById('pf_avatar');
    if (!file || !img) return;
    // Evitar duplicar listeners si vuelven a abrir la pesta√±a
    file.onchange = null;
    file.addEventListener('change', ()=>{
      const f = file.files && file.files[0];
      if (!f) return;
      if (f.size > 2*1024*1024){ // 2MB
        toast('La imagen no debe superar 2MB');
        file.value = '';
        return;
      }
      img.src = URL.createObjectURL(f);
    }, { once:false });
  }
  /* ================== FIN PERFIL ================== */

  // =========================
  // üë• GESTI√ìN DE USUARIOS (ADMIN)
  // =========================
  function loadUsers() {
    if (!me || me.role !== 'ADMIN') return;
   
    const tok = localStorage.getItem(tokenKey);
    const search = document.getElementById('users_search')?.value || '';
    const roleFilter = document.getElementById('users_filter_role')?.value || '';
    const statusFilter = document.getElementById('users_filter_status')?.value || '';
   
    google.script.run
      .withSuccessHandler(users => {
        renderUsersTable(users, search, roleFilter, statusFilter);
        updateUsersKPIs(users);
      })
      .withFailureHandler(e => toast(e.message || e))
      .getAllUsersWithStatus(tok); // Nueva funci√≥n en Code.gs
  }

  function renderUsersTable(users, search, roleFilter, statusFilter) {
    const tb = document.getElementById('users_tbody');
    if (!tb) return;
   
    // Filtrar usuarios
    let filtered = users || [];
   
    if (search) {
      const searchNorm = norm(search);
      filtered = filtered.filter(u =>
        norm(u.name + ' ' + u.email + ' ' + u.role).includes(searchNorm)
      );
    }
   
    if (roleFilter) {
      filtered = filtered.filter(u => u.role === roleFilter);
    }
   
    if (statusFilter === 'online') {
      filtered = filtered.filter(u => u.is_online);
    } else if (statusFilter === 'offline') {
      filtered = filtered.filter(u => !u.is_online);
    }
   
    tb.innerHTML = '';
   
    filtered.forEach(u => {
      // Determinar estado
      let estadoBadge = '';
      if (u.status === 'PENDIENTE') {
        estadoBadge = `<span class="badge" style="background:#ffa72620; color:#ffa726;">‚è≥ PENDIENTE</span>`;
      } else if (u.is_online) {
        estadoBadge = `<span class="badge" style="background:#21c08b20; color:#21c08b;">‚úÖ En l√≠nea</span>`;
      } else {
        estadoBadge = `<span class="badge" style="background:#66666620; color:#aaa;">‚ö´ Offline</span>`;
      }
     
      // √öltima actividad
      const lastActive = u.last_active ?
        new Date(u.last_active).toLocaleString('es-PY') : 'Nunca';
     
      // Botones de acci√≥n
      let acciones = '';
      if (u.status === 'PENDIENTE') {
        acciones = `
          <div class="row" style="gap:4px;">
            <button class="btn small" onclick="aprobarUsuario('${u.email}')" style="background:#21c08b;">‚úÖ Aprobar</button>
            <button class="btn small" onclick="rechazarUsuario('${u.email}')" style="background:#ff5c7c;">‚ùå Rechazar</button>
          </div>
        `;
      } else {
        acciones = `
          <div class="row" style="gap:4px;">
            <button class="btn small" onclick="editarUsuario('${u.email}')">‚úèÔ∏è Editar</button>
            <button class="btn small" onclick="eliminarUsuario('${u.email}')" style="background:#ff5c7c;">üóëÔ∏è Eliminar</button>
          </div>
        `;
      }
     
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.name || 'Sin nombre'}</td>
        <td>${u.email}</td>
        <td><span class="chip">${u.role}</span></td>
        <td>${new Date(u.created_at).toLocaleDateString('es-PY')}</td>
        <td>${estadoBadge}</td>
        <td>${lastActive}</td>
        <td>${acciones}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function updateUsersKPIs(users) {
    if (!users) return;
   
    const total = users.length;
    const online = users.filter(u => u.is_online).length;
    const pending = users.filter(u => u.status === 'PENDIENTE').length;
    const vendors = users.filter(u => u.role === 'VENDEDOR').length;
    const delivery = users.filter(u => u.role === 'DELIVERY').length;
   
    document.getElementById('users_total').textContent = total;
    document.getElementById('users_online').textContent = online;
    document.getElementById('users_pending').textContent = pending;
    document.getElementById('users_vendors').textContent = vendors;
    document.getElementById('users_delivery').textContent = delivery;
  }

  function aprobarUsuario(email) {
    if (!confirm(`¬øAprobar usuario ${email}?`)) return;
   
    const tok = localStorage.getItem(tokenKey);
    google.script.run
      .withSuccessHandler(() => {
        toast('‚úÖ Usuario aprobado');
        loadUsers();
      })
      .withFailureHandler(e => toast('‚ùå Error: ' + e.message))
      .approveUser(tok, email);
  }

  function rechazarUsuario(email) {
    if (!confirm(`¬øRechazar usuario ${email}? Se eliminar√° permanentemente.`)) return;
   
    const tok = localStorage.getItem(tokenKey);
    google.script.run
      .withSuccessHandler(() => {
        toast('‚ùå Usuario rechazado');
        loadUsers();
      })
      .withFailureHandler(e => toast('‚ùå Error: ' + e.message))
      .rejectUser(tok, email);
  }

  function exportUsers() {
    // Implementar exportaci√≥n a CSV
    toast('üöß Exportaci√≥n en desarrollo');
  }

  // =========================
  // üè∑Ô∏è CONTROL DE RENDICI√ìN PAGADA
  // =========================
  function refreshRendicionStatus(deliveryEmail, fechaISO) {
    const box = document.getElementById('rendicionControlBox');
    if (!box) return;
    // Solo aplica si hay delivery seleccionado
    if (!deliveryEmail) {
      document.getElementById('rendicion_delivery_name').textContent = 'Seleccione un delivery';
      document.getElementById('rendicion_total_pagar').textContent = '0 Gs';
      document.getElementById('rendicion_fecha').textContent = 'Hoy';
      document.getElementById('rendicion_estado').textContent = '‚è≥ PENDIENTE';
      document.getElementById('rendicion_estado').style.background = '#ffa72620';
      document.getElementById('rendicion_estado').style.color = '#ffa726';
      document.getElementById('btnMarcarPagado').classList.remove('hidden');
      document.getElementById('btnDesmarcarPagado').classList.add('hidden');
      document.getElementById('rendicion_nota').value = '';
      window.currentRendicionMonto = 0;
      return;
    }

    const fecha = fechaISO || new Date().toISOString().slice(0,10);
    const sel = document.getElementById('cl_delivery');
    const selectedName = sel && sel.selectedOptions && sel.selectedOptions[0] ? (sel.selectedOptions[0].textContent || deliveryEmail) : deliveryEmail;
    document.getElementById('rendicion_delivery_name').textContent = selectedName;
    document.getElementById('rendicion_fecha').textContent = fecha;

    // Total a pagar (auto) desde KPIs de Cierres
    const monto = Number(window.currentRendicionMonto || 0);
    document.getElementById('rendicion_total_pagar').textContent = nf(monto) + ' Gs';

    const tok = localStorage.getItem(tokenKey);
    google.script.run
      .withSuccessHandler(rows => {
        const pagos = (rows || []).filter(r => String(r.delivery_email||'').toLowerCase()===String(deliveryEmail).toLowerCase()
          && String(r.fecha_rendicion||'')===String(fecha));
        // Si hay registro, est√° pagado
        if (pagos.length > 0) {
          const last = pagos[pagos.length-1];
          document.getElementById('btnMarcarPagado').classList.add('hidden');
          document.getElementById('btnDesmarcarPagado').classList.remove('hidden');
          document.getElementById('rendicion_estado').textContent = '‚úÖ PAGADO';
          document.getElementById('rendicion_estado').style.background = '#21c08b20';
          document.getElementById('rendicion_estado').style.color = '#21c08b';
          document.getElementById('rendicion_nota').value = last.nota || '';
        } else {
          document.getElementById('btnMarcarPagado').classList.remove('hidden');
          document.getElementById('btnDesmarcarPagado').classList.add('hidden');
          document.getElementById('rendicion_estado').textContent = '‚è≥ PENDIENTE';
          document.getElementById('rendicion_estado').style.background = '#ffa72620';
          document.getElementById('rendicion_estado').style.color = '#ffa726';
          document.getElementById('rendicion_nota').value = '';
        }
      })
      .withFailureHandler(e => {
        // Si falla la consulta, igual dejamos el monto visible
        console.error(e);
      })
      .getRendicionesPagadas(tok, deliveryEmail, fecha, fecha);
  }

  function marcarRendicionPagada() {
    const deliveryEmail = document.getElementById('cl_delivery')?.value || '';
    const fecha = document.getElementById('cl_from')?.value || new Date().toISOString().slice(0,10);
    const nota = document.getElementById('rendicion_nota')?.value || '';
   
    if (!deliveryEmail) {
      toast('‚ùå Seleccione un delivery primero');
      return;
    }
   
    if (!confirm(`¬øMarcar rendici√≥n de ${deliveryEmail} como PAGADA?\nFecha: ${fecha}\nNota: ${nota || 'Sin nota'}`)) {
      return;
    }
   
    const tok = localStorage.getItem(tokenKey);
   
    google.script.run
      .withSuccessHandler(() => {
        toast('‚úÖ Rendici√≥n marcada como PAGADA');
       
        // Actualizar UI
        document.getElementById('btnMarcarPagado').classList.add('hidden');
        document.getElementById('btnDesmarcarPagado').classList.remove('hidden');
        document.getElementById('rendicion_estado').textContent = '‚úÖ PAGADO';
        document.getElementById('rendicion_estado').style.background = '#21c08b20';
        document.getElementById('rendicion_estado').style.color = '#21c08b';
       
        // Guardar en historial
        saveRendicionHistory(deliveryEmail, fecha, nota);
      })
      .withFailureHandler(e => toast('‚ùå Error: ' + e.message))
      .markRendicionPagada(tok, deliveryEmail, fecha, Number(window.currentRendicionMonto||0), nota);
  }

  function desmarcarRendicionPagada() {
    const deliveryEmail = document.getElementById('cl_delivery')?.value || '';
   const fecha = document.getElementById('cl_from')?.value || new Date().toISOString().slice(0,10);
   
    if (!confirm(`¬øDesmarcar rendici√≥n de ${deliveryEmail} como pagada?`)) {
      return;
    }
   
    const tok = localStorage.getItem(tokenKey);
   
    google.script.run
      .withSuccessHandler(() => {
        toast('‚ö†Ô∏è Rendici√≥n desmarcada');
       
        // Actualizar UI
        document.getElementById('btnMarcarPagado').classList.remove('hidden');
        document.getElementById('btnDesmarcarPagado').classList.add('hidden');
        document.getElementById('rendicion_estado').textContent = '‚è≥ PENDIENTE';
        document.getElementById('rendicion_estado').style.background = '#ffa72620';
        document.getElementById('rendicion_estado').style.color = '#ffa726';
      })
      .withFailureHandler(e => toast('‚ùå Error: ' + e.message))
     .unmarkRendicionPagada(tok, deliveryEmail, fecha);
  }

  function saveRendicionHistory(deliveryEmail, fecha, nota) {
    // Guardar en localStorage para historial local
    const historyKey = 'rendicion_history';
    const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
   
    history.push({
      delivery: deliveryEmail,
      fecha: fecha,
      nota: nota,
      timestamp: new Date().toISOString(),
      marcadoPor: me?.email || 'Admin'
    });
   
    // Mantener solo √∫ltimos 100 registros
    if (history.length > 100) {
      history.shift();
    }
   
    localStorage.setItem(historyKey, JSON.stringify(history));
  }

  // =========================
  // üöö ESTADO DE RETIRO en CIERRES
  // =========================
  function updateRetiroStatus(orderId, status) {
    const tok = localStorage.getItem(tokenKey);
   
    google.script.run
      .withSuccessHandler(() => {
        toast(`‚úÖ Estado de retiro actualizado: ${status}`);
        loadClosures(); // Recargar la vista
      })
      .withFailureHandler(e => toast('‚ùå Error: ' + e.message))
      .updateRetiroStatus(tok, orderId, status);
  }

  // =========================
  // === NUEVO: Funci√≥n auxiliar para renderizar tabla de comisiones ===
  function renderCommissionsTable(rows) {
    const tb = document.getElementById('comms_tbody');
    if (!tb) return;
   
    tb.innerHTML = '';

    // KPIs (sirve para VENDEDOR y para cualquier render de esta tabla)
    const kCntEl = document.getElementById('pc_k_cnt');
    const kSumEl = document.getElementById('pc_k_sum');
    let sum = 0;
    (rows||[]).forEach(o=>{ sum += Number(o.commission_gs || 0); });
    if (kCntEl) kCntEl.textContent = nf((rows||[]).length);
    if (kSumEl) kSumEl.textContent = nf(sum);

   
    const state1Opts = ['ENTREGADO','ENCOMIENDA ENTREGADA'];
   
    rows.forEach(o => {
      const stateSel = `<select class="commStateSel" data-id="${o.id}">
        ${state1Opts.map(s=>`<option value="${s}" ${s===o.status?'selected':''}>${s}</option>`).join('')}
      </select>`;
      const selPay=`<select class="commPaySel" data-id="${o.id}">
        <option value="PENDIENTE" ${!o.commission_paid?'selected':''}>PENDIENTE</option>
        <option value="PAGADO" ${o.commission_paid?'selected':''}>PAGADO</option>
      </select>`;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${new Date(o.created_at).toLocaleString('es-PY')}</td>
        <td>${o.id}</td><td>${o.city||''}</td><td>${o.customer_name||''}</td><td>${o.vendor_email||''}</td>
        <td>${o.assigned_delivery||''}</td><td class="right">${nf(o.total_gs)}</td><td class="right">${nf(o.commission_gs)}</td>
        <td>${stateSel}</td>
        <td>${selPay} ${o.paid_at?`<span class="chip">${new Date(o.paid_at).toLocaleDateString('es-PY')}</span>`:''}</td>
        <td><button class="btn small" onclick="abrirGuiaLimpia('${o.id}')" style="padding:4px 8px; font-size:11px;">üìÑ</button></td>`;
      tb.appendChild(tr);
    });

    // Agregar event listeners
    tb.querySelectorAll('.commStateSel').forEach(s=>{
      s.onchange=(e)=>{
        updateOrderStatusUnified(e.target);
      };
    });
   
    tb.querySelectorAll('.commPaySel').forEach(s=>{
      s.onchange=(e)=>{
        const id=e.target.getAttribute('data-id'); const paid=(e.target.value==='PAGADO'); const tok=localStorage.getItem(tokenKey);
       
        e.target.disabled = true;
        e.target.classList.add('updating');
        const previousStatus = e.target.value;
       
        google.script.run.withSuccessHandler(()=>{
          e.target.disabled = false;
          e.target.classList.remove('updating');
          e.target.classList.add('success-flash');
          setTimeout(() => e.target.classList.remove('success-flash'), 800);
          toast('Pago comisi√≥n actualizado ‚úì');
          refreshWallet();
        })
        .withFailureHandler(err=>{
          e.target.disabled = false;
          e.target.classList.remove('updating');
          e.target.classList.add('error-flash');
          setTimeout(() => e.target.classList.remove('error-flash'), 800);
          e.target.value = previousStatus;
          toast('Error: ' + (err.message||err));
        })
        .payVendorCommission(tok,id,paid);
      };
    });
  }

  // Autoinicio
  (function boot(){
    const saved = localStorage.getItem(emailKey)||''; if (saved){ try{ li_email.value=saved; li_saveemail.checked=true; }catch(e){} }
    init();
  })();


  // =========================
  // üõí Shopify Inbox (pegado interno)
  // =========================

  function importShopifyPaste(){
    const tok = localStorage.getItem(tokenKey);
    const raw = document.getElementById('shopify_paste')?.value || '';
    if (!raw.trim()){ toast('Peg√° al menos 1 fila'); return; }
    const msg = document.getElementById('shopify_import_msg');
    if (msg) msg.textContent = 'Importando...';

    google.script.run
      .withSuccessHandler(res=>{
        if (msg) msg.textContent = `‚úÖ Importados: ${res.imported||0} | Repetidos: ${res.duplicates||0} | Total le√≠dos: ${res.total||0}`;
        toast('‚úÖ Importaci√≥n OK');
        loadShopifyInbox();
      })
      .withFailureHandler(e=>{
        if (msg) msg.textContent = '‚ùå Error';
        toast('‚ùå ' + (e.message||e));
      })
      .importShopifyPaste(tok, raw);
  }

  function loadShopifyInbox(){
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;
    const f = document.getElementById('sb_from')?.value || '';
    const t = document.getElementById('sb_to')?.value || '';
    const st = document.getElementById('sb_status')?.value || '';

    google.script.run
      .withSuccessHandler(rows=>{
        renderShopifyInbox(rows||[]);
      })
      .withFailureHandler(e=>toast('‚ùå ' + (e.message||e)))
      .listShopifyInbox(tok, {fromISO:f, toISO:t, status:st});
  }

  function renderShopifyInbox(rows){
    const tb = document.getElementById('shopify_tbody');
    if (!tb) return;
    tb.innerHTML = '';

    (rows||[]).forEach(r=>{
      const tr = document.createElement('tr');
      const status = String(r.status||'PENDIENTE').toUpperCase();
      const badgeStyle =
        status==='PENDIENTE' ? 'background:#ffa72620; color:#ffa726;' :
        status==='CARGADO'   ? 'background:#21c08b20; color:#21c08b;' :
        status==='CANCELADO' ? 'background:#ff5c7c20; color:#ff5c7c;' :
        status==='REPETIDO'  ? 'background:#66666620; color:#aaa;' :
        'background:#252538; color:#d0e1ff;';

      const canActions = (status !== 'CANCELADO');

      tr.innerHTML = `
        <td>${(r.order_ts||'').toString().slice(0,19)}</td>
        <td>${r.customer_name||''}</td>
        <td>${r.phone||''}</td>
        <td>${r.city||''}</td>
        <td>${r.product_title||''}</td>
        <td class="right">${r.qty||1}</td>
        <td class="right">${nf(r.amount_gs||0)}</td>
        <td><span class="badge" style="${badgeStyle}">${status}</span></td>
        <td class="right">
          <div class="row" style="justify-content:flex-end; gap:6px;">
            ${canActions ? `<button class="btn small" onclick="shopifyCargar('${r.id}')">CARGAR</button>` : ''}
            ${canActions ? `<button class="btn small" style="background:#ff5c7c;" onclick="shopifySetStatus('${r.id}','CANCELADO')">CANCELAR</button>` : ''}
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  function shopifySetStatus(rowId, estado){
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;
    google.script.run
      .withSuccessHandler(()=>{ toast('Estado actualizado'); loadShopifyInbox(); })
      .withFailureHandler(e=>toast('‚ùå ' + (e.message||e)))
      .setShopifyInboxStatus(tok, rowId, estado);
  }

  // CARGAR: marca CARGADO + prellena el formulario existente
  function shopifyCargar(rowId){
    const tok = localStorage.getItem(tokenKey);
    if (!tok) return;

    // Paso A: cambiar estado
    google.script.run
      .withSuccessHandler(()=>{
        // Paso B: traer fila y prellenar
        google.script.run
          .withSuccessHandler(row=>{
            prefillOrderFromShopifyRow(row);
          })
          .withFailureHandler(e=>toast('‚ùå ' + (e.message||e)))
          .getShopifyInboxRow(tok, rowId);
      })
      .withFailureHandler(e=>toast('‚ùå ' + (e.message||e)))
      .setShopifyInboxStatus(tok, rowId, 'CARGADO');
  }

  function prefillOrderFromShopifyRow(row){
    if (!row) { toast('Fila inv√°lida'); return; }

    // ir al formulario existente
    show('order');

    // Cliente / datos
    document.getElementById('o_customer').value = row.customer_name || '';
    document.getElementById('o_phone').value = row.phone || '';
    document.getElementById('o_street').value = row.street || '';
    document.getElementById('o_district').value = row.district || '';
    document.getElementById('o_email').value = row.email || '';

    // Observaci√≥n
    const obsBase = `Pedido Shopify + WhatsApp`;
    const extra = row.product_title ? ` | Producto: ${row.product_title}` : '';
    document.getElementById('o_obs').value = (obsBase + extra).trim();

    // Ciudad (intenta match exacto; si no, deja y el vendedor elige)
    const citySel = document.getElementById('o_city');
    if (citySel && row.city){
      citySel.value = row.city;
      if (!citySel.value){
        // match por normalizaci√≥n
        const want = norm(row.city);
        const opt = Array.from(citySel.options||[]).find(o=>norm(o.value||o.textContent||'')===want);
        if (opt) citySel.value = opt.value || opt.textContent;
      }
    }

    // Items: 1 √≠tem
    setTimeout(()=>{
      // limpiar items actuales
      const box = document.getElementById('itemsBox');
      if (box) box.innerHTML = '';
      addItemRow();

      const lastRow = document.getElementById('itemsBox')?.lastElementChild;
      const sel = lastRow?.querySelector('.itemSelect');
      const saleInp = lastRow?.querySelector('.ventaInp');
      const qtyInp = lastRow?.querySelector('.qtyInp');

      // intentar match por t√≠tulo
      let matchedSku = '';
      const pTitle = String(row.product_title||'').trim();
      if (pTitle && (window.products||[]).length){
        const want = norm(pTitle);
        const exact = (products||[]).find(p=>norm(p.title||'')===want);
        const contains = (products||[]).find(p=>want && norm(p.title||'').includes(want));
        const contains2 = (products||[]).find(p=>want && want.includes(norm(p.title||'')));
        const p = exact || contains || contains2;
        if (p) matchedSku = p.sku;
      }

      if (sel){
        if (matchedSku){
          sel.value = matchedSku;
        } else {
          // dejar sin seleccionar y avisar en obs
          document.getElementById('o_obs').value = (document.getElementById('o_obs').value + ` | SIN SKU: ${pTitle}`).trim();
        }
      }

      if (qtyInp) qtyInp.value = Number(row.qty||1);
      if (saleInp && Number(row.amount_gs||0)>0) saleInp.value = Number(row.amount_gs||0);

      recalcOrder();
      toast('Formulario prellenado ‚úì');
    }, 300);
  }


</script>

</div>
</body>
</html>